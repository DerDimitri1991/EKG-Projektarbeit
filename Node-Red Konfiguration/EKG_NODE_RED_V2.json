[
    {
        "id": "406168d7e2283e1c",
        "type": "tab",
        "label": "Flow 1",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "7ccb836c476825f3",
        "type": "subflow",
        "name": "Device 2",
        "info": "",
        "category": "",
        "in": [],
        "out": [],
        "env": [],
        "meta": {},
        "color": "#DDAA99"
    },
    {
        "id": "155c5133bdfefab4",
        "type": "subflow",
        "name": "Device 1",
        "info": "",
        "category": "",
        "in": [],
        "out": [],
        "env": [],
        "meta": {},
        "color": "#DDAA99"
    },
    {
        "id": "b61db2d397ed3f52",
        "type": "subflow",
        "name": "Device 3",
        "info": "",
        "category": "",
        "in": [],
        "out": [],
        "env": [],
        "meta": {},
        "color": "#DDAA99"
    },
    {
        "id": "83fee0b4628f9e33",
        "type": "subflow",
        "name": "Device 4",
        "info": "",
        "category": "",
        "in": [],
        "out": [],
        "env": [],
        "meta": {},
        "color": "#DDAA99"
    },
    {
        "id": "87c8228a65d82b8b",
        "type": "subflow",
        "name": "Device 5",
        "info": "",
        "category": "",
        "in": [],
        "out": [],
        "env": [],
        "meta": {},
        "color": "#DDAA99"
    },
    {
        "id": "6d843e57b45b43cf",
        "type": "subflow",
        "name": "Device 6",
        "info": "",
        "category": "",
        "in": [],
        "out": [],
        "env": [],
        "meta": {},
        "color": "#DDAA99"
    },
    {
        "id": "73d2d98fc364e2ae",
        "type": "subflow",
        "name": "Device 7",
        "info": "",
        "category": "",
        "in": [],
        "out": [],
        "env": [],
        "meta": {},
        "color": "#DDAA99"
    },
    {
        "id": "e69a2f485c6c5f7d",
        "type": "subflow",
        "name": "Device 8",
        "info": "",
        "category": "",
        "in": [],
        "out": [],
        "env": [],
        "meta": {},
        "color": "#DDAA99"
    },
    {
        "id": "8082bc4b568774ed",
        "type": "subflow",
        "name": "Device 9",
        "info": "",
        "category": "",
        "in": [],
        "out": [],
        "env": [],
        "meta": {},
        "color": "#DDAA99"
    },
    {
        "id": "677f06d969d5a671",
        "type": "subflow",
        "name": "Device 10",
        "info": "",
        "category": "",
        "in": [],
        "out": [],
        "env": [],
        "meta": {},
        "color": "#DDAA99"
    },
    {
        "id": "b6da6b5f72cc125a",
        "type": "subflow",
        "name": "Device_00",
        "info": "",
        "category": "",
        "in": [],
        "out": [],
        "env": [],
        "meta": {},
        "color": "#DDAA99"
    },
    {
        "id": "382713f15f103ffc",
        "type": "subflow",
        "name": "Device_10_V2",
        "info": "",
        "category": "",
        "in": [],
        "out": [],
        "env": [],
        "meta": {},
        "color": "#DDAA99"
    },
    {
        "id": "bdb2f7c1745d22d1",
        "type": "subflow",
        "name": "Device_09_V2",
        "info": "",
        "category": "",
        "in": [],
        "out": [],
        "env": [],
        "meta": {},
        "color": "#DDAA99"
    },
    {
        "id": "ca0982db8ee424ff",
        "type": "subflow",
        "name": "Device_08_V2",
        "info": "",
        "category": "",
        "in": [],
        "out": [],
        "env": [],
        "meta": {},
        "color": "#DDAA99"
    },
    {
        "id": "c6db48c0b253912f",
        "type": "subflow",
        "name": "Device_07_V2",
        "info": "",
        "category": "",
        "in": [],
        "out": [],
        "env": [],
        "meta": {},
        "color": "#DDAA99"
    },
    {
        "id": "6a1b1482a6bee560",
        "type": "subflow",
        "name": "Device_06_V2",
        "info": "",
        "category": "",
        "in": [],
        "out": [],
        "env": [],
        "meta": {},
        "color": "#DDAA99"
    },
    {
        "id": "7bd2bc9737c4c53d",
        "type": "subflow",
        "name": "Device_01_V2",
        "info": "",
        "category": "",
        "in": [],
        "out": [],
        "env": [],
        "meta": {},
        "color": "#DDAA99"
    },
    {
        "id": "14ca00f39d79f827",
        "type": "subflow",
        "name": "Device_02_V2",
        "info": "",
        "category": "",
        "in": [],
        "out": [],
        "env": [],
        "meta": {},
        "color": "#DDAA99"
    },
    {
        "id": "2c4d072efbeedd02",
        "type": "subflow",
        "name": "Device_03_V2",
        "info": "",
        "category": "",
        "in": [],
        "out": [],
        "env": [],
        "meta": {},
        "color": "#DDAA99"
    },
    {
        "id": "e126b4dd60b37ea7",
        "type": "subflow",
        "name": "Device_04_V2",
        "info": "",
        "category": "",
        "in": [],
        "out": [],
        "env": [],
        "meta": {},
        "color": "#DDAA99"
    },
    {
        "id": "710f5c82a7764540",
        "type": "subflow",
        "name": "Device_05_V2",
        "info": "",
        "category": "",
        "in": [],
        "out": [],
        "env": [],
        "meta": {},
        "color": "#DDAA99"
    },
    {
        "id": "c872088782b016c8",
        "type": "mqtt-broker",
        "name": "UbiEKG_Server",
        "broker": "mqtt://192.168.178.44:1883",
        "port": 1883,
        "clientid": "",
        "autoConnect": true,
        "usetls": false,
        "protocolVersion": 4,
        "keepalive": 60,
        "cleansession": true,
        "autoUnsubscribe": true,
        "birthTopic": "",
        "birthQos": "0",
        "birthRetain": "false",
        "birthPayload": "",
        "birthMsg": {},
        "closeTopic": "",
        "closeQos": "0",
        "closeRetain": "false",
        "closePayload": "",
        "closeMsg": {},
        "willTopic": "",
        "willQos": "0",
        "willRetain": "false",
        "willPayload": "",
        "willMsg": {},
        "userProps": "",
        "sessionExpiry": ""
    },
    {
        "id": "48948ca4cc63247d",
        "type": "ui_tab",
        "name": "Home",
        "icon": "dashboard",
        "order": 2,
        "disabled": false,
        "hidden": false
    },
    {
        "id": "49960283b5a051dd",
        "type": "ui_base",
        "theme": {
            "name": "theme-light",
            "lightTheme": {
                "default": "#0094CE",
                "baseColor": "#0094CE",
                "baseFont": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif",
                "edited": true,
                "reset": false
            },
            "darkTheme": {
                "default": "#097479",
                "baseColor": "#0080ff",
                "baseFont": "Georgia,Georgia,serif",
                "edited": true,
                "reset": false
            },
            "customTheme": {
                "name": "Untitled Theme 1",
                "default": "#4B7930",
                "baseColor": "#4B7930",
                "baseFont": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif",
                "reset": false
            },
            "themeState": {
                "base-color": {
                    "default": "#0094CE",
                    "value": "#0094CE",
                    "edited": true
                },
                "page-titlebar-backgroundColor": {
                    "value": "#0094CE",
                    "edited": false
                },
                "page-backgroundColor": {
                    "value": "#fafafa",
                    "edited": false
                },
                "page-sidebar-backgroundColor": {
                    "value": "#ffffff",
                    "edited": false
                },
                "group-textColor": {
                    "value": "#1bbfff",
                    "edited": false
                },
                "group-borderColor": {
                    "value": "#ffffff",
                    "edited": false
                },
                "group-backgroundColor": {
                    "value": "#ffffff",
                    "edited": false
                },
                "widget-textColor": {
                    "value": "#111111",
                    "edited": false
                },
                "widget-backgroundColor": {
                    "value": "#0094ce",
                    "edited": false
                },
                "widget-borderColor": {
                    "value": "#ffffff",
                    "edited": false
                },
                "base-font": {
                    "value": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"
                }
            },
            "angularTheme": {
                "primary": "indigo",
                "accents": "blue",
                "warn": "red",
                "background": "grey",
                "palette": "light"
            }
        },
        "site": {
            "name": "Node-RED Dashboard",
            "hideToolbar": "false",
            "allowSwipe": "false",
            "lockMenu": "false",
            "allowTempTheme": "true",
            "dateFormat": "DD.MM.YYYY",
            "sizes": {
                "sx": 48,
                "sy": 48,
                "gx": 6,
                "gy": 6,
                "cx": 6,
                "cy": 6,
                "px": 0,
                "py": 0
            }
        }
    },
    {
        "id": "6a8dd33d9e7fde80",
        "type": "mqtt-broker",
        "name": "UbiEKG",
        "broker": "192.168.178.104",
        "port": 1883,
        "clientid": "",
        "autoConnect": true,
        "usetls": false,
        "protocolVersion": 4,
        "keepalive": 60,
        "cleansession": true,
        "autoUnsubscribe": true,
        "birthTopic": "",
        "birthQos": "0",
        "birthRetain": "false",
        "birthPayload": "",
        "birthMsg": {},
        "closeTopic": "",
        "closeQos": "0",
        "closeRetain": "false",
        "closePayload": "",
        "closeMsg": {},
        "willTopic": "",
        "willQos": "0",
        "willRetain": "false",
        "willPayload": "",
        "willMsg": {},
        "userProps": "",
        "sessionExpiry": ""
    },
    {
        "id": "0876e735db5b5ed5",
        "type": "ui_group",
        "z": "b61db2d397ed3f52",
        "name": "Device_03",
        "tab": "48948ca4cc63247d",
        "order": 3,
        "disp": true,
        "width": "8",
        "collapse": false,
        "className": ""
    },
    {
        "id": "668d8e78f47630d3",
        "type": "ui_group",
        "z": "83fee0b4628f9e33",
        "name": "Device_04",
        "tab": "48948ca4cc63247d",
        "order": 4,
        "disp": true,
        "width": "8",
        "collapse": false,
        "className": ""
    },
    {
        "id": "15f3328f74ed9705",
        "type": "ui_group",
        "z": "87c8228a65d82b8b",
        "name": "Device_05",
        "tab": "48948ca4cc63247d",
        "order": 5,
        "disp": true,
        "width": "8",
        "collapse": false,
        "className": ""
    },
    {
        "id": "067c42357b3bc972",
        "type": "ui_group",
        "z": "6d843e57b45b43cf",
        "name": "Device_06",
        "tab": "48948ca4cc63247d",
        "order": 6,
        "disp": true,
        "width": "8",
        "collapse": false,
        "className": ""
    },
    {
        "id": "574b012cc77fb53d",
        "type": "ui_group",
        "z": "73d2d98fc364e2ae",
        "name": "Device_07",
        "tab": "48948ca4cc63247d",
        "order": 7,
        "disp": true,
        "width": "8",
        "collapse": false,
        "className": ""
    },
    {
        "id": "6bd34fd905a51ff8",
        "type": "ui_group",
        "z": "e69a2f485c6c5f7d",
        "name": "Device_08",
        "tab": "48948ca4cc63247d",
        "order": 8,
        "disp": true,
        "width": "8",
        "collapse": false,
        "className": ""
    },
    {
        "id": "4b6faf155b2cc2e1",
        "type": "ui_group",
        "z": "8082bc4b568774ed",
        "name": "Device_09",
        "tab": "48948ca4cc63247d",
        "order": 9,
        "disp": true,
        "width": "8",
        "collapse": false,
        "className": ""
    },
    {
        "id": "d13e25f8bd900779",
        "type": "ui_group",
        "z": "677f06d969d5a671",
        "name": "Device_10",
        "tab": "48948ca4cc63247d",
        "order": 10,
        "disp": true,
        "width": "8",
        "collapse": false,
        "className": ""
    },
    {
        "id": "7637a5740c4750b6",
        "type": "ui_group",
        "name": "Device_10_V2",
        "tab": "48948ca4cc63247d",
        "order": 20,
        "disp": true,
        "width": "8",
        "collapse": true,
        "className": ""
    },
    {
        "id": "52ffc8ee49b8689f",
        "type": "ui_group",
        "z": "155c5133bdfefab4",
        "name": "Device_01",
        "tab": "48948ca4cc63247d",
        "order": 1,
        "disp": true,
        "width": "8",
        "collapse": true,
        "className": ""
    },
    {
        "id": "501261fb151a6828",
        "type": "ui_group",
        "z": "7ccb836c476825f3",
        "name": "Device_02",
        "tab": "48948ca4cc63247d",
        "order": 2,
        "disp": true,
        "width": "8",
        "collapse": false,
        "className": ""
    },
    {
        "id": "5e1b837211be31f1",
        "type": "ui_group",
        "z": "b6da6b5f72cc125a",
        "name": "Device_00",
        "tab": "48948ca4cc63247d",
        "order": 21,
        "disp": true,
        "width": "8",
        "collapse": false,
        "className": ""
    },
    {
        "id": "687bdc205a57f688",
        "type": "ui_group",
        "z": "bdb2f7c1745d22d1",
        "name": "Device_09_V2",
        "tab": "48948ca4cc63247d",
        "order": 19,
        "disp": true,
        "width": "8",
        "collapse": false,
        "className": ""
    },
    {
        "id": "4d384bceafa49ebb",
        "type": "ui_group",
        "z": "ca0982db8ee424ff",
        "name": "Device_08_V2",
        "tab": "48948ca4cc63247d",
        "order": 18,
        "disp": true,
        "width": "8",
        "collapse": false,
        "className": ""
    },
    {
        "id": "2f508b19b8f431c8",
        "type": "ui_group",
        "z": "c6db48c0b253912f",
        "name": "Device_07_V2",
        "tab": "48948ca4cc63247d",
        "order": 17,
        "disp": true,
        "width": "8",
        "collapse": false,
        "className": ""
    },
    {
        "id": "2d1c0cb4dc73a047",
        "type": "ui_group",
        "z": "6a1b1482a6bee560",
        "name": "Device_06_V2",
        "tab": "48948ca4cc63247d",
        "order": 16,
        "disp": true,
        "width": "8",
        "collapse": false,
        "className": ""
    },
    {
        "id": "72fd7e32a8c27a97",
        "type": "ui_group",
        "z": "710f5c82a7764540",
        "name": "Device_05_V2",
        "tab": "48948ca4cc63247d",
        "order": 15,
        "disp": true,
        "width": "8",
        "collapse": false,
        "className": ""
    },
    {
        "id": "cd3dcd554c0939a7",
        "type": "ui_group",
        "z": "e126b4dd60b37ea7",
        "name": "Device_04_V2",
        "tab": "48948ca4cc63247d",
        "order": 14,
        "disp": true,
        "width": "8",
        "collapse": false,
        "className": ""
    },
    {
        "id": "29ef880878824cd1",
        "type": "ui_group",
        "z": "2c4d072efbeedd02",
        "name": "Device_03_V2",
        "tab": "48948ca4cc63247d",
        "order": 13,
        "disp": true,
        "width": "8",
        "collapse": false,
        "className": ""
    },
    {
        "id": "67b6629d9e2271d3",
        "type": "ui_group",
        "z": "14ca00f39d79f827",
        "name": "Device_02_V2",
        "tab": "48948ca4cc63247d",
        "order": 12,
        "disp": true,
        "width": "8",
        "collapse": false,
        "className": ""
    },
    {
        "id": "0e178414fb6a25a3",
        "type": "ui_group",
        "z": "7bd2bc9737c4c53d",
        "name": "Device_01_V2",
        "tab": "48948ca4cc63247d",
        "order": 11,
        "disp": true,
        "width": "8",
        "collapse": false,
        "className": ""
    },
    {
        "id": "ef5292f4433f565d",
        "type": "mqtt in",
        "z": "7ccb836c476825f3",
        "name": "",
        "topic": "ecg/device2",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 150,
        "y": 120,
        "wires": [
            [
                "22fe8a2291cadcd2",
                "6d71628555c44cb4",
                "8bf6bac7f9fb3152",
                "8042959456216844",
                "30c224b425ecf45f"
            ]
        ]
    },
    {
        "id": "22fe8a2291cadcd2",
        "type": "function",
        "z": "7ccb836c476825f3",
        "name": "device name",
        "func": "msg.payload = msg.payload.device;  // Extract the \"device\" value\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 390,
        "y": 180,
        "wires": [
            []
        ]
    },
    {
        "id": "6d71628555c44cb4",
        "type": "function",
        "z": "7ccb836c476825f3",
        "name": "battery",
        "func": "if (msg.payload && msg.payload.battery !== undefined) {\n    msg.payload = msg.payload.battery;\n    return msg;\n} else {\n    return null;\n}\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 370,
        "y": 220,
        "wires": [
            [
                "08d6652535133327"
            ]
        ]
    },
    {
        "id": "3e930b1081890d3d",
        "type": "mqtt in",
        "z": "7ccb836c476825f3",
        "name": "",
        "topic": "processed/device2",
        "qos": "2",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 180,
        "y": 520,
        "wires": [
            [
                "e77f0cb09b7d3362"
            ]
        ]
    },
    {
        "id": "909cc7d9066cb50b",
        "type": "ui_text",
        "z": "7ccb836c476825f3",
        "group": "501261fb151a6828",
        "order": 2,
        "width": 4,
        "height": 3,
        "name": "",
        "label": "BPM",
        "format": "{{msg.payload}}",
        "layout": "col-center",
        "className": "",
        "style": true,
        "font": "Georgia,Georgia,serif",
        "fontSize": "25",
        "color": "#1cb5ff",
        "x": 610,
        "y": 460,
        "wires": []
    },
    {
        "id": "e77f0cb09b7d3362",
        "type": "function",
        "z": "7ccb836c476825f3",
        "name": "function 15",
        "func": "let data = msg.payload;\n\nif (typeof data === \"string\") {\n    try {\n        data = JSON.parse(data);\n    } catch (e) {\n        node.warn(\"Invalid JSON\");\n        return null;\n    }\n}\n\nmsg.bpm = { payload: data.bpm_mean };\nmsg.hrv = { payload: data.hrv_rmssd };\nmsg.zone = { payload: data.zone };\nmsg.quality = { payload: data.ecg_quality };\nmsg.rsp = { payload: data.ecg_rsp_mean };\n\nreturn [msg.bpm, msg.hrv, msg.zone, msg.quality, msg.rsp];\n",
        "outputs": 5,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 390,
        "y": 520,
        "wires": [
            [
                "7d18f6254c3db317",
                "909cc7d9066cb50b"
            ],
            [
                "600ec5de50732b5f"
            ],
            [
                "7392725cacc5189d"
            ],
            [
                "e5770fdf92ecf0c1"
            ],
            [
                "9a6a8fa15d589fd3"
            ]
        ]
    },
    {
        "id": "7d18f6254c3db317",
        "type": "ui_chart",
        "z": "7ccb836c476825f3",
        "name": "",
        "group": "501261fb151a6828",
        "order": 5,
        "width": 8,
        "height": 3,
        "label": "Heart Rate BPM",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 640,
        "y": 420,
        "wires": [
            []
        ]
    },
    {
        "id": "600ec5de50732b5f",
        "type": "ui_chart",
        "z": "7ccb836c476825f3",
        "name": "",
        "group": "501261fb151a6828",
        "order": 6,
        "width": 8,
        "height": 3,
        "label": "HRV (RMSSD)",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 640,
        "y": 500,
        "wires": [
            []
        ]
    },
    {
        "id": "7392725cacc5189d",
        "type": "ui_template",
        "z": "7ccb836c476825f3",
        "group": "501261fb151a6828",
        "name": "tr zone",
        "order": 7,
        "width": 4,
        "height": 1,
        "format": "<div style=\"font-size: 20px; font-weight: bold;\">\n    Zone: {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 610,
        "y": 540,
        "wires": [
            []
        ]
    },
    {
        "id": "e5770fdf92ecf0c1",
        "type": "ui_gauge",
        "z": "7ccb836c476825f3",
        "name": "",
        "group": "501261fb151a6828",
        "order": 3,
        "width": 2,
        "height": 3,
        "gtype": "compass",
        "title": "ECG Quality",
        "label": "units",
        "format": "{{value}}",
        "min": 0,
        "max": "1",
        "colors": [
            "#00b500",
            "#e6e600",
            "#ca3838"
        ],
        "seg1": "0.5",
        "seg2": "0.9",
        "diff": false,
        "className": "",
        "x": 630,
        "y": 580,
        "wires": []
    },
    {
        "id": "8bf6bac7f9fb3152",
        "type": "function",
        "z": "7ccb836c476825f3",
        "name": "function 16",
        "func": "const deviceId = \"ECG-2\"; // Fixed device ID for this function node\nconst timeoutDuration = 20000; // 10 seconds\nconst timeoutKey = \"offline_timeout_\" + deviceId;\n\n// Cancel any existing timeout\nconst prevTimeout = flow.get(timeoutKey);\nif (prevTimeout) {\n    clearTimeout(prevTimeout);\n}\n\n// Set a new timeout to trigger Offline if no message is received\nconst timeout = setTimeout(() => {\n    const offlineMsg = {\n        payload: \"Offline\",\n        color: \"gray\",\n        device: deviceId\n    };\n    node.send(offlineMsg);\n}, timeoutDuration);\nflow.set(timeoutKey, timeout);\n\n// Process the current message\nif (msg.payload.pads_connected === true) {\n    msg.payload = \"Connected\";\n    msg.color = \"#4f97dc\";\n} else if (msg.payload.pads_connected === false) {\n    msg.payload = \"Disconnected\";\n    msg.color = \"red\";\n} else {\n    msg.payload = \"Offline\"; // Only used at startup\n    msg.color = \"gray\";\n}\nmsg.device = deviceId;\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 390,
        "y": 60,
        "wires": [
            [
                "4238e53d5a24e982"
            ]
        ]
    },
    {
        "id": "4238e53d5a24e982",
        "type": "ui_template",
        "z": "7ccb836c476825f3",
        "group": "501261fb151a6828",
        "name": "",
        "order": 1,
        "width": 8,
        "height": 1,
        "format": "<div ng-style=\"{\n    'font-size': '20px',\n    'font-weight': 'bold',\n    'text-align': 'center',\n    'color': msg.color\n}\">\n    {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 620,
        "y": 60,
        "wires": [
            []
        ]
    },
    {
        "id": "9a6a8fa15d589fd3",
        "type": "function",
        "z": "7ccb836c476825f3",
        "name": "function 17",
        "func": "let rsp = parseFloat(msg.payload); // VERY IMPORTANT: force it to number\n\nlet breathingStatus = \"Unknown\";\nlet color = \"grey\";\n\nif (rsp > -3 && rsp < 3) {\n    breathingStatus = \"Normal Breathing\";\n    color = \"#4f97dc\";\n} else {\n    breathingStatus = \"Irregular Breathing\";\n    color = \"red\";\n}\n\nmsg.payload = breathingStatus;\nmsg.color = color;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 630,
        "y": 620,
        "wires": [
            [
                "c7e735f433aaa284"
            ]
        ]
    },
    {
        "id": "c7e735f433aaa284",
        "type": "ui_template",
        "z": "7ccb836c476825f3",
        "group": "501261fb151a6828",
        "name": "",
        "order": 8,
        "width": 4,
        "height": 1,
        "format": "<div ng-style=\"{\n    'font-size': '20px',\n    'font-weight': 'bold',\n    'text-align': 'center',\n    'color': msg.color\n}\">\n    {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 840,
        "y": 620,
        "wires": [
            []
        ]
    },
    {
        "id": "08d6652535133327",
        "type": "ui_gauge",
        "z": "7ccb836c476825f3",
        "name": "",
        "group": "501261fb151a6828",
        "order": 4,
        "width": 2,
        "height": 3,
        "gtype": "compass",
        "title": "Batterie (%)",
        "label": "%",
        "format": "{{msg.payload}}",
        "min": "0",
        "max": "100",
        "colors": [
            "#b50000",
            "#e6e600",
            "#00ff00"
        ],
        "seg1": "",
        "seg2": "",
        "diff": false,
        "className": "",
        "x": 630,
        "y": 220,
        "wires": []
    },
    {
        "id": "8042959456216844",
        "type": "function",
        "z": "7ccb836c476825f3",
        "name": "function 4",
        "func": "let ecg = msg.payload.ecg;\nlet ts = msg.payload.ts;\nlet startUtc = msg.payload.start_utc;\n\nif (!ecg || !ts) return null;\n\n// Wenn start_utc enthalten ist (seq == 0), speichern\nif (startUtc !== undefined) {\n    global.set(\"ecg_start_utc\", startUtc);\n} else {\n    startUtc = global.get(\"ecg_start_utc\");\n    if (startUtc === undefined) return null; // noch keine gültige Zeitbasis\n}\n\n// CSV-Zeilen generieren\nlet lines = [];\nfor (let i = 0; i < ecg.length; i++) {\n    let utcSample = startUtc + ts[i] / 1_000_000;\n    lines.push(utcSample.toFixed(6) + \",\" + ecg[i].toFixed(3));\n}\n\nmsg.payload = lines.join(\"\\n\") + \"\\n\";\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 20,
        "wires": [
            [
                "eab68f7acf870396"
            ]
        ]
    },
    {
        "id": "eab68f7acf870396",
        "type": "file",
        "z": "7ccb836c476825f3",
        "name": "",
        "filename": "C:\\Users\\Dima\\Desktop\\ecg_recording_device2.csv",
        "filenameType": "str",
        "appendNewline": false,
        "createDir": false,
        "overwriteFile": "false",
        "encoding": "utf8",
        "x": 750,
        "y": 20,
        "wires": [
            []
        ]
    },
    {
        "id": "d24501da32a1a851",
        "type": "inject",
        "z": "7ccb836c476825f3",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "{   \"device\": \"ECG-2\",   \"msg_id\": 0,   \"pads_connected\": null,   \"seq\": 0,   \"ecg\": [],   \"ts\": [] }",
        "payloadType": "json",
        "x": 370,
        "y": 140,
        "wires": [
            [
                "8bf6bac7f9fb3152"
            ]
        ]
    },
    {
        "id": "30c224b425ecf45f",
        "type": "debug",
        "z": "7ccb836c476825f3",
        "name": "debug 1",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 600,
        "y": 120,
        "wires": []
    },
    {
        "id": "32c80c4420d7a583",
        "type": "mqtt in",
        "z": "155c5133bdfefab4",
        "name": "",
        "topic": "ecg/device1",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 170,
        "y": 140,
        "wires": [
            [
                "34026706231d9421",
                "c26185767e4527b8",
                "62ecf18775afa40c",
                "cdf339fbcc5d9edd"
            ]
        ]
    },
    {
        "id": "435e89a2a1eee79c",
        "type": "ui_gauge",
        "z": "155c5133bdfefab4",
        "name": "",
        "group": "52ffc8ee49b8689f",
        "order": 4,
        "width": 2,
        "height": 3,
        "gtype": "compass",
        "title": "Batterie (%)",
        "label": "%",
        "format": "{{msg.payload}}",
        "min": "0",
        "max": "100",
        "colors": [
            "#b50000",
            "#e6e600",
            "#00ff00"
        ],
        "seg1": "",
        "seg2": "",
        "diff": false,
        "className": "",
        "x": 650,
        "y": 240,
        "wires": []
    },
    {
        "id": "34026706231d9421",
        "type": "function",
        "z": "155c5133bdfefab4",
        "name": "device name",
        "func": "msg.payload = msg.payload.device;  // Extract the \"device\" value\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 450,
        "y": 200,
        "wires": [
            []
        ]
    },
    {
        "id": "c26185767e4527b8",
        "type": "function",
        "z": "155c5133bdfefab4",
        "name": "battery",
        "func": "if (msg.payload && msg.payload.battery !== undefined) {\n    msg.payload = msg.payload.battery;\n    return msg;\n} else {\n    return null;\n}\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 430,
        "y": 240,
        "wires": [
            [
                "435e89a2a1eee79c"
            ]
        ]
    },
    {
        "id": "a09e0366ef1e6d4b",
        "type": "mqtt in",
        "z": "155c5133bdfefab4",
        "name": "",
        "topic": "processed/device1",
        "qos": "2",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 170,
        "y": 500,
        "wires": [
            [
                "4785a115f1bfe48e"
            ]
        ]
    },
    {
        "id": "e1ccd30e380f7139",
        "type": "ui_text",
        "z": "155c5133bdfefab4",
        "group": "52ffc8ee49b8689f",
        "order": 2,
        "width": 4,
        "height": 3,
        "name": "",
        "label": "BPM",
        "format": "{{msg.payload}}",
        "layout": "col-center",
        "className": "",
        "style": true,
        "font": "",
        "fontSize": "25",
        "color": "#09afff",
        "x": 610,
        "y": 440,
        "wires": []
    },
    {
        "id": "4785a115f1bfe48e",
        "type": "function",
        "z": "155c5133bdfefab4",
        "name": "function 24",
        "func": "let data = msg.payload;\n\nif (typeof data === \"string\") {\n    try {\n        data = JSON.parse(data);\n    } catch (e) {\n        node.warn(\"Invalid JSON\");\n        return null;\n    }\n}\n\nmsg.bpm = { payload: data.bpm_mean };\nmsg.hrv = { payload: data.hrv_rmssd };\nmsg.zone = { payload: data.zone };\nmsg.quality = { payload: data.ecg_quality };\nmsg.rsp = { payload: data.ecg_rsp_mean };\n\nreturn [msg.bpm, msg.hrv, msg.zone, msg.quality, msg.rsp];\n",
        "outputs": 5,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 500,
        "wires": [
            [
                "af082695a058a33e",
                "e1ccd30e380f7139"
            ],
            [
                "6e5235c8e286a8b3"
            ],
            [
                "11fd0b8eb50448cb"
            ],
            [
                "1d29a5471bf0d94c"
            ],
            [
                "4f28c22cd66719ea"
            ]
        ]
    },
    {
        "id": "af082695a058a33e",
        "type": "ui_chart",
        "z": "155c5133bdfefab4",
        "name": "",
        "group": "52ffc8ee49b8689f",
        "order": 5,
        "width": 8,
        "height": 3,
        "label": "Heart Rate BPM",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 640,
        "y": 400,
        "wires": [
            []
        ]
    },
    {
        "id": "6e5235c8e286a8b3",
        "type": "ui_chart",
        "z": "155c5133bdfefab4",
        "name": "",
        "group": "52ffc8ee49b8689f",
        "order": 6,
        "width": 8,
        "height": 3,
        "label": "HRV (RMSSD)",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 640,
        "y": 480,
        "wires": [
            []
        ]
    },
    {
        "id": "11fd0b8eb50448cb",
        "type": "ui_template",
        "z": "155c5133bdfefab4",
        "group": "52ffc8ee49b8689f",
        "name": "tr zone",
        "order": 7,
        "width": 4,
        "height": 1,
        "format": "<div style=\"font-size: 20px; font-weight: bold;\">\n    Zone: {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 610,
        "y": 520,
        "wires": [
            []
        ]
    },
    {
        "id": "1d29a5471bf0d94c",
        "type": "ui_gauge",
        "z": "155c5133bdfefab4",
        "name": "",
        "group": "52ffc8ee49b8689f",
        "order": 3,
        "width": 2,
        "height": 3,
        "gtype": "compass",
        "title": "ECG Quality",
        "label": "units",
        "format": "{{value}}",
        "min": 0,
        "max": "1",
        "colors": [
            "#00b500",
            "#e6e600",
            "#ca3838"
        ],
        "seg1": "0.5",
        "seg2": "0.9",
        "diff": false,
        "className": "",
        "x": 630,
        "y": 560,
        "wires": []
    },
    {
        "id": "4f28c22cd66719ea",
        "type": "function",
        "z": "155c5133bdfefab4",
        "name": "function 26",
        "func": "let rsp = parseFloat(msg.payload);\n\nlet breathingStatus = \"Unknown\";\nlet color = \"grey\";\n\nif (rsp > -3 && rsp < 3) {\n    breathingStatus = \"Normal Breathing\";\n    color = \"#4f97dc\";\n} else {\n    breathingStatus = \"Irregular Breathing\";\n    color = \"red\";\n}\n\nmsg.payload = breathingStatus;\nmsg.color = color;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 620,
        "y": 600,
        "wires": [
            [
                "5ca982951e6ba063"
            ]
        ]
    },
    {
        "id": "5ca982951e6ba063",
        "type": "ui_template",
        "z": "155c5133bdfefab4",
        "group": "52ffc8ee49b8689f",
        "name": "",
        "order": 8,
        "width": 4,
        "height": 1,
        "format": "<div style=\"color: {{msg.color}}; font-size: 20px; font-weight: bold;\">\n    {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 860,
        "y": 600,
        "wires": [
            []
        ]
    },
    {
        "id": "11a9f31ca17c7eb5",
        "type": "ui_template",
        "z": "155c5133bdfefab4",
        "group": "52ffc8ee49b8689f",
        "name": "",
        "order": 1,
        "width": 8,
        "height": 1,
        "format": "<div ng-style=\"{\n    'font-size': '20px',\n    'font-weight': 'bold',\n    'text-align': 'center',\n    'color': msg.color\n}\">\n    {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 640,
        "y": 80,
        "wires": [
            []
        ]
    },
    {
        "id": "62ecf18775afa40c",
        "type": "function",
        "z": "155c5133bdfefab4",
        "name": "function 25",
        "func": "const deviceId = \"ECG-1\"; // Fixed device ID for this function node\nconst timeoutDuration = 20000; // 10 seconds\nconst timeoutKey = \"offline_timeout_\" + deviceId;\n\n// Cancel any existing timeout\nconst prevTimeout = flow.get(timeoutKey);\nif (prevTimeout) {\n    clearTimeout(prevTimeout);\n}\n\n// Set a new timeout to trigger Offline if no message is received\nconst timeout = setTimeout(() => {\n    const offlineMsg = {\n        payload: \"Offline\",\n        color: \"gray\",\n        device: deviceId\n    };\n    node.send(offlineMsg);\n}, timeoutDuration);\nflow.set(timeoutKey, timeout);\n\n// Process the current message\nif (msg.payload.pads_connected === true) {\n    msg.payload = \"Connected\";\n    msg.color = \"#4f97dc\";\n} else if (msg.payload.pads_connected === false) {\n    msg.payload = \"Disconnected\";\n    msg.color = \"red\";\n} else {\n    msg.payload = \"Offline\"; // Only used at startup\n    msg.color = \"gray\";\n}\nmsg.device = deviceId;\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 450,
        "y": 80,
        "wires": [
            [
                "11a9f31ca17c7eb5"
            ]
        ]
    },
    {
        "id": "cdf339fbcc5d9edd",
        "type": "function",
        "z": "155c5133bdfefab4",
        "name": "function 3",
        "func": "let ecg = msg.payload.ecg;\nlet ts = msg.payload.ts;\nlet startUtc = msg.payload.start_utc;\n\nif (!ecg || !ts) return null;\n\n// Wenn start_utc enthalten ist (seq == 0), speichern\nif (startUtc !== undefined) {\n    global.set(\"ecg_start_utc\", startUtc);\n} else {\n    startUtc = global.get(\"ecg_start_utc\");\n    if (startUtc === undefined) return null; // noch keine gültige Zeitbasis\n}\n\n// CSV-Zeilen generieren\nlet lines = [];\nfor (let i = 0; i < ecg.length; i++) {\n    let utcSample = startUtc + ts[i] / 1_000_000;\n    lines.push(utcSample.toFixed(6) + \",\" + ecg[i].toFixed(3));\n}\n\nmsg.payload = lines.join(\"\\n\") + \"\\n\";\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 440,
        "y": 20,
        "wires": [
            [
                "9dca23ae55635c5a"
            ]
        ]
    },
    {
        "id": "9dca23ae55635c5a",
        "type": "file",
        "z": "155c5133bdfefab4",
        "name": "",
        "filename": "C:\\Users\\Dima\\Desktop\\ecg_recording_device1.csv",
        "filenameType": "str",
        "appendNewline": false,
        "createDir": false,
        "overwriteFile": "false",
        "encoding": "utf8",
        "x": 770,
        "y": 20,
        "wires": [
            []
        ]
    },
    {
        "id": "e1ff44d70aa29c33",
        "type": "inject",
        "z": "155c5133bdfefab4",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "{   \"device\": \"ECG-1\",   \"msg_id\": 0,   \"pads_connected\": false,   \"seq\": 0,   \"ecg\": [],   \"ts\": [] }",
        "payloadType": "json",
        "x": 430,
        "y": 160,
        "wires": [
            [
                "62ecf18775afa40c"
            ]
        ]
    },
    {
        "id": "94a6680b2e8911bf",
        "type": "mqtt in",
        "z": "b61db2d397ed3f52",
        "name": "",
        "topic": "ecg/device3",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 150,
        "y": 140,
        "wires": [
            [
                "32c78a9dca72d3b0",
                "ce4d9e4bedcfce53",
                "5fd4b3cc1d3ebed9",
                "481ac578d4a75eeb"
            ]
        ]
    },
    {
        "id": "32c78a9dca72d3b0",
        "type": "function",
        "z": "b61db2d397ed3f52",
        "name": "device name",
        "func": "msg.payload = msg.payload.device;  // Extract the \"device\" value\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 390,
        "y": 200,
        "wires": [
            []
        ]
    },
    {
        "id": "ce4d9e4bedcfce53",
        "type": "function",
        "z": "b61db2d397ed3f52",
        "name": "battery",
        "func": "if (msg.payload && msg.payload.battery !== undefined) {\n    msg.payload = msg.payload.battery;\n    return msg;\n} else {\n    return null;\n}\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 370,
        "y": 240,
        "wires": [
            [
                "e1f270ab76479276"
            ]
        ]
    },
    {
        "id": "b14bf4cf356802fd",
        "type": "mqtt in",
        "z": "b61db2d397ed3f52",
        "name": "",
        "topic": "processed/device3",
        "qos": "2",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 180,
        "y": 540,
        "wires": [
            [
                "b6728f52ac6b2e1d"
            ]
        ]
    },
    {
        "id": "2fbfe0551065b9dc",
        "type": "ui_text",
        "z": "b61db2d397ed3f52",
        "group": "0876e735db5b5ed5",
        "order": 2,
        "width": 4,
        "height": 3,
        "name": "",
        "label": "BPM",
        "format": "{{msg.payload}}",
        "layout": "col-center",
        "className": "",
        "style": true,
        "font": "Georgia,Georgia,serif",
        "fontSize": "25",
        "color": "#1cb5ff",
        "x": 610,
        "y": 480,
        "wires": []
    },
    {
        "id": "b6728f52ac6b2e1d",
        "type": "function",
        "z": "b61db2d397ed3f52",
        "name": "function 9",
        "func": "let data = msg.payload;\n\nif (typeof data === \"string\") {\n    try {\n        data = JSON.parse(data);\n    } catch (e) {\n        node.warn(\"Invalid JSON\");\n        return null;\n    }\n}\n\nmsg.bpm = { payload: data.bpm_mean };\nmsg.hrv = { payload: data.hrv_rmssd };\nmsg.zone = { payload: data.zone };\nmsg.quality = { payload: data.ecg_quality };\nmsg.rsp = { payload: data.ecg_rsp_mean };\n\nreturn [msg.bpm, msg.hrv, msg.zone, msg.quality, msg.rsp];\n",
        "outputs": 5,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 390,
        "y": 540,
        "wires": [
            [
                "8dd4e134500dd944",
                "2fbfe0551065b9dc"
            ],
            [
                "3709e6af5756671e"
            ],
            [
                "faeac85b0f7d5fb4"
            ],
            [
                "53c743329be07fce"
            ],
            [
                "6767c299df6ca94e"
            ]
        ]
    },
    {
        "id": "8dd4e134500dd944",
        "type": "ui_chart",
        "z": "b61db2d397ed3f52",
        "name": "",
        "group": "0876e735db5b5ed5",
        "order": 5,
        "width": 8,
        "height": 3,
        "label": "Heart Rate BPM",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 640,
        "y": 440,
        "wires": [
            []
        ]
    },
    {
        "id": "3709e6af5756671e",
        "type": "ui_chart",
        "z": "b61db2d397ed3f52",
        "name": "",
        "group": "0876e735db5b5ed5",
        "order": 6,
        "width": 8,
        "height": 3,
        "label": "HRV (RMSSD)",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 640,
        "y": 520,
        "wires": [
            []
        ]
    },
    {
        "id": "faeac85b0f7d5fb4",
        "type": "ui_template",
        "z": "b61db2d397ed3f52",
        "group": "0876e735db5b5ed5",
        "name": "tr zone",
        "order": 7,
        "width": 4,
        "height": 1,
        "format": "<div style=\"font-size: 20px; font-weight: bold;\">\n    Zone: {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 610,
        "y": 560,
        "wires": [
            []
        ]
    },
    {
        "id": "53c743329be07fce",
        "type": "ui_gauge",
        "z": "b61db2d397ed3f52",
        "name": "",
        "group": "0876e735db5b5ed5",
        "order": 3,
        "width": 2,
        "height": 3,
        "gtype": "compass",
        "title": "ECG Quality",
        "label": "units",
        "format": "{{value}}",
        "min": 0,
        "max": "1",
        "colors": [
            "#00b500",
            "#e6e600",
            "#ca3838"
        ],
        "seg1": "0.5",
        "seg2": "0.9",
        "diff": false,
        "className": "",
        "x": 630,
        "y": 600,
        "wires": []
    },
    {
        "id": "5fd4b3cc1d3ebed9",
        "type": "function",
        "z": "b61db2d397ed3f52",
        "name": "function 10",
        "func": "const deviceId = \"ECG-3\"; // Fixed device ID for this function node\nconst timeoutDuration = 20000; // 10 seconds\nconst timeoutKey = \"offline_timeout_\" + deviceId;\n\n// Cancel any existing timeout\nconst prevTimeout = flow.get(timeoutKey);\nif (prevTimeout) {\n    clearTimeout(prevTimeout);\n}\n\n// Set a new timeout to trigger Offline if no message is received\nconst timeout = setTimeout(() => {\n    const offlineMsg = {\n        payload: \"Offline\",\n        color: \"gray\",\n        device: deviceId\n    };\n    node.send(offlineMsg);\n}, timeoutDuration);\nflow.set(timeoutKey, timeout);\n\n// Process the current message\nif (msg.payload.pads_connected === true) {\n    msg.payload = \"Connected\";\n    msg.color = \"#4f97dc\";\n} else if (msg.payload.pads_connected === false) {\n    msg.payload = \"Disconnected\";\n    msg.color = \"red\";\n} else {\n    msg.payload = \"Offline\"; // Only used at startup\n    msg.color = \"gray\";\n}\nmsg.device = deviceId;\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 390,
        "y": 80,
        "wires": [
            [
                "04bba08a5967b932"
            ]
        ]
    },
    {
        "id": "04bba08a5967b932",
        "type": "ui_template",
        "z": "b61db2d397ed3f52",
        "group": "0876e735db5b5ed5",
        "name": "",
        "order": 1,
        "width": 8,
        "height": 1,
        "format": "<div ng-style=\"{\n    'font-size': '20px',\n    'font-weight': 'bold',\n    'text-align': 'center',\n    'color': msg.color\n}\">\n    {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 620,
        "y": 80,
        "wires": [
            []
        ]
    },
    {
        "id": "6767c299df6ca94e",
        "type": "function",
        "z": "b61db2d397ed3f52",
        "name": "function 11",
        "func": "let rsp = parseFloat(msg.payload); // VERY IMPORTANT: force it to number\n\nlet breathingStatus = \"Unknown\";\nlet color = \"grey\";\n\nif (rsp > -3 && rsp < 3) {\n    breathingStatus = \"Normal Breathing\";\n    color = \"#4f97dc\";\n} else {\n    breathingStatus = \"Irregular Breathing\";\n    color = \"red\";\n}\n\nmsg.payload = breathingStatus;\nmsg.color = color;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 630,
        "y": 640,
        "wires": [
            [
                "f816a4989a33764d"
            ]
        ]
    },
    {
        "id": "f816a4989a33764d",
        "type": "ui_template",
        "z": "b61db2d397ed3f52",
        "group": "0876e735db5b5ed5",
        "name": "",
        "order": 8,
        "width": 4,
        "height": 1,
        "format": "<div ng-style=\"{\n    'font-size': '20px',\n    'font-weight': 'bold',\n    'text-align': 'center',\n    'color': msg.color\n}\">\n    {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 840,
        "y": 640,
        "wires": [
            []
        ]
    },
    {
        "id": "e1f270ab76479276",
        "type": "ui_gauge",
        "z": "b61db2d397ed3f52",
        "name": "",
        "group": "0876e735db5b5ed5",
        "order": 4,
        "width": 2,
        "height": 3,
        "gtype": "compass",
        "title": "Batterie (%)",
        "label": "%",
        "format": "{{msg.payload}}",
        "min": "0",
        "max": "100",
        "colors": [
            "#b50000",
            "#e6e600",
            "#00ff00"
        ],
        "seg1": "",
        "seg2": "",
        "diff": false,
        "className": "",
        "x": 630,
        "y": 240,
        "wires": []
    },
    {
        "id": "481ac578d4a75eeb",
        "type": "function",
        "z": "b61db2d397ed3f52",
        "name": "function 12",
        "func": "let ecg = msg.payload.ecg;\nlet ts = msg.payload.ts;\nlet startUtc = msg.payload.start_utc;\n\nif (!ecg || !ts) return null;\n\n// Wenn start_utc enthalten ist (seq == 0), speichern\nif (startUtc !== undefined) {\n    global.set(\"ecg_start_utc\", startUtc);\n} else {\n    startUtc = global.get(\"ecg_start_utc\");\n    if (startUtc === undefined) return null; // noch keine gültige Zeitbasis\n}\n\n// CSV-Zeilen generieren\nlet lines = [];\nfor (let i = 0; i < ecg.length; i++) {\n    let utcSample = startUtc + ts[i] / 1_000_000;\n    lines.push(utcSample.toFixed(6) + \",\" + ecg[i].toFixed(3));\n}\n\nmsg.payload = lines.join(\"\\n\") + \"\\n\";\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 40,
        "wires": [
            [
                "bfcecee5ce5c1399"
            ]
        ]
    },
    {
        "id": "bfcecee5ce5c1399",
        "type": "file",
        "z": "b61db2d397ed3f52",
        "name": "",
        "filename": "C:\\Users\\Dima\\Desktop\\ecg_recording_device3.csv",
        "filenameType": "str",
        "appendNewline": false,
        "createDir": false,
        "overwriteFile": "false",
        "encoding": "utf8",
        "x": 750,
        "y": 40,
        "wires": [
            []
        ]
    },
    {
        "id": "88a9b0e2c67df4a0",
        "type": "inject",
        "z": "b61db2d397ed3f52",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "{   \"device\": \"ECG-3\",   \"msg_id\": 0,   \"pads_connected\": null,   \"seq\": 0,   \"ecg\": [],   \"ts\": [] }",
        "payloadType": "json",
        "x": 370,
        "y": 160,
        "wires": [
            [
                "5fd4b3cc1d3ebed9"
            ]
        ]
    },
    {
        "id": "0561a646fd11650f",
        "type": "mqtt in",
        "z": "83fee0b4628f9e33",
        "name": "",
        "topic": "ecg/device4",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 210,
        "y": 160,
        "wires": [
            [
                "b04cd56342b390b2",
                "02058ba61d35d993",
                "c28b4060b15fd3cb",
                "43b16cf9e24e7df4"
            ]
        ]
    },
    {
        "id": "b04cd56342b390b2",
        "type": "function",
        "z": "83fee0b4628f9e33",
        "name": "device name",
        "func": "msg.payload = msg.payload.device;  // Extract the \"device\" value\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 450,
        "y": 220,
        "wires": [
            []
        ]
    },
    {
        "id": "02058ba61d35d993",
        "type": "function",
        "z": "83fee0b4628f9e33",
        "name": "battery",
        "func": "if (msg.payload && msg.payload.battery !== undefined) {\n    msg.payload = msg.payload.battery;\n    return msg;\n} else {\n    return null;\n}\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 430,
        "y": 260,
        "wires": [
            [
                "9049254ff3281465"
            ]
        ]
    },
    {
        "id": "b3bc5a697beab74d",
        "type": "mqtt in",
        "z": "83fee0b4628f9e33",
        "name": "",
        "topic": "processed/device4",
        "qos": "2",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 240,
        "y": 560,
        "wires": [
            [
                "abe0bf89c1abd5fa"
            ]
        ]
    },
    {
        "id": "a1f782e4c9a52746",
        "type": "ui_text",
        "z": "83fee0b4628f9e33",
        "group": "668d8e78f47630d3",
        "order": 2,
        "width": 4,
        "height": 3,
        "name": "",
        "label": "BPM",
        "format": "{{msg.payload}}",
        "layout": "col-center",
        "className": "",
        "style": true,
        "font": "Georgia,Georgia,serif",
        "fontSize": "25",
        "color": "#1cb5ff",
        "x": 670,
        "y": 500,
        "wires": []
    },
    {
        "id": "abe0bf89c1abd5fa",
        "type": "function",
        "z": "83fee0b4628f9e33",
        "name": "function 22",
        "func": "let data = msg.payload;\n\nif (typeof data === \"string\") {\n    try {\n        data = JSON.parse(data);\n    } catch (e) {\n        node.warn(\"Invalid JSON\");\n        return null;\n    }\n}\n\nmsg.bpm = { payload: data.bpm_mean };\nmsg.hrv = { payload: data.hrv_rmssd };\nmsg.zone = { payload: data.zone };\nmsg.quality = { payload: data.ecg_quality };\nmsg.rsp = { payload: data.ecg_rsp_mean };\n\nreturn [msg.bpm, msg.hrv, msg.zone, msg.quality, msg.rsp];\n",
        "outputs": 5,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 450,
        "y": 560,
        "wires": [
            [
                "85c00d0fc6883198",
                "a1f782e4c9a52746"
            ],
            [
                "b5d688ac246952a7"
            ],
            [
                "6a8acbdb0c71ee47"
            ],
            [
                "27b819d7e6106527"
            ],
            [
                "7ccdc366370a4d97"
            ]
        ]
    },
    {
        "id": "85c00d0fc6883198",
        "type": "ui_chart",
        "z": "83fee0b4628f9e33",
        "name": "",
        "group": "668d8e78f47630d3",
        "order": 5,
        "width": 8,
        "height": 3,
        "label": "Heart Rate BPM",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 700,
        "y": 460,
        "wires": [
            []
        ]
    },
    {
        "id": "b5d688ac246952a7",
        "type": "ui_chart",
        "z": "83fee0b4628f9e33",
        "name": "",
        "group": "668d8e78f47630d3",
        "order": 6,
        "width": 8,
        "height": 3,
        "label": "HRV (RMSSD)",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 700,
        "y": 540,
        "wires": [
            []
        ]
    },
    {
        "id": "6a8acbdb0c71ee47",
        "type": "ui_template",
        "z": "83fee0b4628f9e33",
        "group": "668d8e78f47630d3",
        "name": "tr zone",
        "order": 7,
        "width": 4,
        "height": 1,
        "format": "<div style=\"font-size: 20px; font-weight: bold;\">\n    Zone: {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 670,
        "y": 580,
        "wires": [
            []
        ]
    },
    {
        "id": "27b819d7e6106527",
        "type": "ui_gauge",
        "z": "83fee0b4628f9e33",
        "name": "",
        "group": "668d8e78f47630d3",
        "order": 3,
        "width": 2,
        "height": 3,
        "gtype": "compass",
        "title": "ECG Quality",
        "label": "units",
        "format": "{{value}}",
        "min": 0,
        "max": "1",
        "colors": [
            "#00b500",
            "#e6e600",
            "#ca3838"
        ],
        "seg1": "0.5",
        "seg2": "0.9",
        "diff": false,
        "className": "",
        "x": 690,
        "y": 620,
        "wires": []
    },
    {
        "id": "c28b4060b15fd3cb",
        "type": "function",
        "z": "83fee0b4628f9e33",
        "name": "function 23",
        "func": "const deviceId = \"ECG-4\"; // Fixed device ID for this function node\nconst timeoutDuration = 20000; // 10 seconds\nconst timeoutKey = \"offline_timeout_\" + deviceId;\n\n// Cancel any existing timeout\nconst prevTimeout = flow.get(timeoutKey);\nif (prevTimeout) {\n    clearTimeout(prevTimeout);\n}\n\n// Set a new timeout to trigger Offline if no message is received\nconst timeout = setTimeout(() => {\n    const offlineMsg = {\n        payload: \"Offline\",\n        color: \"gray\",\n        device: deviceId\n    };\n    node.send(offlineMsg);\n}, timeoutDuration);\nflow.set(timeoutKey, timeout);\n\n// Process the current message\nif (msg.payload.pads_connected === true) {\n    msg.payload = \"Connected\";\n    msg.color = \"#4f97dc\";\n} else if (msg.payload.pads_connected === false) {\n    msg.payload = \"Disconnected\";\n    msg.color = \"red\";\n} else {\n    msg.payload = \"Offline\"; // Only used at startup\n    msg.color = \"gray\";\n}\nmsg.device = deviceId;\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 450,
        "y": 100,
        "wires": [
            [
                "3c76925bf3dc5127"
            ]
        ]
    },
    {
        "id": "3c76925bf3dc5127",
        "type": "ui_template",
        "z": "83fee0b4628f9e33",
        "group": "668d8e78f47630d3",
        "name": "",
        "order": 1,
        "width": 8,
        "height": 1,
        "format": "<div ng-style=\"{\n    'font-size': '20px',\n    'font-weight': 'bold',\n    'text-align': 'center',\n    'color': msg.color\n}\">\n    {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 680,
        "y": 100,
        "wires": [
            []
        ]
    },
    {
        "id": "7ccdc366370a4d97",
        "type": "function",
        "z": "83fee0b4628f9e33",
        "name": "function 24",
        "func": "let rsp = parseFloat(msg.payload); // VERY IMPORTANT: force it to number\n\nlet breathingStatus = \"Unknown\";\nlet color = \"grey\";\n\nif (rsp > -3 && rsp < 3) {\n    breathingStatus = \"Normal Breathing\";\n    color = \"#4f97dc\";\n} else {\n    breathingStatus = \"Irregular Breathing\";\n    color = \"red\";\n}\n\nmsg.payload = breathingStatus;\nmsg.color = color;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 690,
        "y": 660,
        "wires": [
            [
                "b835d586b1d84f8d"
            ]
        ]
    },
    {
        "id": "b835d586b1d84f8d",
        "type": "ui_template",
        "z": "83fee0b4628f9e33",
        "group": "668d8e78f47630d3",
        "name": "",
        "order": 8,
        "width": 4,
        "height": 1,
        "format": "<div ng-style=\"{\n    'font-size': '20px',\n    'font-weight': 'bold',\n    'text-align': 'center',\n    'color': msg.color\n}\">\n    {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 900,
        "y": 660,
        "wires": [
            []
        ]
    },
    {
        "id": "9049254ff3281465",
        "type": "ui_gauge",
        "z": "83fee0b4628f9e33",
        "name": "",
        "group": "668d8e78f47630d3",
        "order": 4,
        "width": 2,
        "height": 3,
        "gtype": "compass",
        "title": "Batterie (%)",
        "label": "%",
        "format": "{{msg.payload}}",
        "min": "0",
        "max": "100",
        "colors": [
            "#b50000",
            "#e6e600",
            "#00ff00"
        ],
        "seg1": "",
        "seg2": "",
        "diff": false,
        "className": "",
        "x": 690,
        "y": 260,
        "wires": []
    },
    {
        "id": "43b16cf9e24e7df4",
        "type": "function",
        "z": "83fee0b4628f9e33",
        "name": "function 25",
        "func": "let ecg = msg.payload.ecg;\nlet ts = msg.payload.ts;\nlet startUtc = msg.payload.start_utc;\n\nif (!ecg || !ts) return null;\n\n// Wenn start_utc enthalten ist (seq == 0), speichern\nif (startUtc !== undefined) {\n    global.set(\"ecg_start_utc\", startUtc);\n} else {\n    startUtc = global.get(\"ecg_start_utc\");\n    if (startUtc === undefined) return null; // noch keine gültige Zeitbasis\n}\n\n// CSV-Zeilen generieren\nlet lines = [];\nfor (let i = 0; i < ecg.length; i++) {\n    let utcSample = startUtc + ts[i] / 1_000_000;\n    lines.push(utcSample.toFixed(6) + \",\" + ecg[i].toFixed(3));\n}\n\nmsg.payload = lines.join(\"\\n\") + \"\\n\";\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 440,
        "y": 60,
        "wires": [
            [
                "eb5a534940ca2bc6"
            ]
        ]
    },
    {
        "id": "eb5a534940ca2bc6",
        "type": "file",
        "z": "83fee0b4628f9e33",
        "name": "",
        "filename": "C:\\Users\\Dima\\Desktop\\ecg_recording_device4.csv",
        "filenameType": "str",
        "appendNewline": false,
        "createDir": false,
        "overwriteFile": "false",
        "encoding": "utf8",
        "x": 810,
        "y": 60,
        "wires": [
            []
        ]
    },
    {
        "id": "81a217795af7c3dc",
        "type": "inject",
        "z": "83fee0b4628f9e33",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "{   \"device\": \"ECG-4\",   \"msg_id\": 0,   \"pads_connected\": null,   \"seq\": 0,   \"ecg\": [],   \"ts\": [] }",
        "payloadType": "json",
        "x": 430,
        "y": 180,
        "wires": [
            [
                "c28b4060b15fd3cb"
            ]
        ]
    },
    {
        "id": "2188bf5c5d6e589a",
        "type": "mqtt in",
        "z": "87c8228a65d82b8b",
        "name": "",
        "topic": "ecg/device5",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 150,
        "y": 160,
        "wires": [
            [
                "6e8c410c569c9983",
                "88ab17acb492b2b7",
                "85a0c28624e7058d",
                "7bc558075e220647"
            ]
        ]
    },
    {
        "id": "6e8c410c569c9983",
        "type": "function",
        "z": "87c8228a65d82b8b",
        "name": "device name",
        "func": "msg.payload = msg.payload.device;  // Extract the \"device\" value\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 390,
        "y": 200,
        "wires": [
            []
        ]
    },
    {
        "id": "88ab17acb492b2b7",
        "type": "function",
        "z": "87c8228a65d82b8b",
        "name": "battery",
        "func": "if (msg.payload && msg.payload.battery !== undefined) {\n    msg.payload = msg.payload.battery;\n    return msg;\n} else {\n    return null;\n}\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 370,
        "y": 240,
        "wires": [
            [
                "ef11c65b6d29d494"
            ]
        ]
    },
    {
        "id": "8c76ffacb0b720cb",
        "type": "mqtt in",
        "z": "87c8228a65d82b8b",
        "name": "",
        "topic": "processed/device5",
        "qos": "2",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 180,
        "y": 560,
        "wires": [
            [
                "2488ee761fa1f577"
            ]
        ]
    },
    {
        "id": "7fe9713dc10bdc85",
        "type": "ui_text",
        "z": "87c8228a65d82b8b",
        "group": "15f3328f74ed9705",
        "order": 2,
        "width": 4,
        "height": 3,
        "name": "",
        "label": "BPM",
        "format": "{{msg.payload}}",
        "layout": "col-center",
        "className": "",
        "style": true,
        "font": "Georgia,Georgia,serif",
        "fontSize": "25",
        "color": "#1cb5ff",
        "x": 610,
        "y": 500,
        "wires": []
    },
    {
        "id": "2488ee761fa1f577",
        "type": "function",
        "z": "87c8228a65d82b8b",
        "name": "function 32",
        "func": "let data = msg.payload;\n\nif (typeof data === \"string\") {\n    try {\n        data = JSON.parse(data);\n    } catch (e) {\n        node.warn(\"Invalid JSON\");\n        return null;\n    }\n}\n\nmsg.bpm = { payload: data.bpm_mean };\nmsg.hrv = { payload: data.hrv_rmssd };\nmsg.zone = { payload: data.zone };\nmsg.quality = { payload: data.ecg_quality };\nmsg.rsp = { payload: data.ecg_rsp_mean };\n\nreturn [msg.bpm, msg.hrv, msg.zone, msg.quality, msg.rsp];\n",
        "outputs": 5,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 390,
        "y": 560,
        "wires": [
            [
                "0c22ea67d697fe80",
                "7fe9713dc10bdc85"
            ],
            [
                "e4e9f8d5e5712198"
            ],
            [
                "a02aeb52af4f6d03"
            ],
            [
                "3b9ed2b955cd66d4"
            ],
            [
                "59807040064dd9cc"
            ]
        ]
    },
    {
        "id": "0c22ea67d697fe80",
        "type": "ui_chart",
        "z": "87c8228a65d82b8b",
        "name": "",
        "group": "15f3328f74ed9705",
        "order": 5,
        "width": 8,
        "height": 3,
        "label": "Heart Rate BPM",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 640,
        "y": 460,
        "wires": [
            []
        ]
    },
    {
        "id": "e4e9f8d5e5712198",
        "type": "ui_chart",
        "z": "87c8228a65d82b8b",
        "name": "",
        "group": "15f3328f74ed9705",
        "order": 6,
        "width": 8,
        "height": 3,
        "label": "HRV (RMSSD)",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 640,
        "y": 540,
        "wires": [
            []
        ]
    },
    {
        "id": "a02aeb52af4f6d03",
        "type": "ui_template",
        "z": "87c8228a65d82b8b",
        "group": "15f3328f74ed9705",
        "name": "tr zone",
        "order": 7,
        "width": 4,
        "height": 1,
        "format": "<div style=\"font-size: 20px; font-weight: bold;\">\n    Zone: {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 610,
        "y": 580,
        "wires": [
            []
        ]
    },
    {
        "id": "3b9ed2b955cd66d4",
        "type": "ui_gauge",
        "z": "87c8228a65d82b8b",
        "name": "",
        "group": "15f3328f74ed9705",
        "order": 3,
        "width": 2,
        "height": 3,
        "gtype": "compass",
        "title": "ECG Quality",
        "label": "units",
        "format": "{{value}}",
        "min": 0,
        "max": "1",
        "colors": [
            "#00b500",
            "#e6e600",
            "#ca3838"
        ],
        "seg1": "0.5",
        "seg2": "0.9",
        "diff": false,
        "className": "",
        "x": 630,
        "y": 620,
        "wires": []
    },
    {
        "id": "85a0c28624e7058d",
        "type": "function",
        "z": "87c8228a65d82b8b",
        "name": "function 33",
        "func": "const deviceId = \"ECG-5\"; // Fixed device ID for this function node\nconst timeoutDuration = 20000; // 10 seconds\nconst timeoutKey = \"offline_timeout_\" + deviceId;\n\n// Cancel any existing timeout\nconst prevTimeout = flow.get(timeoutKey);\nif (prevTimeout) {\n    clearTimeout(prevTimeout);\n}\n\n// Set a new timeout to trigger Offline if no message is received\nconst timeout = setTimeout(() => {\n    const offlineMsg = {\n        payload: \"Offline\",\n        color: \"gray\",\n        device: deviceId\n    };\n    node.send(offlineMsg);\n}, timeoutDuration);\nflow.set(timeoutKey, timeout);\n\n// Process the current message\nif (msg.payload.pads_connected === true) {\n    msg.payload = \"Connected\";\n    msg.color = \"#4f97dc\";\n} else if (msg.payload.pads_connected === false) {\n    msg.payload = \"Disconnected\";\n    msg.color = \"red\";\n} else {\n    msg.payload = \"Offline\"; // Only used at startup\n    msg.color = \"gray\";\n}\nmsg.device = deviceId;\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 390,
        "y": 100,
        "wires": [
            [
                "92a4ed659aa1ea4f"
            ]
        ]
    },
    {
        "id": "92a4ed659aa1ea4f",
        "type": "ui_template",
        "z": "87c8228a65d82b8b",
        "group": "15f3328f74ed9705",
        "name": "",
        "order": 1,
        "width": 8,
        "height": 1,
        "format": "<div ng-style=\"{\n    'font-size': '20px',\n    'font-weight': 'bold',\n    'text-align': 'center',\n    'color': msg.color\n}\">\n    {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 620,
        "y": 100,
        "wires": [
            []
        ]
    },
    {
        "id": "59807040064dd9cc",
        "type": "function",
        "z": "87c8228a65d82b8b",
        "name": "function 34",
        "func": "let rsp = parseFloat(msg.payload); // VERY IMPORTANT: force it to number\n\nlet breathingStatus = \"Unknown\";\nlet color = \"grey\";\n\nif (rsp > -3 && rsp < 3) {\n    breathingStatus = \"Normal Breathing\";\n    color = \"#4f97dc\";\n} else {\n    breathingStatus = \"Irregular Breathing\";\n    color = \"red\";\n}\n\nmsg.payload = breathingStatus;\nmsg.color = color;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 630,
        "y": 660,
        "wires": [
            [
                "150a44be018562c1"
            ]
        ]
    },
    {
        "id": "150a44be018562c1",
        "type": "ui_template",
        "z": "87c8228a65d82b8b",
        "group": "15f3328f74ed9705",
        "name": "",
        "order": 8,
        "width": 4,
        "height": 1,
        "format": "<div ng-style=\"{\n    'font-size': '20px',\n    'font-weight': 'bold',\n    'text-align': 'center',\n    'color': msg.color\n}\">\n    {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 840,
        "y": 660,
        "wires": [
            []
        ]
    },
    {
        "id": "ef11c65b6d29d494",
        "type": "ui_gauge",
        "z": "87c8228a65d82b8b",
        "name": "",
        "group": "15f3328f74ed9705",
        "order": 4,
        "width": 2,
        "height": 3,
        "gtype": "compass",
        "title": "Batterie (%)",
        "label": "%",
        "format": "{{msg.payload}}",
        "min": "0",
        "max": "100",
        "colors": [
            "#b50000",
            "#e6e600",
            "#00ff00"
        ],
        "seg1": "",
        "seg2": "",
        "diff": false,
        "className": "",
        "x": 630,
        "y": 240,
        "wires": []
    },
    {
        "id": "7bc558075e220647",
        "type": "function",
        "z": "87c8228a65d82b8b",
        "name": "function 35",
        "func": "let ecg = msg.payload.ecg;\nlet ts = msg.payload.ts;\nlet startUtc = msg.payload.start_utc;\n\nif (!ecg || !ts) return null;\n\n// Wenn start_utc enthalten ist (seq == 0), speichern\nif (startUtc !== undefined) {\n    global.set(\"ecg_start_utc\", startUtc);\n} else {\n    startUtc = global.get(\"ecg_start_utc\");\n    if (startUtc === undefined) return null; // noch keine gültige Zeitbasis\n}\n\n// CSV-Zeilen generieren\nlet lines = [];\nfor (let i = 0; i < ecg.length; i++) {\n    let utcSample = startUtc + ts[i] / 1_000_000;\n    lines.push(utcSample.toFixed(6) + \",\" + ecg[i].toFixed(3));\n}\n\nmsg.payload = lines.join(\"\\n\") + \"\\n\";\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 60,
        "wires": [
            [
                "f66069aea88a785f"
            ]
        ]
    },
    {
        "id": "f66069aea88a785f",
        "type": "file",
        "z": "87c8228a65d82b8b",
        "name": "",
        "filename": "C:\\Users\\Dima\\Desktop\\ecg_recording_device5.csv",
        "filenameType": "str",
        "appendNewline": false,
        "createDir": false,
        "overwriteFile": "false",
        "encoding": "utf8",
        "x": 750,
        "y": 60,
        "wires": [
            []
        ]
    },
    {
        "id": "8a02faedd1da15dc",
        "type": "inject",
        "z": "87c8228a65d82b8b",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "{   \"device\": \"ECG-5\",   \"msg_id\": 0,   \"pads_connected\": null,   \"seq\": 0,   \"ecg\": [],   \"ts\": [] }",
        "payloadType": "json",
        "x": 370,
        "y": 160,
        "wires": [
            [
                "85a0c28624e7058d"
            ]
        ]
    },
    {
        "id": "fb518dec81ec4b87",
        "type": "mqtt in",
        "z": "6d843e57b45b43cf",
        "name": "",
        "topic": "ecg/device6",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 150,
        "y": 180,
        "wires": [
            [
                "b6d0cf10bf54e002",
                "69f72289033478a8",
                "854d1ab2d4a8006f",
                "134ea5d652f6b0e7"
            ]
        ]
    },
    {
        "id": "b6d0cf10bf54e002",
        "type": "function",
        "z": "6d843e57b45b43cf",
        "name": "device name",
        "func": "msg.payload = msg.payload.device;  // Extract the \"device\" value\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 390,
        "y": 240,
        "wires": [
            []
        ]
    },
    {
        "id": "69f72289033478a8",
        "type": "function",
        "z": "6d843e57b45b43cf",
        "name": "battery",
        "func": "if (msg.payload && msg.payload.battery !== undefined) {\n    msg.payload = msg.payload.battery;\n    return msg;\n} else {\n    return null;\n}\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 370,
        "y": 280,
        "wires": [
            [
                "c86612c15db79a85"
            ]
        ]
    },
    {
        "id": "e2606e5b75ae9468",
        "type": "mqtt in",
        "z": "6d843e57b45b43cf",
        "name": "",
        "topic": "processed/device6",
        "qos": "2",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 180,
        "y": 580,
        "wires": [
            [
                "91da6c588ddc2def"
            ]
        ]
    },
    {
        "id": "0730b51fdb7e2667",
        "type": "ui_text",
        "z": "6d843e57b45b43cf",
        "group": "067c42357b3bc972",
        "order": 2,
        "width": 4,
        "height": 3,
        "name": "",
        "label": "BPM",
        "format": "{{msg.payload}}",
        "layout": "col-center",
        "className": "",
        "style": true,
        "font": "Georgia,Georgia,serif",
        "fontSize": "25",
        "color": "#1cb5ff",
        "x": 610,
        "y": 520,
        "wires": []
    },
    {
        "id": "91da6c588ddc2def",
        "type": "function",
        "z": "6d843e57b45b43cf",
        "name": "function 40",
        "func": "let data = msg.payload;\n\nif (typeof data === \"string\") {\n    try {\n        data = JSON.parse(data);\n    } catch (e) {\n        node.warn(\"Invalid JSON\");\n        return null;\n    }\n}\n\nmsg.bpm = { payload: data.bpm_mean };\nmsg.hrv = { payload: data.hrv_rmssd };\nmsg.zone = { payload: data.zone };\nmsg.quality = { payload: data.ecg_quality };\nmsg.rsp = { payload: data.ecg_rsp_mean };\n\nreturn [msg.bpm, msg.hrv, msg.zone, msg.quality, msg.rsp];\n",
        "outputs": 5,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 390,
        "y": 580,
        "wires": [
            [
                "ef8b7735a1a12e17",
                "0730b51fdb7e2667"
            ],
            [
                "5e7417d679fb3f12"
            ],
            [
                "011fd3ca77d8c492"
            ],
            [
                "b9b9b9cea956ccfa"
            ],
            [
                "2b1998eb9ff724f5"
            ]
        ]
    },
    {
        "id": "ef8b7735a1a12e17",
        "type": "ui_chart",
        "z": "6d843e57b45b43cf",
        "name": "",
        "group": "067c42357b3bc972",
        "order": 5,
        "width": 8,
        "height": 3,
        "label": "Heart Rate BPM",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 640,
        "y": 480,
        "wires": [
            []
        ]
    },
    {
        "id": "5e7417d679fb3f12",
        "type": "ui_chart",
        "z": "6d843e57b45b43cf",
        "name": "",
        "group": "067c42357b3bc972",
        "order": 6,
        "width": 8,
        "height": 3,
        "label": "HRV (RMSSD)",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 640,
        "y": 560,
        "wires": [
            []
        ]
    },
    {
        "id": "011fd3ca77d8c492",
        "type": "ui_template",
        "z": "6d843e57b45b43cf",
        "group": "067c42357b3bc972",
        "name": "tr zone",
        "order": 7,
        "width": 4,
        "height": 1,
        "format": "<div style=\"font-size: 20px; font-weight: bold;\">\n    Zone: {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 610,
        "y": 600,
        "wires": [
            []
        ]
    },
    {
        "id": "b9b9b9cea956ccfa",
        "type": "ui_gauge",
        "z": "6d843e57b45b43cf",
        "name": "",
        "group": "067c42357b3bc972",
        "order": 3,
        "width": 2,
        "height": 3,
        "gtype": "compass",
        "title": "ECG Quality",
        "label": "units",
        "format": "{{value}}",
        "min": 0,
        "max": "1",
        "colors": [
            "#00b500",
            "#e6e600",
            "#ca3838"
        ],
        "seg1": "0.5",
        "seg2": "0.9",
        "diff": false,
        "className": "",
        "x": 630,
        "y": 640,
        "wires": []
    },
    {
        "id": "854d1ab2d4a8006f",
        "type": "function",
        "z": "6d843e57b45b43cf",
        "name": "function 41",
        "func": "const deviceId = \"ECG-6\"; // Fixed device ID for this function node\nconst timeoutDuration = 20000; // 10 seconds\nconst timeoutKey = \"offline_timeout_\" + deviceId;\n\n// Cancel any existing timeout\nconst prevTimeout = flow.get(timeoutKey);\nif (prevTimeout) {\n    clearTimeout(prevTimeout);\n}\n\n// Set a new timeout to trigger Offline if no message is received\nconst timeout = setTimeout(() => {\n    const offlineMsg = {\n        payload: \"Offline\",\n        color: \"gray\",\n        device: deviceId\n    };\n    node.send(offlineMsg);\n}, timeoutDuration);\nflow.set(timeoutKey, timeout);\n\n// Process the current message\nif (msg.payload.pads_connected === true) {\n    msg.payload = \"Connected\";\n    msg.color = \"#4f97dc\";\n} else if (msg.payload.pads_connected === false) {\n    msg.payload = \"Disconnected\";\n    msg.color = \"red\";\n} else {\n    msg.payload = \"Offline\"; // Only used at startup\n    msg.color = \"gray\";\n}\nmsg.device = deviceId;\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 390,
        "y": 120,
        "wires": [
            [
                "1531eb7ce41920ba"
            ]
        ]
    },
    {
        "id": "1531eb7ce41920ba",
        "type": "ui_template",
        "z": "6d843e57b45b43cf",
        "group": "067c42357b3bc972",
        "name": "",
        "order": 1,
        "width": 8,
        "height": 1,
        "format": "<div ng-style=\"{\n    'font-size': '20px',\n    'font-weight': 'bold',\n    'text-align': 'center',\n    'color': msg.color\n}\">\n    {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 620,
        "y": 120,
        "wires": [
            []
        ]
    },
    {
        "id": "2b1998eb9ff724f5",
        "type": "function",
        "z": "6d843e57b45b43cf",
        "name": "function 42",
        "func": "let rsp = parseFloat(msg.payload); // VERY IMPORTANT: force it to number\n\nlet breathingStatus = \"Unknown\";\nlet color = \"grey\";\n\nif (rsp > -3 && rsp < 3) {\n    breathingStatus = \"Normal Breathing\";\n    color = \"#4f97dc\";\n} else {\n    breathingStatus = \"Irregular Breathing\";\n    color = \"red\";\n}\n\nmsg.payload = breathingStatus;\nmsg.color = color;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 630,
        "y": 680,
        "wires": [
            [
                "966c40f3830ecfab"
            ]
        ]
    },
    {
        "id": "966c40f3830ecfab",
        "type": "ui_template",
        "z": "6d843e57b45b43cf",
        "group": "067c42357b3bc972",
        "name": "",
        "order": 8,
        "width": 4,
        "height": 1,
        "format": "<div ng-style=\"{\n    'font-size': '20px',\n    'font-weight': 'bold',\n    'text-align': 'center',\n    'color': msg.color\n}\">\n    {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 840,
        "y": 680,
        "wires": [
            []
        ]
    },
    {
        "id": "c86612c15db79a85",
        "type": "ui_gauge",
        "z": "6d843e57b45b43cf",
        "name": "",
        "group": "067c42357b3bc972",
        "order": 4,
        "width": 2,
        "height": 3,
        "gtype": "compass",
        "title": "Batterie (%)",
        "label": "%",
        "format": "{{msg.payload}}",
        "min": "0",
        "max": "100",
        "colors": [
            "#b50000",
            "#e6e600",
            "#00ff00"
        ],
        "seg1": "",
        "seg2": "",
        "diff": false,
        "className": "",
        "x": 630,
        "y": 280,
        "wires": []
    },
    {
        "id": "134ea5d652f6b0e7",
        "type": "function",
        "z": "6d843e57b45b43cf",
        "name": "function 43",
        "func": "let ecg = msg.payload.ecg;\nlet ts = msg.payload.ts;\nlet startUtc = msg.payload.start_utc;\n\nif (!ecg || !ts) return null;\n\n// Wenn start_utc enthalten ist (seq == 0), speichern\nif (startUtc !== undefined) {\n    global.set(\"ecg_start_utc\", startUtc);\n} else {\n    startUtc = global.get(\"ecg_start_utc\");\n    if (startUtc === undefined) return null; // noch keine gültige Zeitbasis\n}\n\n// CSV-Zeilen generieren\nlet lines = [];\nfor (let i = 0; i < ecg.length; i++) {\n    let utcSample = startUtc + ts[i] / 1_000_000;\n    lines.push(utcSample.toFixed(6) + \",\" + ecg[i].toFixed(3));\n}\n\nmsg.payload = lines.join(\"\\n\") + \"\\n\";\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 80,
        "wires": [
            [
                "751cd898206a344f"
            ]
        ]
    },
    {
        "id": "751cd898206a344f",
        "type": "file",
        "z": "6d843e57b45b43cf",
        "name": "",
        "filename": "C:\\Users\\Dima\\Desktop\\ecg_recording_device6.csv",
        "filenameType": "str",
        "appendNewline": false,
        "createDir": false,
        "overwriteFile": "false",
        "encoding": "utf8",
        "x": 750,
        "y": 80,
        "wires": [
            []
        ]
    },
    {
        "id": "6ecd883fa10f1fc2",
        "type": "inject",
        "z": "6d843e57b45b43cf",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "{   \"device\": \"ECG-6\",   \"msg_id\": 0,   \"pads_connected\": null,   \"seq\": 0,   \"ecg\": [],   \"ts\": [] }",
        "payloadType": "json",
        "x": 370,
        "y": 200,
        "wires": [
            [
                "854d1ab2d4a8006f"
            ]
        ]
    },
    {
        "id": "c0e852a99e33b8d2",
        "type": "mqtt in",
        "z": "73d2d98fc364e2ae",
        "name": "",
        "topic": "ecg/device7",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 150,
        "y": 160,
        "wires": [
            [
                "9d828939b80685c8",
                "008622be2b824612",
                "1610a6465e7eb497",
                "3a068c9340f5fbd3"
            ]
        ]
    },
    {
        "id": "9d828939b80685c8",
        "type": "function",
        "z": "73d2d98fc364e2ae",
        "name": "device name",
        "func": "msg.payload = msg.payload.device;  // Extract the \"device\" value\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 390,
        "y": 240,
        "wires": [
            []
        ]
    },
    {
        "id": "008622be2b824612",
        "type": "function",
        "z": "73d2d98fc364e2ae",
        "name": "battery",
        "func": "if (msg.payload && msg.payload.battery !== undefined) {\n    msg.payload = msg.payload.battery;\n    return msg;\n} else {\n    return null;\n}\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 370,
        "y": 280,
        "wires": [
            [
                "6e8dbbe81519b996"
            ]
        ]
    },
    {
        "id": "108bf65c87fb6c8e",
        "type": "mqtt in",
        "z": "73d2d98fc364e2ae",
        "name": "",
        "topic": "processed/device7",
        "qos": "2",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 180,
        "y": 560,
        "wires": [
            [
                "eb8ee0cfba6b2ffc"
            ]
        ]
    },
    {
        "id": "24cb95e0779fdf75",
        "type": "ui_text",
        "z": "73d2d98fc364e2ae",
        "group": "574b012cc77fb53d",
        "order": 2,
        "width": 4,
        "height": 3,
        "name": "",
        "label": "BPM",
        "format": "{{msg.payload}}",
        "layout": "col-center",
        "className": "",
        "style": true,
        "font": "Georgia,Georgia,serif",
        "fontSize": "25",
        "color": "#1cb5ff",
        "x": 610,
        "y": 500,
        "wires": []
    },
    {
        "id": "eb8ee0cfba6b2ffc",
        "type": "function",
        "z": "73d2d98fc364e2ae",
        "name": "function 48",
        "func": "let data = msg.payload;\n\nif (typeof data === \"string\") {\n    try {\n        data = JSON.parse(data);\n    } catch (e) {\n        node.warn(\"Invalid JSON\");\n        return null;\n    }\n}\n\nmsg.bpm = { payload: data.bpm_mean };\nmsg.hrv = { payload: data.hrv_rmssd };\nmsg.zone = { payload: data.zone };\nmsg.quality = { payload: data.ecg_quality };\nmsg.rsp = { payload: data.ecg_rsp_mean };\n\nreturn [msg.bpm, msg.hrv, msg.zone, msg.quality, msg.rsp];\n",
        "outputs": 5,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 390,
        "y": 560,
        "wires": [
            [
                "d6e0f324336528ed",
                "24cb95e0779fdf75"
            ],
            [
                "475978430973d910"
            ],
            [
                "6112a77f6851768a"
            ],
            [
                "1d2b7c2225756924"
            ],
            [
                "b751ccc6d1a0f01f"
            ]
        ]
    },
    {
        "id": "d6e0f324336528ed",
        "type": "ui_chart",
        "z": "73d2d98fc364e2ae",
        "name": "",
        "group": "574b012cc77fb53d",
        "order": 5,
        "width": 8,
        "height": 3,
        "label": "Heart Rate BPM",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 640,
        "y": 460,
        "wires": [
            []
        ]
    },
    {
        "id": "475978430973d910",
        "type": "ui_chart",
        "z": "73d2d98fc364e2ae",
        "name": "",
        "group": "574b012cc77fb53d",
        "order": 6,
        "width": 8,
        "height": 3,
        "label": "HRV (RMSSD)",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 640,
        "y": 540,
        "wires": [
            []
        ]
    },
    {
        "id": "6112a77f6851768a",
        "type": "ui_template",
        "z": "73d2d98fc364e2ae",
        "group": "574b012cc77fb53d",
        "name": "tr zone",
        "order": 7,
        "width": 4,
        "height": 1,
        "format": "<div style=\"font-size: 20px; font-weight: bold;\">\n    Zone: {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 610,
        "y": 580,
        "wires": [
            []
        ]
    },
    {
        "id": "1d2b7c2225756924",
        "type": "ui_gauge",
        "z": "73d2d98fc364e2ae",
        "name": "",
        "group": "574b012cc77fb53d",
        "order": 3,
        "width": 2,
        "height": 3,
        "gtype": "compass",
        "title": "ECG Quality",
        "label": "units",
        "format": "{{value}}",
        "min": 0,
        "max": "1",
        "colors": [
            "#00b500",
            "#e6e600",
            "#ca3838"
        ],
        "seg1": "0.5",
        "seg2": "0.9",
        "diff": false,
        "className": "",
        "x": 630,
        "y": 620,
        "wires": []
    },
    {
        "id": "1610a6465e7eb497",
        "type": "function",
        "z": "73d2d98fc364e2ae",
        "name": "function 49",
        "func": "const deviceId = \"ECG-7\"; // Fixed device ID for this function node\nconst timeoutDuration = 20000; // 10 seconds\nconst timeoutKey = \"offline_timeout_\" + deviceId;\n\n// Cancel any existing timeout\nconst prevTimeout = flow.get(timeoutKey);\nif (prevTimeout) {\n    clearTimeout(prevTimeout);\n}\n\n// Set a new timeout to trigger Offline if no message is received\nconst timeout = setTimeout(() => {\n    const offlineMsg = {\n        payload: \"Offline\",\n        color: \"gray\",\n        device: deviceId\n    };\n    node.send(offlineMsg);\n}, timeoutDuration);\nflow.set(timeoutKey, timeout);\n\n// Process the current message\nif (msg.payload.pads_connected === true) {\n    msg.payload = \"Connected\";\n    msg.color = \"#4f97dc\";\n} else if (msg.payload.pads_connected === false) {\n    msg.payload = \"Disconnected\";\n    msg.color = \"red\";\n} else {\n    msg.payload = \"Offline\"; // Only used at startup\n    msg.color = \"gray\";\n}\nmsg.device = deviceId;\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 390,
        "y": 100,
        "wires": [
            [
                "a1628e3c32a089a1"
            ]
        ]
    },
    {
        "id": "a1628e3c32a089a1",
        "type": "ui_template",
        "z": "73d2d98fc364e2ae",
        "group": "574b012cc77fb53d",
        "name": "",
        "order": 1,
        "width": 8,
        "height": 1,
        "format": "<div ng-style=\"{\n    'font-size': '20px',\n    'font-weight': 'bold',\n    'text-align': 'center',\n    'color': msg.color\n}\">\n    {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 620,
        "y": 100,
        "wires": [
            []
        ]
    },
    {
        "id": "b751ccc6d1a0f01f",
        "type": "function",
        "z": "73d2d98fc364e2ae",
        "name": "function 50",
        "func": "let rsp = parseFloat(msg.payload); // VERY IMPORTANT: force it to number\n\nlet breathingStatus = \"Unknown\";\nlet color = \"grey\";\n\nif (rsp > -3 && rsp < 3) {\n    breathingStatus = \"Normal Breathing\";\n    color = \"#4f97dc\";\n} else {\n    breathingStatus = \"Irregular Breathing\";\n    color = \"red\";\n}\n\nmsg.payload = breathingStatus;\nmsg.color = color;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 630,
        "y": 660,
        "wires": [
            [
                "b18970f59e8757aa"
            ]
        ]
    },
    {
        "id": "b18970f59e8757aa",
        "type": "ui_template",
        "z": "73d2d98fc364e2ae",
        "group": "574b012cc77fb53d",
        "name": "",
        "order": 8,
        "width": 4,
        "height": 1,
        "format": "<div ng-style=\"{\n    'font-size': '20px',\n    'font-weight': 'bold',\n    'text-align': 'center',\n    'color': msg.color\n}\">\n    {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 840,
        "y": 660,
        "wires": [
            []
        ]
    },
    {
        "id": "6e8dbbe81519b996",
        "type": "ui_gauge",
        "z": "73d2d98fc364e2ae",
        "name": "",
        "group": "574b012cc77fb53d",
        "order": 4,
        "width": 2,
        "height": 3,
        "gtype": "compass",
        "title": "Batterie (%)",
        "label": "%",
        "format": "{{msg.payload}}",
        "min": "0",
        "max": "100",
        "colors": [
            "#b50000",
            "#e6e600",
            "#00ff00"
        ],
        "seg1": "",
        "seg2": "",
        "diff": false,
        "className": "",
        "x": 630,
        "y": 280,
        "wires": []
    },
    {
        "id": "3a068c9340f5fbd3",
        "type": "function",
        "z": "73d2d98fc364e2ae",
        "name": "function 51",
        "func": "let ecg = msg.payload.ecg;\nlet ts = msg.payload.ts;\nlet startUtc = msg.payload.start_utc;\n\nif (!ecg || !ts) return null;\n\n// Wenn start_utc enthalten ist (seq == 0), speichern\nif (startUtc !== undefined) {\n    global.set(\"ecg_start_utc\", startUtc);\n} else {\n    startUtc = global.get(\"ecg_start_utc\");\n    if (startUtc === undefined) return null; // noch keine gültige Zeitbasis\n}\n\n// CSV-Zeilen generieren\nlet lines = [];\nfor (let i = 0; i < ecg.length; i++) {\n    let utcSample = startUtc + ts[i] / 1_000_000;\n    lines.push(utcSample.toFixed(6) + \",\" + ecg[i].toFixed(3));\n}\n\nmsg.payload = lines.join(\"\\n\") + \"\\n\";\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 60,
        "wires": [
            [
                "e9701bc5f5f07c6a"
            ]
        ]
    },
    {
        "id": "e9701bc5f5f07c6a",
        "type": "file",
        "z": "73d2d98fc364e2ae",
        "name": "",
        "filename": "C:\\Users\\Dima\\Desktop\\ecg_recording_device7.csv",
        "filenameType": "str",
        "appendNewline": false,
        "createDir": false,
        "overwriteFile": "false",
        "encoding": "utf8",
        "x": 750,
        "y": 60,
        "wires": [
            []
        ]
    },
    {
        "id": "334019b726b9d4ec",
        "type": "inject",
        "z": "73d2d98fc364e2ae",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "{   \"device\": \"ECG-7\",   \"msg_id\": 0,   \"pads_connected\": null,   \"seq\": 0,   \"ecg\": [],   \"ts\": [] }",
        "payloadType": "json",
        "x": 370,
        "y": 200,
        "wires": [
            [
                "1610a6465e7eb497"
            ]
        ]
    },
    {
        "id": "6021a7afd817bafc",
        "type": "mqtt in",
        "z": "e69a2f485c6c5f7d",
        "name": "",
        "topic": "ecg/device8",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 130,
        "y": 160,
        "wires": [
            [
                "0dc5261c27b86270",
                "2a6a68cea97ac430",
                "c2ae4c6bb85ea88d",
                "c0aac9e0af3ee971"
            ]
        ]
    },
    {
        "id": "0dc5261c27b86270",
        "type": "function",
        "z": "e69a2f485c6c5f7d",
        "name": "device name",
        "func": "msg.payload = msg.payload.device;  // Extract the \"device\" value\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 370,
        "y": 240,
        "wires": [
            []
        ]
    },
    {
        "id": "2a6a68cea97ac430",
        "type": "function",
        "z": "e69a2f485c6c5f7d",
        "name": "battery",
        "func": "if (msg.payload && msg.payload.battery !== undefined) {\n    msg.payload = msg.payload.battery;\n    return msg;\n} else {\n    return null;\n}\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 350,
        "y": 280,
        "wires": [
            [
                "a118e74a47de43f2"
            ]
        ]
    },
    {
        "id": "51409f03cd8d689d",
        "type": "mqtt in",
        "z": "e69a2f485c6c5f7d",
        "name": "",
        "topic": "processed/device8",
        "qos": "2",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 160,
        "y": 560,
        "wires": [
            [
                "aa6d1322411ebb4a"
            ]
        ]
    },
    {
        "id": "d8d611044bca9a29",
        "type": "ui_text",
        "z": "e69a2f485c6c5f7d",
        "group": "6bd34fd905a51ff8",
        "order": 2,
        "width": 4,
        "height": 3,
        "name": "",
        "label": "BPM",
        "format": "{{msg.payload}}",
        "layout": "col-center",
        "className": "",
        "style": true,
        "font": "Georgia,Georgia,serif",
        "fontSize": "25",
        "color": "#1cb5ff",
        "x": 590,
        "y": 500,
        "wires": []
    },
    {
        "id": "aa6d1322411ebb4a",
        "type": "function",
        "z": "e69a2f485c6c5f7d",
        "name": "function 56",
        "func": "let data = msg.payload;\n\nif (typeof data === \"string\") {\n    try {\n        data = JSON.parse(data);\n    } catch (e) {\n        node.warn(\"Invalid JSON\");\n        return null;\n    }\n}\n\nmsg.bpm = { payload: data.bpm_mean };\nmsg.hrv = { payload: data.hrv_rmssd };\nmsg.zone = { payload: data.zone };\nmsg.quality = { payload: data.ecg_quality };\nmsg.rsp = { payload: data.ecg_rsp_mean };\n\nreturn [msg.bpm, msg.hrv, msg.zone, msg.quality, msg.rsp];\n",
        "outputs": 5,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 370,
        "y": 560,
        "wires": [
            [
                "c8c8bea852f0a98f",
                "d8d611044bca9a29"
            ],
            [
                "35c05018be898615"
            ],
            [
                "8e68f9b3be0e9f71"
            ],
            [
                "5849ed630fe10db8"
            ],
            [
                "7a33b87d7125433c"
            ]
        ]
    },
    {
        "id": "c8c8bea852f0a98f",
        "type": "ui_chart",
        "z": "e69a2f485c6c5f7d",
        "name": "",
        "group": "6bd34fd905a51ff8",
        "order": 5,
        "width": 8,
        "height": 3,
        "label": "Heart Rate BPM",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 620,
        "y": 460,
        "wires": [
            []
        ]
    },
    {
        "id": "35c05018be898615",
        "type": "ui_chart",
        "z": "e69a2f485c6c5f7d",
        "name": "",
        "group": "6bd34fd905a51ff8",
        "order": 6,
        "width": 8,
        "height": 3,
        "label": "HRV (RMSSD)",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 620,
        "y": 540,
        "wires": [
            []
        ]
    },
    {
        "id": "8e68f9b3be0e9f71",
        "type": "ui_template",
        "z": "e69a2f485c6c5f7d",
        "group": "6bd34fd905a51ff8",
        "name": "tr zone",
        "order": 7,
        "width": 4,
        "height": 1,
        "format": "<div style=\"font-size: 20px; font-weight: bold;\">\n    Zone: {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 590,
        "y": 580,
        "wires": [
            []
        ]
    },
    {
        "id": "5849ed630fe10db8",
        "type": "ui_gauge",
        "z": "e69a2f485c6c5f7d",
        "name": "",
        "group": "6bd34fd905a51ff8",
        "order": 3,
        "width": 2,
        "height": 3,
        "gtype": "compass",
        "title": "ECG Quality",
        "label": "units",
        "format": "{{value}}",
        "min": 0,
        "max": "1",
        "colors": [
            "#00b500",
            "#e6e600",
            "#ca3838"
        ],
        "seg1": "0.5",
        "seg2": "0.9",
        "diff": false,
        "className": "",
        "x": 610,
        "y": 620,
        "wires": []
    },
    {
        "id": "c2ae4c6bb85ea88d",
        "type": "function",
        "z": "e69a2f485c6c5f7d",
        "name": "function 57",
        "func": "const deviceId = \"ECG-8\"; // Fixed device ID for this function node\nconst timeoutDuration = 20000; // 10 seconds\nconst timeoutKey = \"offline_timeout_\" + deviceId;\n\n// Cancel any existing timeout\nconst prevTimeout = flow.get(timeoutKey);\nif (prevTimeout) {\n    clearTimeout(prevTimeout);\n}\n\n// Set a new timeout to trigger Offline if no message is received\nconst timeout = setTimeout(() => {\n    const offlineMsg = {\n        payload: \"Offline\",\n        color: \"gray\",\n        device: deviceId\n    };\n    node.send(offlineMsg);\n}, timeoutDuration);\nflow.set(timeoutKey, timeout);\n\n// Process the current message\nif (msg.payload.pads_connected === true) {\n    msg.payload = \"Connected\";\n    msg.color = \"#4f97dc\";\n} else if (msg.payload.pads_connected === false) {\n    msg.payload = \"Disconnected\";\n    msg.color = \"red\";\n} else {\n    msg.payload = \"Offline\"; // Only used at startup\n    msg.color = \"gray\";\n}\nmsg.device = deviceId;\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 370,
        "y": 100,
        "wires": [
            [
                "8da41f7dbe23f12f"
            ]
        ]
    },
    {
        "id": "8da41f7dbe23f12f",
        "type": "ui_template",
        "z": "e69a2f485c6c5f7d",
        "group": "6bd34fd905a51ff8",
        "name": "",
        "order": 1,
        "width": 8,
        "height": 1,
        "format": "<div ng-style=\"{\n    'font-size': '20px',\n    'font-weight': 'bold',\n    'text-align': 'center',\n    'color': msg.color\n}\">\n    {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 600,
        "y": 100,
        "wires": [
            []
        ]
    },
    {
        "id": "7a33b87d7125433c",
        "type": "function",
        "z": "e69a2f485c6c5f7d",
        "name": "function 58",
        "func": "let rsp = parseFloat(msg.payload); // VERY IMPORTANT: force it to number\n\nlet breathingStatus = \"Unknown\";\nlet color = \"grey\";\n\nif (rsp > -3 && rsp < 3) {\n    breathingStatus = \"Normal Breathing\";\n    color = \"#4f97dc\";\n} else {\n    breathingStatus = \"Irregular Breathing\";\n    color = \"red\";\n}\n\nmsg.payload = breathingStatus;\nmsg.color = color;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 610,
        "y": 660,
        "wires": [
            [
                "b73ba2dd5c8efafe"
            ]
        ]
    },
    {
        "id": "b73ba2dd5c8efafe",
        "type": "ui_template",
        "z": "e69a2f485c6c5f7d",
        "group": "6bd34fd905a51ff8",
        "name": "",
        "order": 8,
        "width": 4,
        "height": 1,
        "format": "<div ng-style=\"{\n    'font-size': '20px',\n    'font-weight': 'bold',\n    'text-align': 'center',\n    'color': msg.color\n}\">\n    {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 820,
        "y": 660,
        "wires": [
            []
        ]
    },
    {
        "id": "a118e74a47de43f2",
        "type": "ui_gauge",
        "z": "e69a2f485c6c5f7d",
        "name": "",
        "group": "6bd34fd905a51ff8",
        "order": 4,
        "width": 2,
        "height": 3,
        "gtype": "compass",
        "title": "Batterie (%)",
        "label": "%",
        "format": "{{msg.payload}}",
        "min": "0",
        "max": "100",
        "colors": [
            "#b50000",
            "#e6e600",
            "#00ff00"
        ],
        "seg1": "",
        "seg2": "",
        "diff": false,
        "className": "",
        "x": 610,
        "y": 280,
        "wires": []
    },
    {
        "id": "c0aac9e0af3ee971",
        "type": "function",
        "z": "e69a2f485c6c5f7d",
        "name": "function 59",
        "func": "let ecg = msg.payload.ecg;\nlet ts = msg.payload.ts;\nlet startUtc = msg.payload.start_utc;\n\nif (!ecg || !ts) return null;\n\n// Wenn start_utc enthalten ist (seq == 0), speichern\nif (startUtc !== undefined) {\n    global.set(\"ecg_start_utc\", startUtc);\n} else {\n    startUtc = global.get(\"ecg_start_utc\");\n    if (startUtc === undefined) return null; // noch keine gültige Zeitbasis\n}\n\n// CSV-Zeilen generieren\nlet lines = [];\nfor (let i = 0; i < ecg.length; i++) {\n    let utcSample = startUtc + ts[i] / 1_000_000;\n    lines.push(utcSample.toFixed(6) + \",\" + ecg[i].toFixed(3));\n}\n\nmsg.payload = lines.join(\"\\n\") + \"\\n\";\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 360,
        "y": 60,
        "wires": [
            [
                "b0cd26d1ba0530a9"
            ]
        ]
    },
    {
        "id": "b0cd26d1ba0530a9",
        "type": "file",
        "z": "e69a2f485c6c5f7d",
        "name": "",
        "filename": "C:\\Users\\Dima\\Desktop\\ecg_recording_device8.csv",
        "filenameType": "str",
        "appendNewline": false,
        "createDir": false,
        "overwriteFile": "false",
        "encoding": "utf8",
        "x": 730,
        "y": 60,
        "wires": [
            []
        ]
    },
    {
        "id": "cbe01ad8b1d94040",
        "type": "inject",
        "z": "e69a2f485c6c5f7d",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "{   \"device\": \"ECG-8\",   \"msg_id\": 0,   \"pads_connected\": null,   \"seq\": 0,   \"ecg\": [],   \"ts\": [] }",
        "payloadType": "json",
        "x": 350,
        "y": 200,
        "wires": [
            [
                "c2ae4c6bb85ea88d"
            ]
        ]
    },
    {
        "id": "7ce7c8048c174e7f",
        "type": "mqtt in",
        "z": "8082bc4b568774ed",
        "name": "",
        "topic": "ecg/device9",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 150,
        "y": 180,
        "wires": [
            [
                "27f1aacd78cdc818",
                "5cac7928ae1bba7e",
                "4cd8c684a414a6c1",
                "e56477acbadbd2f3"
            ]
        ]
    },
    {
        "id": "27f1aacd78cdc818",
        "type": "function",
        "z": "8082bc4b568774ed",
        "name": "device name",
        "func": "msg.payload = msg.payload.device;  // Extract the \"device\" value\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 390,
        "y": 240,
        "wires": [
            []
        ]
    },
    {
        "id": "5cac7928ae1bba7e",
        "type": "function",
        "z": "8082bc4b568774ed",
        "name": "battery",
        "func": "if (msg.payload && msg.payload.battery !== undefined) {\n    msg.payload = msg.payload.battery;\n    return msg;\n} else {\n    return null;\n}\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 370,
        "y": 280,
        "wires": [
            [
                "53caa1a95c1cc80d"
            ]
        ]
    },
    {
        "id": "41bde26c39df4f3a",
        "type": "mqtt in",
        "z": "8082bc4b568774ed",
        "name": "",
        "topic": "processed/device9",
        "qos": "2",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 180,
        "y": 580,
        "wires": [
            [
                "a5d3ce1422af5036"
            ]
        ]
    },
    {
        "id": "92adc6a1df84b198",
        "type": "ui_text",
        "z": "8082bc4b568774ed",
        "group": "4b6faf155b2cc2e1",
        "order": 2,
        "width": 4,
        "height": 3,
        "name": "",
        "label": "BPM",
        "format": "{{msg.payload}}",
        "layout": "col-center",
        "className": "",
        "style": true,
        "font": "Georgia,Georgia,serif",
        "fontSize": "25",
        "color": "#1cb5ff",
        "x": 610,
        "y": 520,
        "wires": []
    },
    {
        "id": "a5d3ce1422af5036",
        "type": "function",
        "z": "8082bc4b568774ed",
        "name": "function 5",
        "func": "let data = msg.payload;\n\nif (typeof data === \"string\") {\n    try {\n        data = JSON.parse(data);\n    } catch (e) {\n        node.warn(\"Invalid JSON\");\n        return null;\n    }\n}\n\nmsg.bpm = { payload: data.bpm_mean };\nmsg.hrv = { payload: data.hrv_rmssd };\nmsg.zone = { payload: data.zone };\nmsg.quality = { payload: data.ecg_quality };\nmsg.rsp = { payload: data.ecg_rsp_mean };\n\nreturn [msg.bpm, msg.hrv, msg.zone, msg.quality, msg.rsp];\n",
        "outputs": 5,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 390,
        "y": 580,
        "wires": [
            [
                "dc0f54f4e602666e",
                "92adc6a1df84b198"
            ],
            [
                "a55c9d90ce043882"
            ],
            [
                "0cd971c9b0c13303"
            ],
            [
                "bb71a648ceea92e7"
            ],
            [
                "c5c3991157f0b655"
            ]
        ]
    },
    {
        "id": "dc0f54f4e602666e",
        "type": "ui_chart",
        "z": "8082bc4b568774ed",
        "name": "",
        "group": "4b6faf155b2cc2e1",
        "order": 5,
        "width": 8,
        "height": 3,
        "label": "Heart Rate BPM",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 640,
        "y": 480,
        "wires": [
            []
        ]
    },
    {
        "id": "a55c9d90ce043882",
        "type": "ui_chart",
        "z": "8082bc4b568774ed",
        "name": "",
        "group": "4b6faf155b2cc2e1",
        "order": 6,
        "width": 8,
        "height": 3,
        "label": "HRV (RMSSD)",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 640,
        "y": 560,
        "wires": [
            []
        ]
    },
    {
        "id": "0cd971c9b0c13303",
        "type": "ui_template",
        "z": "8082bc4b568774ed",
        "group": "4b6faf155b2cc2e1",
        "name": "tr zone",
        "order": 7,
        "width": 4,
        "height": 1,
        "format": "<div style=\"font-size: 20px; font-weight: bold;\">\n    Zone: {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 610,
        "y": 600,
        "wires": [
            []
        ]
    },
    {
        "id": "bb71a648ceea92e7",
        "type": "ui_gauge",
        "z": "8082bc4b568774ed",
        "name": "",
        "group": "4b6faf155b2cc2e1",
        "order": 3,
        "width": 2,
        "height": 3,
        "gtype": "compass",
        "title": "ECG Quality",
        "label": "units",
        "format": "{{value}}",
        "min": 0,
        "max": "1",
        "colors": [
            "#00b500",
            "#e6e600",
            "#ca3838"
        ],
        "seg1": "0.5",
        "seg2": "0.9",
        "diff": false,
        "className": "",
        "x": 630,
        "y": 640,
        "wires": []
    },
    {
        "id": "4cd8c684a414a6c1",
        "type": "function",
        "z": "8082bc4b568774ed",
        "name": "function 6",
        "func": "const deviceId = \"ECG-9\"; // Fixed device ID for this function node\nconst timeoutDuration = 20000; // 10 seconds\nconst timeoutKey = \"offline_timeout_\" + deviceId;\n\n// Cancel any existing timeout\nconst prevTimeout = flow.get(timeoutKey);\nif (prevTimeout) {\n    clearTimeout(prevTimeout);\n}\n\n// Set a new timeout to trigger Offline if no message is received\nconst timeout = setTimeout(() => {\n    const offlineMsg = {\n        payload: \"Offline\",\n        color: \"gray\",\n        device: deviceId\n    };\n    node.send(offlineMsg);\n}, timeoutDuration);\nflow.set(timeoutKey, timeout);\n\n// Process the current message\nif (msg.payload.pads_connected === true) {\n    msg.payload = \"Connected\";\n    msg.color = \"#4f97dc\";\n} else if (msg.payload.pads_connected === false) {\n    msg.payload = \"Disconnected\";\n    msg.color = \"red\";\n} else {\n    msg.payload = \"Offline\"; // Only used at startup\n    msg.color = \"gray\";\n}\nmsg.device = deviceId;\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 390,
        "y": 120,
        "wires": [
            [
                "f0b0ba9baad5de41"
            ]
        ]
    },
    {
        "id": "f0b0ba9baad5de41",
        "type": "ui_template",
        "z": "8082bc4b568774ed",
        "group": "4b6faf155b2cc2e1",
        "name": "",
        "order": 1,
        "width": 8,
        "height": 1,
        "format": "<div ng-style=\"{\n    'font-size': '20px',\n    'font-weight': 'bold',\n    'text-align': 'center',\n    'color': msg.color\n}\">\n    {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 620,
        "y": 120,
        "wires": [
            []
        ]
    },
    {
        "id": "c5c3991157f0b655",
        "type": "function",
        "z": "8082bc4b568774ed",
        "name": "function 7",
        "func": "let rsp = parseFloat(msg.payload); // VERY IMPORTANT: force it to number\n\nlet breathingStatus = \"Unknown\";\nlet color = \"grey\";\n\nif (rsp > -3 && rsp < 3) {\n    breathingStatus = \"Normal Breathing\";\n    color = \"#4f97dc\";\n} else {\n    breathingStatus = \"Irregular Breathing\";\n    color = \"red\";\n}\n\nmsg.payload = breathingStatus;\nmsg.color = color;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 630,
        "y": 680,
        "wires": [
            [
                "7672c9161fe317e7"
            ]
        ]
    },
    {
        "id": "7672c9161fe317e7",
        "type": "ui_template",
        "z": "8082bc4b568774ed",
        "group": "4b6faf155b2cc2e1",
        "name": "",
        "order": 8,
        "width": 4,
        "height": 1,
        "format": "<div ng-style=\"{\n    'font-size': '20px',\n    'font-weight': 'bold',\n    'text-align': 'center',\n    'color': msg.color\n}\">\n    {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 840,
        "y": 680,
        "wires": [
            []
        ]
    },
    {
        "id": "53caa1a95c1cc80d",
        "type": "ui_gauge",
        "z": "8082bc4b568774ed",
        "name": "",
        "group": "4b6faf155b2cc2e1",
        "order": 4,
        "width": 2,
        "height": 3,
        "gtype": "compass",
        "title": "Batterie (%)",
        "label": "%",
        "format": "{{msg.payload}}",
        "min": "0",
        "max": "100",
        "colors": [
            "#b50000",
            "#e6e600",
            "#00ff00"
        ],
        "seg1": "",
        "seg2": "",
        "diff": false,
        "className": "",
        "x": 630,
        "y": 280,
        "wires": []
    },
    {
        "id": "e56477acbadbd2f3",
        "type": "function",
        "z": "8082bc4b568774ed",
        "name": "function 8",
        "func": "let ecg = msg.payload.ecg;\nlet ts = msg.payload.ts;\nlet startUtc = msg.payload.start_utc;\n\nif (!ecg || !ts) return null;\n\n// Wenn start_utc enthalten ist (seq == 0), speichern\nif (startUtc !== undefined) {\n    global.set(\"ecg_start_utc\", startUtc);\n} else {\n    startUtc = global.get(\"ecg_start_utc\");\n    if (startUtc === undefined) return null; // noch keine gültige Zeitbasis\n}\n\n// CSV-Zeilen generieren\nlet lines = [];\nfor (let i = 0; i < ecg.length; i++) {\n    let utcSample = startUtc + ts[i] / 1_000_000;\n    lines.push(utcSample.toFixed(6) + \",\" + ecg[i].toFixed(3));\n}\n\nmsg.payload = lines.join(\"\\n\") + \"\\n\";\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 80,
        "wires": [
            [
                "ba7de7c4ccd401f2"
            ]
        ]
    },
    {
        "id": "ba7de7c4ccd401f2",
        "type": "file",
        "z": "8082bc4b568774ed",
        "name": "",
        "filename": "C:\\Users\\Dima\\Desktop\\ecg_recording_device9.csv",
        "filenameType": "str",
        "appendNewline": false,
        "createDir": false,
        "overwriteFile": "false",
        "encoding": "utf8",
        "x": 750,
        "y": 80,
        "wires": [
            []
        ]
    },
    {
        "id": "94258018ca327ea6",
        "type": "inject",
        "z": "8082bc4b568774ed",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "{   \"device\": \"ECG-9\",   \"msg_id\": 0,   \"pads_connected\": null,   \"seq\": 0,   \"ecg\": [],   \"ts\": [] }",
        "payloadType": "json",
        "x": 370,
        "y": 200,
        "wires": [
            [
                "4cd8c684a414a6c1"
            ]
        ]
    },
    {
        "id": "86edca1c651146e8",
        "type": "mqtt in",
        "z": "677f06d969d5a671",
        "name": "",
        "topic": "ecg/device10",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 130,
        "y": 140,
        "wires": [
            [
                "e9597d8e8a3f7b52",
                "9fe2a720ef7197fe",
                "d904b5b54b892f95",
                "5c3ff9e7e1d70cd3"
            ]
        ]
    },
    {
        "id": "e9597d8e8a3f7b52",
        "type": "function",
        "z": "677f06d969d5a671",
        "name": "device name",
        "func": "msg.payload = msg.payload.device;  // Extract the \"device\" value\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 370,
        "y": 200,
        "wires": [
            []
        ]
    },
    {
        "id": "9fe2a720ef7197fe",
        "type": "function",
        "z": "677f06d969d5a671",
        "name": "battery",
        "func": "if (msg.payload && msg.payload.battery !== undefined) {\n    msg.payload = msg.payload.battery;\n    return msg;\n} else {\n    return null;\n}\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 350,
        "y": 240,
        "wires": [
            [
                "befb0d43c7f066f5"
            ]
        ]
    },
    {
        "id": "832cae9045857c57",
        "type": "mqtt in",
        "z": "677f06d969d5a671",
        "name": "",
        "topic": "processed/device10",
        "qos": "2",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 160,
        "y": 540,
        "wires": [
            [
                "754fc971a793e1c2"
            ]
        ]
    },
    {
        "id": "004bc10566017153",
        "type": "ui_text",
        "z": "677f06d969d5a671",
        "group": "d13e25f8bd900779",
        "order": 2,
        "width": 4,
        "height": 3,
        "name": "",
        "label": "BPM",
        "format": "{{msg.payload}}",
        "layout": "col-center",
        "className": "",
        "style": true,
        "font": "Georgia,Georgia,serif",
        "fontSize": "25",
        "color": "#1cb5ff",
        "x": 590,
        "y": 480,
        "wires": []
    },
    {
        "id": "754fc971a793e1c2",
        "type": "function",
        "z": "677f06d969d5a671",
        "name": "function 13",
        "func": "let data = msg.payload;\n\nif (typeof data === \"string\") {\n    try {\n        data = JSON.parse(data);\n    } catch (e) {\n        node.warn(\"Invalid JSON\");\n        return null;\n    }\n}\n\nmsg.bpm = { payload: data.bpm_mean };\nmsg.hrv = { payload: data.hrv_rmssd };\nmsg.zone = { payload: data.zone };\nmsg.quality = { payload: data.ecg_quality };\nmsg.rsp = { payload: data.ecg_rsp_mean };\n\nreturn [msg.bpm, msg.hrv, msg.zone, msg.quality, msg.rsp];\n",
        "outputs": 5,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 370,
        "y": 540,
        "wires": [
            [
                "252c2b8bb8b5ae26",
                "004bc10566017153"
            ],
            [
                "8d617dd596c9329f"
            ],
            [
                "f07533e748567321"
            ],
            [
                "e4bcb5722780b6a9"
            ],
            [
                "8add33e690765bfb"
            ]
        ]
    },
    {
        "id": "252c2b8bb8b5ae26",
        "type": "ui_chart",
        "z": "677f06d969d5a671",
        "name": "",
        "group": "d13e25f8bd900779",
        "order": 5,
        "width": 8,
        "height": 3,
        "label": "Heart Rate BPM",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 620,
        "y": 440,
        "wires": [
            []
        ]
    },
    {
        "id": "8d617dd596c9329f",
        "type": "ui_chart",
        "z": "677f06d969d5a671",
        "name": "",
        "group": "d13e25f8bd900779",
        "order": 6,
        "width": 8,
        "height": 3,
        "label": "HRV (RMSSD)",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 620,
        "y": 520,
        "wires": [
            []
        ]
    },
    {
        "id": "f07533e748567321",
        "type": "ui_template",
        "z": "677f06d969d5a671",
        "group": "d13e25f8bd900779",
        "name": "tr zone",
        "order": 7,
        "width": 4,
        "height": 1,
        "format": "<div style=\"font-size: 20px; font-weight: bold;\">\n    Zone: {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 590,
        "y": 560,
        "wires": [
            []
        ]
    },
    {
        "id": "e4bcb5722780b6a9",
        "type": "ui_gauge",
        "z": "677f06d969d5a671",
        "name": "",
        "group": "d13e25f8bd900779",
        "order": 3,
        "width": 2,
        "height": 3,
        "gtype": "compass",
        "title": "ECG Quality",
        "label": "units",
        "format": "{{value}}",
        "min": 0,
        "max": "1",
        "colors": [
            "#00b500",
            "#e6e600",
            "#ca3838"
        ],
        "seg1": "0.5",
        "seg2": "0.9",
        "diff": false,
        "className": "",
        "x": 610,
        "y": 600,
        "wires": []
    },
    {
        "id": "d904b5b54b892f95",
        "type": "function",
        "z": "677f06d969d5a671",
        "name": "function 14",
        "func": "const deviceId = \"ECG-10\"; // Fixed device ID for this function node\nconst timeoutDuration = 20000; // 10 seconds\nconst timeoutKey = \"offline_timeout_\" + deviceId;\n\n// Cancel any existing timeout\nconst prevTimeout = flow.get(timeoutKey);\nif (prevTimeout) {\n    clearTimeout(prevTimeout);\n}\n\n// Set a new timeout to trigger Offline if no message is received\nconst timeout = setTimeout(() => {\n    const offlineMsg = {\n        payload: \"Offline\",\n        color: \"gray\",\n        device: deviceId\n    };\n    node.send(offlineMsg);\n}, timeoutDuration);\nflow.set(timeoutKey, timeout);\n\n// Process the current message\nif (msg.payload.pads_connected === true) {\n    msg.payload = \"Connected\";\n    msg.color = \"#4f97dc\";\n} else if (msg.payload.pads_connected === false) {\n    msg.payload = \"Disconnected\";\n    msg.color = \"red\";\n} else {\n    msg.payload = \"Offline\"; // Only used at startup\n    msg.color = \"gray\";\n}\nmsg.device = deviceId;\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 370,
        "y": 80,
        "wires": [
            [
                "3d17f3df036f04a8"
            ]
        ]
    },
    {
        "id": "3d17f3df036f04a8",
        "type": "ui_template",
        "z": "677f06d969d5a671",
        "group": "d13e25f8bd900779",
        "name": "",
        "order": 1,
        "width": 8,
        "height": 1,
        "format": "<div ng-style=\"{\n    'font-size': '20px',\n    'font-weight': 'bold',\n    'text-align': 'center',\n    'color': msg.color\n}\">\n    {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 600,
        "y": 80,
        "wires": [
            []
        ]
    },
    {
        "id": "8add33e690765bfb",
        "type": "function",
        "z": "677f06d969d5a671",
        "name": "function 15",
        "func": "let rsp = parseFloat(msg.payload); // VERY IMPORTANT: force it to number\n\nlet breathingStatus = \"Unknown\";\nlet color = \"grey\";\n\nif (rsp > -3 && rsp < 3) {\n    breathingStatus = \"Normal Breathing\";\n    color = \"#4f97dc\";\n} else {\n    breathingStatus = \"Irregular Breathing\";\n    color = \"red\";\n}\n\nmsg.payload = breathingStatus;\nmsg.color = color;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 610,
        "y": 640,
        "wires": [
            [
                "b5eb2a355ddb8305"
            ]
        ]
    },
    {
        "id": "b5eb2a355ddb8305",
        "type": "ui_template",
        "z": "677f06d969d5a671",
        "group": "d13e25f8bd900779",
        "name": "",
        "order": 8,
        "width": 4,
        "height": 1,
        "format": "<div ng-style=\"{\n    'font-size': '20px',\n    'font-weight': 'bold',\n    'text-align': 'center',\n    'color': msg.color\n}\">\n    {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 820,
        "y": 640,
        "wires": [
            []
        ]
    },
    {
        "id": "befb0d43c7f066f5",
        "type": "ui_gauge",
        "z": "677f06d969d5a671",
        "name": "",
        "group": "d13e25f8bd900779",
        "order": 4,
        "width": 2,
        "height": 3,
        "gtype": "compass",
        "title": "Batterie (%)",
        "label": "%",
        "format": "{{msg.payload}}",
        "min": "0",
        "max": "100",
        "colors": [
            "#b50000",
            "#e6e600",
            "#00ff00"
        ],
        "seg1": "",
        "seg2": "",
        "diff": false,
        "className": "",
        "x": 610,
        "y": 240,
        "wires": []
    },
    {
        "id": "5c3ff9e7e1d70cd3",
        "type": "function",
        "z": "677f06d969d5a671",
        "name": "function 16",
        "func": "let ecg = msg.payload.ecg;\nlet ts = msg.payload.ts;\nlet startUtc = msg.payload.start_utc;\n\nif (!ecg || !ts) return null;\n\n// Wenn start_utc enthalten ist (seq == 0), speichern\nif (startUtc !== undefined) {\n    global.set(\"ecg_start_utc\", startUtc);\n} else {\n    startUtc = global.get(\"ecg_start_utc\");\n    if (startUtc === undefined) return null; // noch keine gültige Zeitbasis\n}\n\n// CSV-Zeilen generieren\nlet lines = [];\nfor (let i = 0; i < ecg.length; i++) {\n    let utcSample = startUtc + ts[i] / 1_000_000;\n    lines.push(utcSample.toFixed(6) + \",\" + ecg[i].toFixed(3));\n}\n\nmsg.payload = lines.join(\"\\n\") + \"\\n\";\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 360,
        "y": 40,
        "wires": [
            [
                "5b37806d1f28c79f"
            ]
        ]
    },
    {
        "id": "5b37806d1f28c79f",
        "type": "file",
        "z": "677f06d969d5a671",
        "name": "",
        "filename": "C:\\Users\\Dima\\Desktop\\ecg_recording_device10.csv",
        "filenameType": "str",
        "appendNewline": false,
        "createDir": false,
        "overwriteFile": "false",
        "encoding": "utf8",
        "x": 740,
        "y": 40,
        "wires": [
            []
        ]
    },
    {
        "id": "8c903c923598e7e6",
        "type": "inject",
        "z": "677f06d969d5a671",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "{   \"device\": \"ECG-10\",   \"msg_id\": 0,   \"pads_connected\": null,   \"seq\": 0,   \"ecg\": [],   \"ts\": [] }",
        "payloadType": "json",
        "x": 350,
        "y": 160,
        "wires": [
            [
                "d904b5b54b892f95"
            ]
        ]
    },
    {
        "id": "1a95c6ccb5735b1f",
        "type": "mqtt in",
        "z": "b6da6b5f72cc125a",
        "name": "",
        "topic": "ecg/device1",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 250,
        "y": 160,
        "wires": [
            [
                "212b99e4b293c135",
                "a0544e078c8a37b3",
                "e42286dd9e09b9d5",
                "1844e5e21656e50f",
                "87c3b5d161a95104",
                "2cfd813fb5757be0"
            ]
        ]
    },
    {
        "id": "4cc74a94ef02263d",
        "type": "ui_gauge",
        "z": "b6da6b5f72cc125a",
        "name": "",
        "group": "5e1b837211be31f1",
        "order": 6,
        "width": 2,
        "height": 3,
        "gtype": "compass",
        "title": "Batterie (%)",
        "label": "%",
        "format": "{{msg.payload}}",
        "min": "0",
        "max": "100",
        "colors": [
            "#b50000",
            "#e6e600",
            "#00ff00"
        ],
        "seg1": "",
        "seg2": "",
        "diff": false,
        "className": "",
        "x": 730,
        "y": 220,
        "wires": []
    },
    {
        "id": "212b99e4b293c135",
        "type": "function",
        "z": "b6da6b5f72cc125a",
        "name": "device name",
        "func": "msg.payload = msg.payload.device;  // Extract the \"device\" value\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 530,
        "y": 160,
        "wires": [
            []
        ]
    },
    {
        "id": "a0544e078c8a37b3",
        "type": "function",
        "z": "b6da6b5f72cc125a",
        "name": "battery",
        "func": "if (msg.payload && msg.payload.battery !== undefined) {\n    msg.payload = msg.payload.battery;\n    return msg;\n} else {\n    return null;\n}\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 510,
        "y": 220,
        "wires": [
            [
                "4cc74a94ef02263d"
            ]
        ]
    },
    {
        "id": "4dd1415c44a82891",
        "type": "file",
        "z": "b6da6b5f72cc125a",
        "name": "data blatt",
        "filename": "C:\\Users\\Dima\\Desktop\\ecg_data.csv",
        "filenameType": "str",
        "appendNewline": true,
        "createDir": true,
        "overwriteFile": "true",
        "encoding": "none",
        "x": 1010,
        "y": 300,
        "wires": [
            []
        ]
    },
    {
        "id": "1844e5e21656e50f",
        "type": "function",
        "z": "b6da6b5f72cc125a",
        "name": "function 18",
        "func": "let ecgBuffer = flow.get(\"ecgBuffer\") || [];\nconst maxSamples = 50000\n// Validate payload\nif (!msg.payload || !Array.isArray(msg.payload.ecg)) {\n    node.warn(\"Invalid payload format\");\n    return null;\n}\n\n// Append new data\necgBuffer = ecgBuffer.concat(msg.payload.ecg);\n\n// Trim buffer if needed\nif (ecgBuffer.length > maxSamples) {\n    ecgBuffer = ecgBuffer.slice(ecgBuffer.length - maxSamples);\n}\n\n// Save updated buffer to flow\nflow.set(\"ecgBuffer\", ecgBuffer);\n\n// Optional: send out current buffer every time (or add a condition here)\nmsg.payload = {\n    buffer: ecgBuffer,\n    length: ecgBuffer.length\n};\n\nnode.status({ fill: \"green\", shape: \"dot\", text: `Buffer: ${ecgBuffer.length}/${maxSamples}` });\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 530,
        "y": 300,
        "wires": [
            []
        ]
    },
    {
        "id": "b16a8f623f453ebd",
        "type": "ui_button",
        "z": "b6da6b5f72cc125a",
        "name": "",
        "group": "5e1b837211be31f1",
        "order": 2,
        "width": 4,
        "height": 1,
        "passthru": false,
        "label": "save data",
        "tooltip": "",
        "color": "",
        "bgcolor": "",
        "className": "",
        "icon": "",
        "payload": "",
        "payloadType": "str",
        "topic": "topic",
        "topicType": "msg",
        "x": 690,
        "y": 300,
        "wires": [
            [
                "f5f688c6562fede2"
            ]
        ]
    },
    {
        "id": "f5f688c6562fede2",
        "type": "function",
        "z": "b6da6b5f72cc125a",
        "name": "function 19",
        "func": "let ecgBuffer = flow.get(\"ecgBuffer\") || [];\n\nif (!Array.isArray(ecgBuffer) || ecgBuffer.length === 0) {\n    node.warn(\"No ECG data to save!\");\n    return null;\n}\n\nlet csvData = \"ecg_signal\\n\";\ncsvData += ecgBuffer.map(v => v.toFixed(3)).join(\"\\n\");\n\nmsg.payload = csvData;\nmsg.filename = \"C:/Users/Dima/Desktop/ecg_data.csv\";\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 850,
        "y": 300,
        "wires": [
            [
                "4dd1415c44a82891"
            ]
        ]
    },
    {
        "id": "df049e7ae8461b4c",
        "type": "mqtt out",
        "z": "b6da6b5f72cc125a",
        "name": "",
        "topic": "",
        "qos": "",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "6a8dd33d9e7fde80",
        "x": 1070,
        "y": 360,
        "wires": []
    },
    {
        "id": "844d3396112ed568",
        "type": "mqtt in",
        "z": "b6da6b5f72cc125a",
        "name": "",
        "topic": "processed/device1",
        "qos": "2",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 250,
        "y": 520,
        "wires": [
            [
                "06fb5009c2d7566f"
            ]
        ]
    },
    {
        "id": "b55bb56ace669007",
        "type": "ui_text",
        "z": "b6da6b5f72cc125a",
        "group": "5e1b837211be31f1",
        "order": 4,
        "width": 4,
        "height": 3,
        "name": "",
        "label": "BPM",
        "format": "{{msg.payload}}",
        "layout": "col-center",
        "className": "",
        "style": true,
        "font": "",
        "fontSize": "25",
        "color": "#09afff",
        "x": 690,
        "y": 460,
        "wires": []
    },
    {
        "id": "e42286dd9e09b9d5",
        "type": "function",
        "z": "b6da6b5f72cc125a",
        "name": "function 20",
        "func": "let payload;\n\ntry {\n    payload = (typeof msg.payload === 'string') ? JSON.parse(msg.payload) : msg.payload;\n} catch (err) {\n    node.warn(\"Invalid payload format\");\n    return null;\n}\n\nlet incomingTS = payload.ts;\nlet currentMsgId = payload.msg_id;\n\nif (!incomingTS || incomingTS.length < 2) {\n    node.warn(\"Message contains no or too few timestamps.\");\n    return null;\n}\n\n// Get stored state\nlet lastId = global.get(\"ts_last_id\");\nlet tsBuffer = global.get(\"ts_buffer\") || [];\n\n// If it's the same msg_id → continue accumulating\nif (currentMsgId === lastId || lastId === undefined) {\n    tsBuffer = tsBuffer.concat(incomingTS);\n    global.set(\"ts_buffer\", tsBuffer);\n    global.set(\"ts_last_id\", currentMsgId);\n    node.status({ fill: \"green\", shape: \"dot\", text: `Collecting msg_id ${currentMsgId} (${tsBuffer.length} ts)` });\n    return null;\n}\n\n// If msg_id has changed → analyze the previous one\nif (tsBuffer.length < 2) {\n    node.warn(`Not enough data in previous msg_id (${lastId}) to calculate.`);\n    // Reset for new msg_id\n    global.set(\"ts_buffer\", incomingTS);\n    global.set(\"ts_last_id\", currentMsgId);\n    return null;\n}\n\n// Calculate sampling rate for previous message\nlet intervals = [];\nfor (let i = 1; i < tsBuffer.length; i++) {\n    intervals.push(tsBuffer[i] - tsBuffer[i - 1]);\n}\nlet avgInterval = intervals.reduce((a, b) => a + b, 0) / intervals.length;\nlet samplingRate = 1_000_000 / avgInterval;  // µs → Hz\n\nmsg.payload = {\n    msg_id: lastId,\n    samples: tsBuffer.length,\n    avg_interval_us: avgInterval.toFixed(2),\n    estimated_sampling_rate_hz: samplingRate.toFixed(2)\n};\n\n// Reset for the new ID\nglobal.set(\"ts_buffer\", incomingTS);\nglobal.set(\"ts_last_id\", currentMsgId);\n\nnode.status({ fill: \"blue\", shape: \"ring\", text: `Analyzed msg_id ${lastId}` });\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 530,
        "y": 260,
        "wires": [
            []
        ]
    },
    {
        "id": "8e3cece3ea8ef000",
        "type": "ui_button",
        "z": "b6da6b5f72cc125a",
        "name": "",
        "group": "5e1b837211be31f1",
        "order": 1,
        "width": 4,
        "height": 1,
        "passthru": false,
        "label": "clear buffer",
        "tooltip": "",
        "color": "",
        "bgcolor": "",
        "className": "",
        "icon": "",
        "payload": "clear",
        "payloadType": "str",
        "topic": "clear",
        "topicType": "msg",
        "x": 710,
        "y": 360,
        "wires": [
            [
                "9539355397cc018d"
            ]
        ]
    },
    {
        "id": "9539355397cc018d",
        "type": "function",
        "z": "b6da6b5f72cc125a",
        "name": "function 21",
        "func": "if (msg.payload === \"clear\") {\n    flow.set(\"ecgBuffer\", []);\n    node.status({ fill: \"red\", shape: \"ring\", text: \"Buffer cleared\" });\n}\nreturn null;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 910,
        "y": 360,
        "wires": [
            []
        ]
    },
    {
        "id": "06fb5009c2d7566f",
        "type": "function",
        "z": "b6da6b5f72cc125a",
        "name": "function 22",
        "func": "let data = msg.payload;\n\nif (typeof data === \"string\") {\n    try {\n        data = JSON.parse(data);\n    } catch (e) {\n        node.warn(\"Invalid JSON\");\n        return null;\n    }\n}\n\nmsg.bpm = { payload: data.bpm_mean };\nmsg.hrv = { payload: data.hrv_rmssd };\nmsg.zone = { payload: data.zone };\nmsg.quality = { payload: data.ecg_quality };\nmsg.rsp = { payload: data.ecg_rsp_mean };\n\nreturn [msg.bpm, msg.hrv, msg.zone, msg.quality, msg.rsp];\n",
        "outputs": 5,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 460,
        "y": 520,
        "wires": [
            [
                "bfa23eb56b872eda",
                "b55bb56ace669007"
            ],
            [
                "7ccfa6b3153851a2"
            ],
            [
                "300a9a4bb7189dd0"
            ],
            [
                "de8d26eb1287ef90"
            ],
            [
                "1bf73b760a7a4f28"
            ]
        ]
    },
    {
        "id": "bfa23eb56b872eda",
        "type": "ui_chart",
        "z": "b6da6b5f72cc125a",
        "name": "",
        "group": "5e1b837211be31f1",
        "order": 7,
        "width": 8,
        "height": 3,
        "label": "Heart Rate BPM",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 720,
        "y": 420,
        "wires": [
            []
        ]
    },
    {
        "id": "7ccfa6b3153851a2",
        "type": "ui_chart",
        "z": "b6da6b5f72cc125a",
        "name": "",
        "group": "5e1b837211be31f1",
        "order": 8,
        "width": 8,
        "height": 3,
        "label": "HRV (RMSSD)",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 720,
        "y": 500,
        "wires": [
            []
        ]
    },
    {
        "id": "300a9a4bb7189dd0",
        "type": "ui_template",
        "z": "b6da6b5f72cc125a",
        "group": "5e1b837211be31f1",
        "name": "tr zone",
        "order": 9,
        "width": 4,
        "height": 1,
        "format": "<div style=\"font-size: 20px; font-weight: bold;\">\n    Zone: {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 690,
        "y": 540,
        "wires": [
            []
        ]
    },
    {
        "id": "de8d26eb1287ef90",
        "type": "ui_gauge",
        "z": "b6da6b5f72cc125a",
        "name": "",
        "group": "5e1b837211be31f1",
        "order": 5,
        "width": 2,
        "height": 3,
        "gtype": "compass",
        "title": "ECG Quality",
        "label": "units",
        "format": "{{value}}",
        "min": 0,
        "max": "1",
        "colors": [
            "#00b500",
            "#e6e600",
            "#ca3838"
        ],
        "seg1": "0.5",
        "seg2": "0.9",
        "diff": false,
        "className": "",
        "x": 710,
        "y": 580,
        "wires": []
    },
    {
        "id": "1bf73b760a7a4f28",
        "type": "function",
        "z": "b6da6b5f72cc125a",
        "name": "function 23",
        "func": "let rsp = parseFloat(msg.payload);\n\nlet breathingStatus = \"Unknown\";\nlet color = \"grey\";\n\nif (rsp > -3 && rsp < 3) {\n    breathingStatus = \"Normal Breathing\";\n    color = \"#4f97dc\";\n} else {\n    breathingStatus = \"Irregular Breathing\";\n    color = \"red\";\n}\n\nmsg.payload = breathingStatus;\nmsg.color = color;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 700,
        "y": 620,
        "wires": [
            [
                "f56b478f7b98618c"
            ]
        ]
    },
    {
        "id": "f56b478f7b98618c",
        "type": "ui_template",
        "z": "b6da6b5f72cc125a",
        "group": "5e1b837211be31f1",
        "name": "",
        "order": 10,
        "width": 4,
        "height": 1,
        "format": "<div style=\"color: {{msg.color}}; font-size: 20px; font-weight: bold;\">\n    {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 940,
        "y": 620,
        "wires": [
            []
        ]
    },
    {
        "id": "4d1602fd9672d2d7",
        "type": "function",
        "z": "b6da6b5f72cc125a",
        "name": "function 24",
        "func": "// Incoming message like:\n// { device: \"ECG-1\", msg_id: 199, pads_connected: true, seq: 401, ecg: [val1, val2, val3, val4, val5] }\n\nif (!msg.payload || !Array.isArray(msg.payload.ecg)) {\n    node.warn(\"Invalid payload format\");\n    return null;\n}\n\n// Convert ecg array to CSV string (one value per line)\nlet ecgArray = msg.payload.ecg;\nlet csvString = ecgArray.join(\"\\n\") + \"\\n\";\n\nmsg.payload = csvString;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 110,
        "y": 700,
        "wires": [
            [
                "a34b692ad26efb7d"
            ]
        ]
    },
    {
        "id": "a34b692ad26efb7d",
        "type": "file",
        "z": "b6da6b5f72cc125a",
        "name": "",
        "filename": "C:\\Users\\Dima\\Desktop\\ecg_recording.csv",
        "filenameType": "str",
        "appendNewline": false,
        "createDir": false,
        "overwriteFile": "false",
        "encoding": "utf8",
        "x": 390,
        "y": 700,
        "wires": [
            []
        ]
    },
    {
        "id": "86c4b2123240d2bb",
        "type": "ui_template",
        "z": "b6da6b5f72cc125a",
        "group": "5e1b837211be31f1",
        "name": "",
        "order": 3,
        "width": 8,
        "height": 1,
        "format": "<div ng-style=\"{\n    'font-size': '20px',\n    'font-weight': 'bold',\n    'text-align': 'center',\n    'color': msg.color\n}\">\n    {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 720,
        "y": 100,
        "wires": [
            []
        ]
    },
    {
        "id": "87c3b5d161a95104",
        "type": "function",
        "z": "b6da6b5f72cc125a",
        "name": "function 25",
        "func": "const deviceId = \"ECG-1\"; // Fixed device ID for this function node\nconst timeoutDuration = 20000; // 10 seconds\nconst timeoutKey = \"offline_timeout_\" + deviceId;\n\n// Cancel any existing timeout\nconst prevTimeout = flow.get(timeoutKey);\nif (prevTimeout) {\n    clearTimeout(prevTimeout);\n}\n\n// Set a new timeout to trigger Offline if no message is received\nconst timeout = setTimeout(() => {\n    const offlineMsg = {\n        payload: \"Offline\",\n        color: \"gray\",\n        device: deviceId\n    };\n    node.send(offlineMsg);\n}, timeoutDuration);\nflow.set(timeoutKey, timeout);\n\n// Process the current message\nif (msg.payload.pads_connected === true) {\n    msg.payload = \"Connected\";\n    msg.color = \"#4f97dc\";\n} else if (msg.payload.pads_connected === false) {\n    msg.payload = \"Disconnected\";\n    msg.color = \"red\";\n} else {\n    msg.payload = \"Offline\"; // Only used at startup\n    msg.color = \"gray\";\n}\nmsg.device = deviceId;\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 530,
        "y": 100,
        "wires": [
            [
                "86c4b2123240d2bb"
            ]
        ]
    },
    {
        "id": "2cfd813fb5757be0",
        "type": "function",
        "z": "b6da6b5f72cc125a",
        "name": "function 26",
        "func": "let ecg = msg.payload.ecg;\nlet ts = msg.payload.ts;\nlet startUtc = msg.payload.start_utc;\n\nif (!ecg || !ts) return null;\n\n// Wenn start_utc enthalten ist (seq == 0), speichern\nif (startUtc !== undefined) {\n    global.set(\"ecg_start_utc\", startUtc);\n} else {\n    startUtc = global.get(\"ecg_start_utc\");\n    if (startUtc === undefined) return null; // noch keine gültige Zeitbasis\n}\n\n// CSV-Zeilen generieren\nlet lines = [];\nfor (let i = 0; i < ecg.length; i++) {\n    let utcSample = startUtc + ts[i] / 1_000_000;\n    lines.push(utcSample.toFixed(6) + \",\" + ecg[i].toFixed(3));\n}\n\nmsg.payload = lines.join(\"\\n\") + \"\\n\";\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 520,
        "y": 40,
        "wires": [
            [
                "cc8932a8f81bd3e8"
            ]
        ]
    },
    {
        "id": "cc8932a8f81bd3e8",
        "type": "file",
        "z": "b6da6b5f72cc125a",
        "name": "",
        "filename": "C:\\Users\\Dima\\Desktop\\ecg_recording_device1.csv",
        "filenameType": "str",
        "appendNewline": false,
        "createDir": false,
        "overwriteFile": "false",
        "encoding": "utf8",
        "x": 850,
        "y": 40,
        "wires": [
            []
        ]
    },
    {
        "id": "731ba914a771832d",
        "type": "mqtt in",
        "z": "382713f15f103ffc",
        "name": "",
        "topic": "ecg/device10/status",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 170,
        "y": 240,
        "wires": [
            [
                "8859cc09552ffc7c",
                "0a91217c0bf30c8f"
            ]
        ]
    },
    {
        "id": "da17b0f795eb192b",
        "type": "function",
        "z": "382713f15f103ffc",
        "name": "function 29",
        "func": "let ecg = msg.payload.ecg;\nlet sampleTs = msg.payload.sample_ts;\nlet startUtc = msg.payload.start_utc;\n\nif (ecg === undefined || sampleTs === undefined) return null;\n\n// Wenn start_utc enthalten ist, speichern\nif (startUtc !== undefined) {\n    global.set(\"ecg_start_utc\", startUtc);\n} else {\n    startUtc = global.get(\"ecg_start_utc\");\n    if (startUtc === undefined) return null; // noch keine gültige Zeitbasis\n}\n\n// UTC timestamp of this sample\nlet utcSample = startUtc + sampleTs / 1_000_000;\n\n// CSV line\nmsg.payload = utcSample.toFixed(6) + \",\" + ecg.toFixed(3) + \"\\n\";\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 490,
        "y": 60,
        "wires": [
            [
                "6c5a64b9cb700836"
            ]
        ]
    },
    {
        "id": "6c5a64b9cb700836",
        "type": "file",
        "z": "382713f15f103ffc",
        "name": "",
        "filename": "C:\\Users\\Dima\\Desktop\\ecg_recording_device_10_V2.csv",
        "filenameType": "str",
        "appendNewline": false,
        "createDir": false,
        "overwriteFile": "false",
        "encoding": "utf8",
        "x": 850,
        "y": 60,
        "wires": [
            []
        ]
    },
    {
        "id": "404f35ea054ef972",
        "type": "mqtt in",
        "z": "382713f15f103ffc",
        "name": "",
        "topic": "ecg/device10",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 150,
        "y": 160,
        "wires": [
            [
                "fa3719b9059777fb",
                "da17b0f795eb192b"
            ]
        ]
    },
    {
        "id": "fa3719b9059777fb",
        "type": "function",
        "z": "382713f15f103ffc",
        "name": "device name",
        "func": "msg.payload = msg.payload.device;  // Extract the \"device\" value\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 490,
        "y": 120,
        "wires": [
            []
        ]
    },
    {
        "id": "0a91217c0bf30c8f",
        "type": "function",
        "z": "382713f15f103ffc",
        "name": "battery",
        "func": "if (msg.payload && msg.payload.battery !== undefined) {\n    msg.payload = msg.payload.battery;\n    return msg;\n} else {\n    return null;\n}\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 470,
        "y": 240,
        "wires": [
            [
                "40b70c1178c3661a"
            ]
        ]
    },
    {
        "id": "8859cc09552ffc7c",
        "type": "function",
        "z": "382713f15f103ffc",
        "name": "function 30",
        "func": "// Only run for status messages (not ECG samples)\nif (!msg.payload.hasOwnProperty(\"pads_connected\")) {\n    return null;\n}\n\nconst deviceId = msg.payload.device || \"ECG-10\";\nconst timeoutDuration = 30000 + 5000; // Status every 30s + small buffer\nconst timeoutKey = \"offline_timeout_\" + deviceId;\n\n// Cancel previous timeout\nconst prevTimeout = flow.get(timeoutKey);\nif (prevTimeout) {\n    clearTimeout(prevTimeout);\n}\n\n// Set new timeout → send Offline message if no new status received\nconst timeout = setTimeout(() => {\n    const offlineMsg = {\n        payload: \"Offline\",\n        color: \"gray\",\n        device: deviceId\n    };\n    node.send(offlineMsg);\n}, timeoutDuration);\nflow.set(timeoutKey, timeout);\n\n// Interpret pad connection status\nif (msg.payload.pads_connected === true) {\n    msg.payload = \"Connected\";\n    msg.color = \"#4f97dc\";\n} else if (msg.payload.pads_connected === false) {\n    msg.payload = \"Disconnected\";\n    msg.color = \"red\";\n} else {\n    msg.payload = \"Offline\";\n    msg.color = \"gray\";\n}\n\nmsg.device = deviceId;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 490,
        "y": 300,
        "wires": [
            [
                "4b5656c84c57490a"
            ]
        ]
    },
    {
        "id": "4b5656c84c57490a",
        "type": "ui_template",
        "z": "382713f15f103ffc",
        "group": "7637a5740c4750b6",
        "name": "",
        "order": 1,
        "width": 8,
        "height": 1,
        "format": "<div ng-style=\"{\n    'font-size': '20px',\n    'font-weight': 'bold',\n    'text-align': 'center',\n    'color': msg.color\n}\">\n    {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 720,
        "y": 300,
        "wires": [
            []
        ]
    },
    {
        "id": "40b70c1178c3661a",
        "type": "ui_gauge",
        "z": "382713f15f103ffc",
        "name": "",
        "group": "7637a5740c4750b6",
        "order": 4,
        "width": 2,
        "height": 3,
        "gtype": "compass",
        "title": "Batterie (%)",
        "label": "%",
        "format": "{{msg.payload}}",
        "min": "0",
        "max": "100",
        "colors": [
            "#b50000",
            "#e6e600",
            "#00ff00"
        ],
        "seg1": "",
        "seg2": "",
        "diff": false,
        "className": "",
        "x": 730,
        "y": 240,
        "wires": []
    },
    {
        "id": "01929dbba894d532",
        "type": "inject",
        "z": "382713f15f103ffc",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "{   \"device\": \"ECG-10\",   \"msg_id\": 0,   \"pads_connected\": null,   \"seq\": 0,   \"ecg\": [],   \"ts\": [] }",
        "payloadType": "json",
        "x": 510,
        "y": 360,
        "wires": [
            [
                "8859cc09552ffc7c"
            ]
        ]
    },
    {
        "id": "d01c464e8390e4be",
        "type": "mqtt in",
        "z": "382713f15f103ffc",
        "name": "",
        "topic": "processed/device10",
        "qos": "2",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 170,
        "y": 520,
        "wires": [
            [
                "70e08f22dc9a2d28"
            ]
        ]
    },
    {
        "id": "5cd951dba10729d9",
        "type": "ui_text",
        "z": "382713f15f103ffc",
        "group": "7637a5740c4750b6",
        "order": 2,
        "width": 4,
        "height": 3,
        "name": "",
        "label": "BPM",
        "format": "{{msg.payload}}",
        "layout": "col-center",
        "className": "",
        "style": true,
        "font": "Georgia,Georgia,serif",
        "fontSize": "25",
        "color": "#1cb5ff",
        "x": 600,
        "y": 460,
        "wires": []
    },
    {
        "id": "70e08f22dc9a2d28",
        "type": "function",
        "z": "382713f15f103ffc",
        "name": "function 31",
        "func": "let data = msg.payload;\n\nif (typeof data === \"string\") {\n    try {\n        data = JSON.parse(data);\n    } catch (e) {\n        node.warn(\"Invalid JSON\");\n        return null;\n    }\n}\n\nmsg.bpm = { payload: data.bpm_mean };\nmsg.hrv = { payload: data.hrv_rmssd };\nmsg.zone = { payload: data.zone };\nmsg.quality = { payload: data.ecg_quality };\nmsg.rsp = { payload: data.ecg_rsp_mean };\n\nreturn [msg.bpm, msg.hrv, msg.zone, msg.quality, msg.rsp];\n",
        "outputs": 5,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 520,
        "wires": [
            [
                "974934aa8d453e58",
                "5cd951dba10729d9"
            ],
            [
                "f7dd4b5c717927e8"
            ],
            [
                "bb0c50d3409a4417"
            ],
            [
                "4065a564e6a1924c"
            ],
            [
                "d80f0a35abb4c44e"
            ]
        ]
    },
    {
        "id": "974934aa8d453e58",
        "type": "ui_chart",
        "z": "382713f15f103ffc",
        "name": "",
        "group": "7637a5740c4750b6",
        "order": 5,
        "width": 8,
        "height": 3,
        "label": "Heart Rate BPM",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 630,
        "y": 420,
        "wires": [
            []
        ]
    },
    {
        "id": "f7dd4b5c717927e8",
        "type": "ui_chart",
        "z": "382713f15f103ffc",
        "name": "",
        "group": "7637a5740c4750b6",
        "order": 6,
        "width": 8,
        "height": 3,
        "label": "HRV (RMSSD)",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 630,
        "y": 500,
        "wires": [
            []
        ]
    },
    {
        "id": "bb0c50d3409a4417",
        "type": "ui_template",
        "z": "382713f15f103ffc",
        "group": "7637a5740c4750b6",
        "name": "tr zone",
        "order": 7,
        "width": 4,
        "height": 1,
        "format": "<div style=\"font-size: 20px; font-weight: bold;\">\n    Zone: {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 600,
        "y": 540,
        "wires": [
            []
        ]
    },
    {
        "id": "4065a564e6a1924c",
        "type": "ui_gauge",
        "z": "382713f15f103ffc",
        "name": "",
        "group": "7637a5740c4750b6",
        "order": 3,
        "width": 2,
        "height": 3,
        "gtype": "compass",
        "title": "ECG Quality",
        "label": "units",
        "format": "{{value}}",
        "min": 0,
        "max": "1",
        "colors": [
            "#00b500",
            "#e6e600",
            "#ca3838"
        ],
        "seg1": "0.5",
        "seg2": "0.9",
        "diff": false,
        "className": "",
        "x": 620,
        "y": 580,
        "wires": []
    },
    {
        "id": "d80f0a35abb4c44e",
        "type": "function",
        "z": "382713f15f103ffc",
        "name": "function 32",
        "func": "let rsp = parseFloat(msg.payload); // VERY IMPORTANT: force it to number\n\nlet breathingStatus = \"Unknown\";\nlet color = \"grey\";\n\nif (rsp > -3 && rsp < 3) {\n    breathingStatus = \"Normal Breathing\";\n    color = \"#4f97dc\";\n} else {\n    breathingStatus = \"Irregular Breathing\";\n    color = \"red\";\n}\n\nmsg.payload = breathingStatus;\nmsg.color = color;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 620,
        "y": 620,
        "wires": [
            [
                "e499c7768ba9bf14"
            ]
        ]
    },
    {
        "id": "e499c7768ba9bf14",
        "type": "ui_template",
        "z": "382713f15f103ffc",
        "group": "7637a5740c4750b6",
        "name": "",
        "order": 8,
        "width": 4,
        "height": 1,
        "format": "<div ng-style=\"{\n    'font-size': '20px',\n    'font-weight': 'bold',\n    'text-align': 'center',\n    'color': msg.color\n}\">\n    {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 830,
        "y": 620,
        "wires": [
            []
        ]
    },
    {
        "id": "2ca7d7df53ac23f2",
        "type": "mqtt in",
        "z": "bdb2f7c1745d22d1",
        "name": "",
        "topic": "ecg/device9/status",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 190,
        "y": 260,
        "wires": [
            [
                "cb05d2cd90808df9",
                "e553f20876be5ae7"
            ]
        ]
    },
    {
        "id": "604dafe2e51141e0",
        "type": "function",
        "z": "bdb2f7c1745d22d1",
        "name": "function 1",
        "func": "let ecg = msg.payload.ecg;\nlet sampleTs = msg.payload.sample_ts;\nlet startUtc = msg.payload.start_utc;\n\nif (ecg === undefined || sampleTs === undefined) return null;\n\n// Wenn start_utc enthalten ist, speichern\nif (startUtc !== undefined) {\n    global.set(\"ecg_start_utc\", startUtc);\n} else {\n    startUtc = global.get(\"ecg_start_utc\");\n    if (startUtc === undefined) return null; // noch keine gültige Zeitbasis\n}\n\n// UTC timestamp of this sample\nlet utcSample = startUtc + sampleTs / 1_000_000;\n\n// CSV line\nmsg.payload = utcSample.toFixed(6) + \",\" + ecg.toFixed(3) + \"\\n\";\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 510,
        "y": 80,
        "wires": [
            [
                "686b9c0f4a24e527"
            ]
        ]
    },
    {
        "id": "686b9c0f4a24e527",
        "type": "file",
        "z": "bdb2f7c1745d22d1",
        "name": "",
        "filename": "C:\\Users\\Dima\\Desktop\\ecg_recording_device_09_V2.csv",
        "filenameType": "str",
        "appendNewline": false,
        "createDir": false,
        "overwriteFile": "false",
        "encoding": "utf8",
        "x": 870,
        "y": 80,
        "wires": [
            []
        ]
    },
    {
        "id": "9ab957c3e5f3683d",
        "type": "mqtt in",
        "z": "bdb2f7c1745d22d1",
        "name": "",
        "topic": "ecg/device9",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 170,
        "y": 180,
        "wires": [
            [
                "c260bdd7299ae030",
                "604dafe2e51141e0"
            ]
        ]
    },
    {
        "id": "c260bdd7299ae030",
        "type": "function",
        "z": "bdb2f7c1745d22d1",
        "name": "device name",
        "func": "msg.payload = msg.payload.device;  // Extract the \"device\" value\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 510,
        "y": 140,
        "wires": [
            []
        ]
    },
    {
        "id": "e553f20876be5ae7",
        "type": "function",
        "z": "bdb2f7c1745d22d1",
        "name": "battery",
        "func": "if (msg.payload && msg.payload.battery !== undefined) {\n    msg.payload = msg.payload.battery;\n    return msg;\n} else {\n    return null;\n}\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 490,
        "y": 260,
        "wires": [
            [
                "2c7816592053105b"
            ]
        ]
    },
    {
        "id": "cb05d2cd90808df9",
        "type": "function",
        "z": "bdb2f7c1745d22d1",
        "name": "function 2",
        "func": "// Only run for status messages (not ECG samples)\nif (!msg.payload.hasOwnProperty(\"pads_connected\")) {\n    return null;\n}\n\nconst deviceId = msg.payload.device || \"ECG-10\";\nconst timeoutDuration = 30000 + 5000; // Status every 30s + small buffer\nconst timeoutKey = \"offline_timeout_\" + deviceId;\n\n// Cancel previous timeout\nconst prevTimeout = flow.get(timeoutKey);\nif (prevTimeout) {\n    clearTimeout(prevTimeout);\n}\n\n// Set new timeout → send Offline message if no new status received\nconst timeout = setTimeout(() => {\n    const offlineMsg = {\n        payload: \"Offline\",\n        color: \"gray\",\n        device: deviceId\n    };\n    node.send(offlineMsg);\n}, timeoutDuration);\nflow.set(timeoutKey, timeout);\n\n// Interpret pad connection status\nif (msg.payload.pads_connected === true) {\n    msg.payload = \"Connected\";\n    msg.color = \"#4f97dc\";\n} else if (msg.payload.pads_connected === false) {\n    msg.payload = \"Disconnected\";\n    msg.color = \"red\";\n} else {\n    msg.payload = \"Offline\";\n    msg.color = \"gray\";\n}\n\nmsg.device = deviceId;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 510,
        "y": 320,
        "wires": [
            [
                "897c2c67db680403"
            ]
        ]
    },
    {
        "id": "897c2c67db680403",
        "type": "ui_template",
        "z": "bdb2f7c1745d22d1",
        "group": "687bdc205a57f688",
        "name": "",
        "order": 1,
        "width": 8,
        "height": 1,
        "format": "<div ng-style=\"{\n    'font-size': '20px',\n    'font-weight': 'bold',\n    'text-align': 'center',\n    'color': msg.color\n}\">\n    {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 740,
        "y": 320,
        "wires": [
            []
        ]
    },
    {
        "id": "2c7816592053105b",
        "type": "ui_gauge",
        "z": "bdb2f7c1745d22d1",
        "name": "",
        "group": "687bdc205a57f688",
        "order": 4,
        "width": 2,
        "height": 3,
        "gtype": "compass",
        "title": "Batterie (%)",
        "label": "%",
        "format": "{{msg.payload}}",
        "min": "0",
        "max": "100",
        "colors": [
            "#b50000",
            "#e6e600",
            "#00ff00"
        ],
        "seg1": "",
        "seg2": "",
        "diff": false,
        "className": "",
        "x": 750,
        "y": 260,
        "wires": []
    },
    {
        "id": "98f620574c129e70",
        "type": "inject",
        "z": "bdb2f7c1745d22d1",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "{   \"device\": \"ECG-10\",   \"msg_id\": 0,   \"pads_connected\": null,   \"seq\": 0,   \"ecg\": [],   \"ts\": [] }",
        "payloadType": "json",
        "x": 530,
        "y": 380,
        "wires": [
            [
                "cb05d2cd90808df9"
            ]
        ]
    },
    {
        "id": "945103a7955cfbac",
        "type": "mqtt in",
        "z": "bdb2f7c1745d22d1",
        "name": "",
        "topic": "processed/device9",
        "qos": "2",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 190,
        "y": 540,
        "wires": [
            [
                "ccc76fd464a03448"
            ]
        ]
    },
    {
        "id": "776a96ed09bb6673",
        "type": "ui_text",
        "z": "bdb2f7c1745d22d1",
        "group": "687bdc205a57f688",
        "order": 2,
        "width": 4,
        "height": 3,
        "name": "",
        "label": "BPM",
        "format": "{{msg.payload}}",
        "layout": "col-center",
        "className": "",
        "style": true,
        "font": "Georgia,Georgia,serif",
        "fontSize": "25",
        "color": "#1cb5ff",
        "x": 620,
        "y": 480,
        "wires": []
    },
    {
        "id": "ccc76fd464a03448",
        "type": "function",
        "z": "bdb2f7c1745d22d1",
        "name": "function 3",
        "func": "let data = msg.payload;\n\nif (typeof data === \"string\") {\n    try {\n        data = JSON.parse(data);\n    } catch (e) {\n        node.warn(\"Invalid JSON\");\n        return null;\n    }\n}\n\nmsg.bpm = { payload: data.bpm_mean };\nmsg.hrv = { payload: data.hrv_rmssd };\nmsg.zone = { payload: data.zone };\nmsg.quality = { payload: data.ecg_quality };\nmsg.rsp = { payload: data.ecg_rsp_mean };\n\nreturn [msg.bpm, msg.hrv, msg.zone, msg.quality, msg.rsp];\n",
        "outputs": 5,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 400,
        "y": 540,
        "wires": [
            [
                "27bc82bcc7789542",
                "776a96ed09bb6673"
            ],
            [
                "e5f064669d715dc9"
            ],
            [
                "791557d16b022ad9"
            ],
            [
                "d64863b3fcb0333d"
            ],
            [
                "b987871671087eb8"
            ]
        ]
    },
    {
        "id": "27bc82bcc7789542",
        "type": "ui_chart",
        "z": "bdb2f7c1745d22d1",
        "name": "",
        "group": "687bdc205a57f688",
        "order": 5,
        "width": 8,
        "height": 3,
        "label": "Heart Rate BPM",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 650,
        "y": 440,
        "wires": [
            []
        ]
    },
    {
        "id": "e5f064669d715dc9",
        "type": "ui_chart",
        "z": "bdb2f7c1745d22d1",
        "name": "",
        "group": "687bdc205a57f688",
        "order": 6,
        "width": 8,
        "height": 3,
        "label": "HRV (RMSSD)",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 650,
        "y": 520,
        "wires": [
            []
        ]
    },
    {
        "id": "791557d16b022ad9",
        "type": "ui_template",
        "z": "bdb2f7c1745d22d1",
        "group": "687bdc205a57f688",
        "name": "tr zone",
        "order": 7,
        "width": 4,
        "height": 1,
        "format": "<div style=\"font-size: 20px; font-weight: bold;\">\n    Zone: {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 620,
        "y": 560,
        "wires": [
            []
        ]
    },
    {
        "id": "d64863b3fcb0333d",
        "type": "ui_gauge",
        "z": "bdb2f7c1745d22d1",
        "name": "",
        "group": "687bdc205a57f688",
        "order": 3,
        "width": 2,
        "height": 3,
        "gtype": "compass",
        "title": "ECG Quality",
        "label": "units",
        "format": "{{value}}",
        "min": 0,
        "max": "1",
        "colors": [
            "#00b500",
            "#e6e600",
            "#ca3838"
        ],
        "seg1": "0.5",
        "seg2": "0.9",
        "diff": false,
        "className": "",
        "x": 640,
        "y": 600,
        "wires": []
    },
    {
        "id": "b987871671087eb8",
        "type": "function",
        "z": "bdb2f7c1745d22d1",
        "name": "function 4",
        "func": "let rsp = parseFloat(msg.payload); // VERY IMPORTANT: force it to number\n\nlet breathingStatus = \"Unknown\";\nlet color = \"grey\";\n\nif (rsp > -3 && rsp < 3) {\n    breathingStatus = \"Normal Breathing\";\n    color = \"#4f97dc\";\n} else {\n    breathingStatus = \"Irregular Breathing\";\n    color = \"red\";\n}\n\nmsg.payload = breathingStatus;\nmsg.color = color;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 640,
        "y": 640,
        "wires": [
            [
                "b669d18c854447e7"
            ]
        ]
    },
    {
        "id": "b669d18c854447e7",
        "type": "ui_template",
        "z": "bdb2f7c1745d22d1",
        "group": "687bdc205a57f688",
        "name": "",
        "order": 8,
        "width": 4,
        "height": 1,
        "format": "<div ng-style=\"{\n    'font-size': '20px',\n    'font-weight': 'bold',\n    'text-align': 'center',\n    'color': msg.color\n}\">\n    {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 850,
        "y": 640,
        "wires": [
            []
        ]
    },
    {
        "id": "cf66ab1f2ddaedd1",
        "type": "mqtt in",
        "z": "ca0982db8ee424ff",
        "name": "",
        "topic": "ecg/device8/status",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 170,
        "y": 240,
        "wires": [
            [
                "46fb48256c7176a3",
                "2e6c4fce79f01e85"
            ]
        ]
    },
    {
        "id": "57210f3606c74203",
        "type": "function",
        "z": "ca0982db8ee424ff",
        "name": "function 27",
        "func": "let ecg = msg.payload.ecg;\nlet sampleTs = msg.payload.sample_ts;\nlet startUtc = msg.payload.start_utc;\n\nif (ecg === undefined || sampleTs === undefined) return null;\n\n// Wenn start_utc enthalten ist, speichern\nif (startUtc !== undefined) {\n    global.set(\"ecg_start_utc\", startUtc);\n} else {\n    startUtc = global.get(\"ecg_start_utc\");\n    if (startUtc === undefined) return null; // noch keine gültige Zeitbasis\n}\n\n// UTC timestamp of this sample\nlet utcSample = startUtc + sampleTs / 1_000_000;\n\n// CSV line\nmsg.payload = utcSample.toFixed(6) + \",\" + ecg.toFixed(3) + \"\\n\";\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 490,
        "y": 60,
        "wires": [
            [
                "f95d657a62a91012"
            ]
        ]
    },
    {
        "id": "f95d657a62a91012",
        "type": "file",
        "z": "ca0982db8ee424ff",
        "name": "",
        "filename": "C:\\Users\\Dima\\Desktop\\ecg_recording_device_08_V2.csv",
        "filenameType": "str",
        "appendNewline": false,
        "createDir": false,
        "overwriteFile": "false",
        "encoding": "utf8",
        "x": 850,
        "y": 60,
        "wires": [
            []
        ]
    },
    {
        "id": "4e3c872bb09404b5",
        "type": "mqtt in",
        "z": "ca0982db8ee424ff",
        "name": "",
        "topic": "ecg/device8",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 150,
        "y": 160,
        "wires": [
            [
                "a6c4c48dbe3de201",
                "57210f3606c74203"
            ]
        ]
    },
    {
        "id": "a6c4c48dbe3de201",
        "type": "function",
        "z": "ca0982db8ee424ff",
        "name": "device name",
        "func": "msg.payload = msg.payload.device;  // Extract the \"device\" value\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 490,
        "y": 120,
        "wires": [
            []
        ]
    },
    {
        "id": "2e6c4fce79f01e85",
        "type": "function",
        "z": "ca0982db8ee424ff",
        "name": "battery",
        "func": "if (msg.payload && msg.payload.battery !== undefined) {\n    msg.payload = msg.payload.battery;\n    return msg;\n} else {\n    return null;\n}\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 470,
        "y": 240,
        "wires": [
            [
                "a28ff9f79e19dbd5"
            ]
        ]
    },
    {
        "id": "46fb48256c7176a3",
        "type": "function",
        "z": "ca0982db8ee424ff",
        "name": "function 28",
        "func": "// Only run for status messages (not ECG samples)\nif (!msg.payload.hasOwnProperty(\"pads_connected\")) {\n    return null;\n}\n\nconst deviceId = msg.payload.device || \"ECG-10\";\nconst timeoutDuration = 30000 + 5000; // Status every 30s + small buffer\nconst timeoutKey = \"offline_timeout_\" + deviceId;\n\n// Cancel previous timeout\nconst prevTimeout = flow.get(timeoutKey);\nif (prevTimeout) {\n    clearTimeout(prevTimeout);\n}\n\n// Set new timeout → send Offline message if no new status received\nconst timeout = setTimeout(() => {\n    const offlineMsg = {\n        payload: \"Offline\",\n        color: \"gray\",\n        device: deviceId\n    };\n    node.send(offlineMsg);\n}, timeoutDuration);\nflow.set(timeoutKey, timeout);\n\n// Interpret pad connection status\nif (msg.payload.pads_connected === true) {\n    msg.payload = \"Connected\";\n    msg.color = \"#4f97dc\";\n} else if (msg.payload.pads_connected === false) {\n    msg.payload = \"Disconnected\";\n    msg.color = \"red\";\n} else {\n    msg.payload = \"Offline\";\n    msg.color = \"gray\";\n}\n\nmsg.device = deviceId;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 490,
        "y": 300,
        "wires": [
            [
                "a61f162b29dc7f60"
            ]
        ]
    },
    {
        "id": "a61f162b29dc7f60",
        "type": "ui_template",
        "z": "ca0982db8ee424ff",
        "group": "4d384bceafa49ebb",
        "name": "",
        "order": 1,
        "width": 8,
        "height": 1,
        "format": "<div ng-style=\"{\n    'font-size': '20px',\n    'font-weight': 'bold',\n    'text-align': 'center',\n    'color': msg.color\n}\">\n    {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 720,
        "y": 300,
        "wires": [
            []
        ]
    },
    {
        "id": "a28ff9f79e19dbd5",
        "type": "ui_gauge",
        "z": "ca0982db8ee424ff",
        "name": "",
        "group": "4d384bceafa49ebb",
        "order": 4,
        "width": 2,
        "height": 3,
        "gtype": "compass",
        "title": "Batterie (%)",
        "label": "%",
        "format": "{{msg.payload}}",
        "min": "0",
        "max": "100",
        "colors": [
            "#b50000",
            "#e6e600",
            "#00ff00"
        ],
        "seg1": "",
        "seg2": "",
        "diff": false,
        "className": "",
        "x": 730,
        "y": 240,
        "wires": []
    },
    {
        "id": "72b26fbceb66d4a2",
        "type": "inject",
        "z": "ca0982db8ee424ff",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "{   \"device\": \"ECG-10\",   \"msg_id\": 0,   \"pads_connected\": null,   \"seq\": 0,   \"ecg\": [],   \"ts\": [] }",
        "payloadType": "json",
        "x": 510,
        "y": 360,
        "wires": [
            [
                "46fb48256c7176a3"
            ]
        ]
    },
    {
        "id": "c1d83e887488b9d6",
        "type": "mqtt in",
        "z": "ca0982db8ee424ff",
        "name": "",
        "topic": "processed/device8",
        "qos": "2",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 170,
        "y": 520,
        "wires": [
            [
                "cbe4766876714ae0"
            ]
        ]
    },
    {
        "id": "9964fe063a2bcea8",
        "type": "ui_text",
        "z": "ca0982db8ee424ff",
        "group": "4d384bceafa49ebb",
        "order": 2,
        "width": 4,
        "height": 3,
        "name": "",
        "label": "BPM",
        "format": "{{msg.payload}}",
        "layout": "col-center",
        "className": "",
        "style": true,
        "font": "Georgia,Georgia,serif",
        "fontSize": "25",
        "color": "#1cb5ff",
        "x": 600,
        "y": 460,
        "wires": []
    },
    {
        "id": "cbe4766876714ae0",
        "type": "function",
        "z": "ca0982db8ee424ff",
        "name": "function 29",
        "func": "let data = msg.payload;\n\nif (typeof data === \"string\") {\n    try {\n        data = JSON.parse(data);\n    } catch (e) {\n        node.warn(\"Invalid JSON\");\n        return null;\n    }\n}\n\nmsg.bpm = { payload: data.bpm_mean };\nmsg.hrv = { payload: data.hrv_rmssd };\nmsg.zone = { payload: data.zone };\nmsg.quality = { payload: data.ecg_quality };\nmsg.rsp = { payload: data.ecg_rsp_mean };\n\nreturn [msg.bpm, msg.hrv, msg.zone, msg.quality, msg.rsp];\n",
        "outputs": 5,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 520,
        "wires": [
            [
                "4f6bb270c298345c",
                "9964fe063a2bcea8"
            ],
            [
                "f717a0f4049fa9a0"
            ],
            [
                "5fec24d020c48da1"
            ],
            [
                "a6519502f9853bf2"
            ],
            [
                "9069ddc40fe086ba"
            ]
        ]
    },
    {
        "id": "4f6bb270c298345c",
        "type": "ui_chart",
        "z": "ca0982db8ee424ff",
        "name": "",
        "group": "4d384bceafa49ebb",
        "order": 5,
        "width": 8,
        "height": 3,
        "label": "Heart Rate BPM",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 630,
        "y": 420,
        "wires": [
            []
        ]
    },
    {
        "id": "f717a0f4049fa9a0",
        "type": "ui_chart",
        "z": "ca0982db8ee424ff",
        "name": "",
        "group": "4d384bceafa49ebb",
        "order": 6,
        "width": 8,
        "height": 3,
        "label": "HRV (RMSSD)",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 630,
        "y": 500,
        "wires": [
            []
        ]
    },
    {
        "id": "5fec24d020c48da1",
        "type": "ui_template",
        "z": "ca0982db8ee424ff",
        "group": "4d384bceafa49ebb",
        "name": "tr zone",
        "order": 7,
        "width": 4,
        "height": 1,
        "format": "<div style=\"font-size: 20px; font-weight: bold;\">\n    Zone: {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 600,
        "y": 540,
        "wires": [
            []
        ]
    },
    {
        "id": "a6519502f9853bf2",
        "type": "ui_gauge",
        "z": "ca0982db8ee424ff",
        "name": "",
        "group": "4d384bceafa49ebb",
        "order": 3,
        "width": 2,
        "height": 3,
        "gtype": "compass",
        "title": "ECG Quality",
        "label": "units",
        "format": "{{value}}",
        "min": 0,
        "max": "1",
        "colors": [
            "#00b500",
            "#e6e600",
            "#ca3838"
        ],
        "seg1": "0.5",
        "seg2": "0.9",
        "diff": false,
        "className": "",
        "x": 620,
        "y": 580,
        "wires": []
    },
    {
        "id": "9069ddc40fe086ba",
        "type": "function",
        "z": "ca0982db8ee424ff",
        "name": "function 30",
        "func": "let rsp = parseFloat(msg.payload); // VERY IMPORTANT: force it to number\n\nlet breathingStatus = \"Unknown\";\nlet color = \"grey\";\n\nif (rsp > -3 && rsp < 3) {\n    breathingStatus = \"Normal Breathing\";\n    color = \"#4f97dc\";\n} else {\n    breathingStatus = \"Irregular Breathing\";\n    color = \"red\";\n}\n\nmsg.payload = breathingStatus;\nmsg.color = color;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 620,
        "y": 620,
        "wires": [
            [
                "f5c9760cbd06dfa0"
            ]
        ]
    },
    {
        "id": "f5c9760cbd06dfa0",
        "type": "ui_template",
        "z": "ca0982db8ee424ff",
        "group": "4d384bceafa49ebb",
        "name": "",
        "order": 8,
        "width": 4,
        "height": 1,
        "format": "<div ng-style=\"{\n    'font-size': '20px',\n    'font-weight': 'bold',\n    'text-align': 'center',\n    'color': msg.color\n}\">\n    {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 830,
        "y": 620,
        "wires": [
            []
        ]
    },
    {
        "id": "6658e85f39e30c3e",
        "type": "mqtt in",
        "z": "c6db48c0b253912f",
        "name": "",
        "topic": "ecg/device7/status",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 170,
        "y": 240,
        "wires": [
            [
                "f155d0f5a0af0597",
                "582faed4a08c86d4"
            ]
        ]
    },
    {
        "id": "82f0874a3ae560ff",
        "type": "function",
        "z": "c6db48c0b253912f",
        "name": "function 36",
        "func": "let ecg = msg.payload.ecg;\nlet sampleTs = msg.payload.sample_ts;\nlet startUtc = msg.payload.start_utc;\n\nif (ecg === undefined || sampleTs === undefined) return null;\n\n// Wenn start_utc enthalten ist, speichern\nif (startUtc !== undefined) {\n    global.set(\"ecg_start_utc\", startUtc);\n} else {\n    startUtc = global.get(\"ecg_start_utc\");\n    if (startUtc === undefined) return null; // noch keine gültige Zeitbasis\n}\n\n// UTC timestamp of this sample\nlet utcSample = startUtc + sampleTs / 1_000_000;\n\n// CSV line\nmsg.payload = utcSample.toFixed(6) + \",\" + ecg.toFixed(3) + \"\\n\";\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 490,
        "y": 60,
        "wires": [
            [
                "d031753169f49295"
            ]
        ]
    },
    {
        "id": "d031753169f49295",
        "type": "file",
        "z": "c6db48c0b253912f",
        "name": "",
        "filename": "C:\\Users\\Dima\\Desktop\\ecg_recording_device_07_V2.csv",
        "filenameType": "str",
        "appendNewline": false,
        "createDir": false,
        "overwriteFile": "false",
        "encoding": "utf8",
        "x": 850,
        "y": 60,
        "wires": [
            []
        ]
    },
    {
        "id": "eba1432ca77b46fe",
        "type": "mqtt in",
        "z": "c6db48c0b253912f",
        "name": "",
        "topic": "ecg/device7",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 150,
        "y": 160,
        "wires": [
            [
                "7da95ec0e4e6f586",
                "82f0874a3ae560ff"
            ]
        ]
    },
    {
        "id": "7da95ec0e4e6f586",
        "type": "function",
        "z": "c6db48c0b253912f",
        "name": "device name",
        "func": "msg.payload = msg.payload.device;  // Extract the \"device\" value\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 490,
        "y": 120,
        "wires": [
            []
        ]
    },
    {
        "id": "582faed4a08c86d4",
        "type": "function",
        "z": "c6db48c0b253912f",
        "name": "battery",
        "func": "if (msg.payload && msg.payload.battery !== undefined) {\n    msg.payload = msg.payload.battery;\n    return msg;\n} else {\n    return null;\n}\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 470,
        "y": 240,
        "wires": [
            [
                "3f8d2ba1a94070ae"
            ]
        ]
    },
    {
        "id": "f155d0f5a0af0597",
        "type": "function",
        "z": "c6db48c0b253912f",
        "name": "function 37",
        "func": "// Only run for status messages (not ECG samples)\nif (!msg.payload.hasOwnProperty(\"pads_connected\")) {\n    return null;\n}\n\nconst deviceId = msg.payload.device || \"ECG-10\";\nconst timeoutDuration = 30000 + 5000; // Status every 30s + small buffer\nconst timeoutKey = \"offline_timeout_\" + deviceId;\n\n// Cancel previous timeout\nconst prevTimeout = flow.get(timeoutKey);\nif (prevTimeout) {\n    clearTimeout(prevTimeout);\n}\n\n// Set new timeout → send Offline message if no new status received\nconst timeout = setTimeout(() => {\n    const offlineMsg = {\n        payload: \"Offline\",\n        color: \"gray\",\n        device: deviceId\n    };\n    node.send(offlineMsg);\n}, timeoutDuration);\nflow.set(timeoutKey, timeout);\n\n// Interpret pad connection status\nif (msg.payload.pads_connected === true) {\n    msg.payload = \"Connected\";\n    msg.color = \"#4f97dc\";\n} else if (msg.payload.pads_connected === false) {\n    msg.payload = \"Disconnected\";\n    msg.color = \"red\";\n} else {\n    msg.payload = \"Offline\";\n    msg.color = \"gray\";\n}\n\nmsg.device = deviceId;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 490,
        "y": 300,
        "wires": [
            [
                "9b48dcdc2bb1c3a9"
            ]
        ]
    },
    {
        "id": "9b48dcdc2bb1c3a9",
        "type": "ui_template",
        "z": "c6db48c0b253912f",
        "group": "2f508b19b8f431c8",
        "name": "",
        "order": 1,
        "width": 8,
        "height": 1,
        "format": "<div ng-style=\"{\n    'font-size': '20px',\n    'font-weight': 'bold',\n    'text-align': 'center',\n    'color': msg.color\n}\">\n    {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 720,
        "y": 300,
        "wires": [
            []
        ]
    },
    {
        "id": "3f8d2ba1a94070ae",
        "type": "ui_gauge",
        "z": "c6db48c0b253912f",
        "name": "",
        "group": "2f508b19b8f431c8",
        "order": 4,
        "width": 2,
        "height": 3,
        "gtype": "compass",
        "title": "Batterie (%)",
        "label": "%",
        "format": "{{msg.payload}}",
        "min": "0",
        "max": "100",
        "colors": [
            "#b50000",
            "#e6e600",
            "#00ff00"
        ],
        "seg1": "",
        "seg2": "",
        "diff": false,
        "className": "",
        "x": 730,
        "y": 240,
        "wires": []
    },
    {
        "id": "524b8c026983aed2",
        "type": "inject",
        "z": "c6db48c0b253912f",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "{   \"device\": \"ECG-10\",   \"msg_id\": 0,   \"pads_connected\": null,   \"seq\": 0,   \"ecg\": [],   \"ts\": [] }",
        "payloadType": "json",
        "x": 510,
        "y": 360,
        "wires": [
            [
                "f155d0f5a0af0597"
            ]
        ]
    },
    {
        "id": "8b8fcbd094dd626a",
        "type": "mqtt in",
        "z": "c6db48c0b253912f",
        "name": "",
        "topic": "processed/device7",
        "qos": "2",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 170,
        "y": 520,
        "wires": [
            [
                "94bba7ad03b34413"
            ]
        ]
    },
    {
        "id": "bd65157c84ef73f8",
        "type": "ui_text",
        "z": "c6db48c0b253912f",
        "group": "2f508b19b8f431c8",
        "order": 2,
        "width": 4,
        "height": 3,
        "name": "",
        "label": "BPM",
        "format": "{{msg.payload}}",
        "layout": "col-center",
        "className": "",
        "style": true,
        "font": "Georgia,Georgia,serif",
        "fontSize": "25",
        "color": "#1cb5ff",
        "x": 600,
        "y": 460,
        "wires": []
    },
    {
        "id": "94bba7ad03b34413",
        "type": "function",
        "z": "c6db48c0b253912f",
        "name": "function 38",
        "func": "let data = msg.payload;\n\nif (typeof data === \"string\") {\n    try {\n        data = JSON.parse(data);\n    } catch (e) {\n        node.warn(\"Invalid JSON\");\n        return null;\n    }\n}\n\nmsg.bpm = { payload: data.bpm_mean };\nmsg.hrv = { payload: data.hrv_rmssd };\nmsg.zone = { payload: data.zone };\nmsg.quality = { payload: data.ecg_quality };\nmsg.rsp = { payload: data.ecg_rsp_mean };\n\nreturn [msg.bpm, msg.hrv, msg.zone, msg.quality, msg.rsp];\n",
        "outputs": 5,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 520,
        "wires": [
            [
                "d705c2bd52c343e5",
                "bd65157c84ef73f8"
            ],
            [
                "8323ede9db1733e0"
            ],
            [
                "cdbdbb0ffed8bb73"
            ],
            [
                "77e0115c783a86f8"
            ],
            [
                "236826ede5ad29e1"
            ]
        ]
    },
    {
        "id": "d705c2bd52c343e5",
        "type": "ui_chart",
        "z": "c6db48c0b253912f",
        "name": "",
        "group": "2f508b19b8f431c8",
        "order": 5,
        "width": 8,
        "height": 3,
        "label": "Heart Rate BPM",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 630,
        "y": 420,
        "wires": [
            []
        ]
    },
    {
        "id": "8323ede9db1733e0",
        "type": "ui_chart",
        "z": "c6db48c0b253912f",
        "name": "",
        "group": "2f508b19b8f431c8",
        "order": 6,
        "width": 8,
        "height": 3,
        "label": "HRV (RMSSD)",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 630,
        "y": 500,
        "wires": [
            []
        ]
    },
    {
        "id": "cdbdbb0ffed8bb73",
        "type": "ui_template",
        "z": "c6db48c0b253912f",
        "group": "2f508b19b8f431c8",
        "name": "tr zone",
        "order": 7,
        "width": 4,
        "height": 1,
        "format": "<div style=\"font-size: 20px; font-weight: bold;\">\n    Zone: {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 600,
        "y": 540,
        "wires": [
            []
        ]
    },
    {
        "id": "77e0115c783a86f8",
        "type": "ui_gauge",
        "z": "c6db48c0b253912f",
        "name": "",
        "group": "2f508b19b8f431c8",
        "order": 3,
        "width": 2,
        "height": 3,
        "gtype": "compass",
        "title": "ECG Quality",
        "label": "units",
        "format": "{{value}}",
        "min": 0,
        "max": "1",
        "colors": [
            "#00b500",
            "#e6e600",
            "#ca3838"
        ],
        "seg1": "0.5",
        "seg2": "0.9",
        "diff": false,
        "className": "",
        "x": 620,
        "y": 580,
        "wires": []
    },
    {
        "id": "236826ede5ad29e1",
        "type": "function",
        "z": "c6db48c0b253912f",
        "name": "function 39",
        "func": "let rsp = parseFloat(msg.payload); // VERY IMPORTANT: force it to number\n\nlet breathingStatus = \"Unknown\";\nlet color = \"grey\";\n\nif (rsp > -3 && rsp < 3) {\n    breathingStatus = \"Normal Breathing\";\n    color = \"#4f97dc\";\n} else {\n    breathingStatus = \"Irregular Breathing\";\n    color = \"red\";\n}\n\nmsg.payload = breathingStatus;\nmsg.color = color;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 620,
        "y": 620,
        "wires": [
            [
                "6d93cf3f479d3c05"
            ]
        ]
    },
    {
        "id": "6d93cf3f479d3c05",
        "type": "ui_template",
        "z": "c6db48c0b253912f",
        "group": "2f508b19b8f431c8",
        "name": "",
        "order": 8,
        "width": 4,
        "height": 1,
        "format": "<div ng-style=\"{\n    'font-size': '20px',\n    'font-weight': 'bold',\n    'text-align': 'center',\n    'color': msg.color\n}\">\n    {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 830,
        "y": 620,
        "wires": [
            []
        ]
    },
    {
        "id": "e1071cace94c19d1",
        "type": "mqtt in",
        "z": "6a1b1482a6bee560",
        "name": "",
        "topic": "ecg/device6/status",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 150,
        "y": 260,
        "wires": [
            [
                "345ed23cbd5ea8e7",
                "c2ede43681257987"
            ]
        ]
    },
    {
        "id": "8cb2700bae4742ab",
        "type": "function",
        "z": "6a1b1482a6bee560",
        "name": "function 44",
        "func": "let ecg = msg.payload.ecg;\nlet sampleTs = msg.payload.sample_ts;\nlet startUtc = msg.payload.start_utc;\n\nif (ecg === undefined || sampleTs === undefined) return null;\n\n// Wenn start_utc enthalten ist, speichern\nif (startUtc !== undefined) {\n    global.set(\"ecg_start_utc\", startUtc);\n} else {\n    startUtc = global.get(\"ecg_start_utc\");\n    if (startUtc === undefined) return null; // noch keine gültige Zeitbasis\n}\n\n// UTC timestamp of this sample\nlet utcSample = startUtc + sampleTs / 1_000_000;\n\n// CSV line\nmsg.payload = utcSample.toFixed(6) + \",\" + ecg.toFixed(3) + \"\\n\";\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 470,
        "y": 80,
        "wires": [
            [
                "e81c3c355a7a596a"
            ]
        ]
    },
    {
        "id": "e81c3c355a7a596a",
        "type": "file",
        "z": "6a1b1482a6bee560",
        "name": "",
        "filename": "C:\\Users\\Dima\\Desktop\\ecg_recording_device_06_V2.csv",
        "filenameType": "str",
        "appendNewline": false,
        "createDir": false,
        "overwriteFile": "false",
        "encoding": "utf8",
        "x": 830,
        "y": 80,
        "wires": [
            []
        ]
    },
    {
        "id": "090ba618442e8a13",
        "type": "mqtt in",
        "z": "6a1b1482a6bee560",
        "name": "",
        "topic": "ecg/device6",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 130,
        "y": 180,
        "wires": [
            [
                "6d5c43a15a4512c8",
                "8cb2700bae4742ab"
            ]
        ]
    },
    {
        "id": "6d5c43a15a4512c8",
        "type": "function",
        "z": "6a1b1482a6bee560",
        "name": "device name",
        "func": "msg.payload = msg.payload.device;  // Extract the \"device\" value\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 470,
        "y": 140,
        "wires": [
            []
        ]
    },
    {
        "id": "c2ede43681257987",
        "type": "function",
        "z": "6a1b1482a6bee560",
        "name": "battery",
        "func": "if (msg.payload && msg.payload.battery !== undefined) {\n    msg.payload = msg.payload.battery;\n    return msg;\n} else {\n    return null;\n}\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 450,
        "y": 260,
        "wires": [
            [
                "810190da3743bbab"
            ]
        ]
    },
    {
        "id": "345ed23cbd5ea8e7",
        "type": "function",
        "z": "6a1b1482a6bee560",
        "name": "function 45",
        "func": "// Only run for status messages (not ECG samples)\nif (!msg.payload.hasOwnProperty(\"pads_connected\")) {\n    return null;\n}\n\nconst deviceId = msg.payload.device || \"ECG-10\";\nconst timeoutDuration = 30000 + 5000; // Status every 30s + small buffer\nconst timeoutKey = \"offline_timeout_\" + deviceId;\n\n// Cancel previous timeout\nconst prevTimeout = flow.get(timeoutKey);\nif (prevTimeout) {\n    clearTimeout(prevTimeout);\n}\n\n// Set new timeout → send Offline message if no new status received\nconst timeout = setTimeout(() => {\n    const offlineMsg = {\n        payload: \"Offline\",\n        color: \"gray\",\n        device: deviceId\n    };\n    node.send(offlineMsg);\n}, timeoutDuration);\nflow.set(timeoutKey, timeout);\n\n// Interpret pad connection status\nif (msg.payload.pads_connected === true) {\n    msg.payload = \"Connected\";\n    msg.color = \"#4f97dc\";\n} else if (msg.payload.pads_connected === false) {\n    msg.payload = \"Disconnected\";\n    msg.color = \"red\";\n} else {\n    msg.payload = \"Offline\";\n    msg.color = \"gray\";\n}\n\nmsg.device = deviceId;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 470,
        "y": 320,
        "wires": [
            [
                "c26b768afe84344e"
            ]
        ]
    },
    {
        "id": "c26b768afe84344e",
        "type": "ui_template",
        "z": "6a1b1482a6bee560",
        "group": "2d1c0cb4dc73a047",
        "name": "",
        "order": 1,
        "width": 8,
        "height": 1,
        "format": "<div ng-style=\"{\n    'font-size': '20px',\n    'font-weight': 'bold',\n    'text-align': 'center',\n    'color': msg.color\n}\">\n    {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 700,
        "y": 320,
        "wires": [
            []
        ]
    },
    {
        "id": "810190da3743bbab",
        "type": "ui_gauge",
        "z": "6a1b1482a6bee560",
        "name": "",
        "group": "2d1c0cb4dc73a047",
        "order": 4,
        "width": 2,
        "height": 3,
        "gtype": "compass",
        "title": "Batterie (%)",
        "label": "%",
        "format": "{{msg.payload}}",
        "min": "0",
        "max": "100",
        "colors": [
            "#b50000",
            "#e6e600",
            "#00ff00"
        ],
        "seg1": "",
        "seg2": "",
        "diff": false,
        "className": "",
        "x": 710,
        "y": 260,
        "wires": []
    },
    {
        "id": "8c4998cd535f824b",
        "type": "inject",
        "z": "6a1b1482a6bee560",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "{   \"device\": \"ECG-10\",   \"msg_id\": 0,   \"pads_connected\": null,   \"seq\": 0,   \"ecg\": [],   \"ts\": [] }",
        "payloadType": "json",
        "x": 490,
        "y": 380,
        "wires": [
            [
                "345ed23cbd5ea8e7"
            ]
        ]
    },
    {
        "id": "e484763092b1f8e6",
        "type": "mqtt in",
        "z": "6a1b1482a6bee560",
        "name": "",
        "topic": "processed/device6",
        "qos": "2",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 150,
        "y": 540,
        "wires": [
            [
                "4f016abd91b09f8b"
            ]
        ]
    },
    {
        "id": "38d19bb80f24cf8a",
        "type": "ui_text",
        "z": "6a1b1482a6bee560",
        "group": "2d1c0cb4dc73a047",
        "order": 2,
        "width": 4,
        "height": 3,
        "name": "",
        "label": "BPM",
        "format": "{{msg.payload}}",
        "layout": "col-center",
        "className": "",
        "style": true,
        "font": "Georgia,Georgia,serif",
        "fontSize": "25",
        "color": "#1cb5ff",
        "x": 580,
        "y": 480,
        "wires": []
    },
    {
        "id": "4f016abd91b09f8b",
        "type": "function",
        "z": "6a1b1482a6bee560",
        "name": "function 46",
        "func": "let data = msg.payload;\n\nif (typeof data === \"string\") {\n    try {\n        data = JSON.parse(data);\n    } catch (e) {\n        node.warn(\"Invalid JSON\");\n        return null;\n    }\n}\n\nmsg.bpm = { payload: data.bpm_mean };\nmsg.hrv = { payload: data.hrv_rmssd };\nmsg.zone = { payload: data.zone };\nmsg.quality = { payload: data.ecg_quality };\nmsg.rsp = { payload: data.ecg_rsp_mean };\n\nreturn [msg.bpm, msg.hrv, msg.zone, msg.quality, msg.rsp];\n",
        "outputs": 5,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 360,
        "y": 540,
        "wires": [
            [
                "a51894b2b614cd86",
                "38d19bb80f24cf8a"
            ],
            [
                "b56a46382bb0b3df"
            ],
            [
                "ad5f5cd1c6e5148f"
            ],
            [
                "ceab8dc26cf73595"
            ],
            [
                "10c221b4fb9a4ef3"
            ]
        ]
    },
    {
        "id": "a51894b2b614cd86",
        "type": "ui_chart",
        "z": "6a1b1482a6bee560",
        "name": "",
        "group": "2d1c0cb4dc73a047",
        "order": 5,
        "width": 8,
        "height": 3,
        "label": "Heart Rate BPM",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 610,
        "y": 440,
        "wires": [
            []
        ]
    },
    {
        "id": "b56a46382bb0b3df",
        "type": "ui_chart",
        "z": "6a1b1482a6bee560",
        "name": "",
        "group": "2d1c0cb4dc73a047",
        "order": 6,
        "width": 8,
        "height": 3,
        "label": "HRV (RMSSD)",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 610,
        "y": 520,
        "wires": [
            []
        ]
    },
    {
        "id": "ad5f5cd1c6e5148f",
        "type": "ui_template",
        "z": "6a1b1482a6bee560",
        "group": "2d1c0cb4dc73a047",
        "name": "tr zone",
        "order": 7,
        "width": 4,
        "height": 1,
        "format": "<div style=\"font-size: 20px; font-weight: bold;\">\n    Zone: {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 580,
        "y": 560,
        "wires": [
            []
        ]
    },
    {
        "id": "ceab8dc26cf73595",
        "type": "ui_gauge",
        "z": "6a1b1482a6bee560",
        "name": "",
        "group": "2d1c0cb4dc73a047",
        "order": 3,
        "width": 2,
        "height": 3,
        "gtype": "compass",
        "title": "ECG Quality",
        "label": "units",
        "format": "{{value}}",
        "min": 0,
        "max": "1",
        "colors": [
            "#00b500",
            "#e6e600",
            "#ca3838"
        ],
        "seg1": "0.5",
        "seg2": "0.9",
        "diff": false,
        "className": "",
        "x": 600,
        "y": 600,
        "wires": []
    },
    {
        "id": "10c221b4fb9a4ef3",
        "type": "function",
        "z": "6a1b1482a6bee560",
        "name": "function 47",
        "func": "let rsp = parseFloat(msg.payload); // VERY IMPORTANT: force it to number\n\nlet breathingStatus = \"Unknown\";\nlet color = \"grey\";\n\nif (rsp > -3 && rsp < 3) {\n    breathingStatus = \"Normal Breathing\";\n    color = \"#4f97dc\";\n} else {\n    breathingStatus = \"Irregular Breathing\";\n    color = \"red\";\n}\n\nmsg.payload = breathingStatus;\nmsg.color = color;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 600,
        "y": 640,
        "wires": [
            [
                "c937a777c8defa90"
            ]
        ]
    },
    {
        "id": "c937a777c8defa90",
        "type": "ui_template",
        "z": "6a1b1482a6bee560",
        "group": "2d1c0cb4dc73a047",
        "name": "",
        "order": 8,
        "width": 4,
        "height": 1,
        "format": "<div ng-style=\"{\n    'font-size': '20px',\n    'font-weight': 'bold',\n    'text-align': 'center',\n    'color': msg.color\n}\">\n    {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 810,
        "y": 640,
        "wires": [
            []
        ]
    },
    {
        "id": "e6799b599e6e9b25",
        "type": "mqtt in",
        "z": "7bd2bc9737c4c53d",
        "name": "",
        "topic": "ecg/device1/status",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 170,
        "y": 220,
        "wires": [
            [
                "775ae32389c832cd",
                "674a49962dff77a6"
            ]
        ]
    },
    {
        "id": "3b9db6d916c2811f",
        "type": "function",
        "z": "7bd2bc9737c4c53d",
        "name": "function 72",
        "func": "let ecg = msg.payload.ecg;\nlet sampleTs = msg.payload.sample_ts;\nlet startUtc = msg.payload.start_utc;\n\nif (ecg === undefined || sampleTs === undefined) return null;\n\n// Wenn start_utc enthalten ist, speichern\nif (startUtc !== undefined) {\n    global.set(\"ecg_start_utc\", startUtc);\n} else {\n    startUtc = global.get(\"ecg_start_utc\");\n    if (startUtc === undefined) return null; // noch keine gültige Zeitbasis\n}\n\n// UTC timestamp of this sample\nlet utcSample = startUtc + sampleTs / 1_000_000;\n\n// CSV line\nmsg.payload = utcSample.toFixed(6) + \",\" + ecg.toFixed(3) + \"\\n\";\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 490,
        "y": 40,
        "wires": [
            [
                "2a3e1e14617c137c"
            ]
        ]
    },
    {
        "id": "2a3e1e14617c137c",
        "type": "file",
        "z": "7bd2bc9737c4c53d",
        "name": "",
        "filename": "C:\\Users\\Dima\\Desktop\\ecg_recording_device_01_V2.csv",
        "filenameType": "str",
        "appendNewline": false,
        "createDir": false,
        "overwriteFile": "false",
        "encoding": "utf8",
        "x": 850,
        "y": 40,
        "wires": [
            []
        ]
    },
    {
        "id": "8144ca4078b1656a",
        "type": "mqtt in",
        "z": "7bd2bc9737c4c53d",
        "name": "",
        "topic": "ecg/device1",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 150,
        "y": 140,
        "wires": [
            [
                "441ce7b60bd16ee6",
                "3b9db6d916c2811f"
            ]
        ]
    },
    {
        "id": "441ce7b60bd16ee6",
        "type": "function",
        "z": "7bd2bc9737c4c53d",
        "name": "device name",
        "func": "msg.payload = msg.payload.device;  // Extract the \"device\" value\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 490,
        "y": 100,
        "wires": [
            []
        ]
    },
    {
        "id": "674a49962dff77a6",
        "type": "function",
        "z": "7bd2bc9737c4c53d",
        "name": "battery",
        "func": "if (msg.payload && msg.payload.battery !== undefined) {\n    msg.payload = msg.payload.battery;\n    return msg;\n} else {\n    return null;\n}\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 470,
        "y": 220,
        "wires": [
            [
                "2345881a23753888"
            ]
        ]
    },
    {
        "id": "775ae32389c832cd",
        "type": "function",
        "z": "7bd2bc9737c4c53d",
        "name": "function 73",
        "func": "// Only run for status messages (not ECG samples)\nif (!msg.payload.hasOwnProperty(\"pads_connected\")) {\n    return null;\n}\n\nconst deviceId = msg.payload.device || \"ECG-10\";\nconst timeoutDuration = 30000 + 5000; // Status every 30s + small buffer\nconst timeoutKey = \"offline_timeout_\" + deviceId;\n\n// Cancel previous timeout\nconst prevTimeout = flow.get(timeoutKey);\nif (prevTimeout) {\n    clearTimeout(prevTimeout);\n}\n\n// Set new timeout → send Offline message if no new status received\nconst timeout = setTimeout(() => {\n    const offlineMsg = {\n        payload: \"Offline\",\n        color: \"gray\",\n        device: deviceId\n    };\n    node.send(offlineMsg);\n}, timeoutDuration);\nflow.set(timeoutKey, timeout);\n\n// Interpret pad connection status\nif (msg.payload.pads_connected === true) {\n    msg.payload = \"Connected\";\n    msg.color = \"#4f97dc\";\n} else if (msg.payload.pads_connected === false) {\n    msg.payload = \"Disconnected\";\n    msg.color = \"red\";\n} else {\n    msg.payload = \"Offline\";\n    msg.color = \"gray\";\n}\n\nmsg.device = deviceId;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 490,
        "y": 280,
        "wires": [
            [
                "88e82fb91b2003f6"
            ]
        ]
    },
    {
        "id": "88e82fb91b2003f6",
        "type": "ui_template",
        "z": "7bd2bc9737c4c53d",
        "group": "0e178414fb6a25a3",
        "name": "",
        "order": 1,
        "width": 8,
        "height": 1,
        "format": "<div ng-style=\"{\n    'font-size': '20px',\n    'font-weight': 'bold',\n    'text-align': 'center',\n    'color': msg.color\n}\">\n    {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 720,
        "y": 280,
        "wires": [
            []
        ]
    },
    {
        "id": "2345881a23753888",
        "type": "ui_gauge",
        "z": "7bd2bc9737c4c53d",
        "name": "",
        "group": "0e178414fb6a25a3",
        "order": 4,
        "width": 2,
        "height": 3,
        "gtype": "compass",
        "title": "Batterie (%)",
        "label": "%",
        "format": "{{msg.payload}}",
        "min": "0",
        "max": "100",
        "colors": [
            "#b50000",
            "#e6e600",
            "#00ff00"
        ],
        "seg1": "",
        "seg2": "",
        "diff": false,
        "className": "",
        "x": 730,
        "y": 220,
        "wires": []
    },
    {
        "id": "97fb1764bf2b92d7",
        "type": "inject",
        "z": "7bd2bc9737c4c53d",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "{   \"device\": \"ECG-10\",   \"msg_id\": 0,   \"pads_connected\": null,   \"seq\": 0,   \"ecg\": [],   \"ts\": [] }",
        "payloadType": "json",
        "x": 510,
        "y": 340,
        "wires": [
            [
                "775ae32389c832cd"
            ]
        ]
    },
    {
        "id": "c0cf42fbf3d2e6b1",
        "type": "mqtt in",
        "z": "7bd2bc9737c4c53d",
        "name": "",
        "topic": "processed/device1",
        "qos": "2",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 170,
        "y": 500,
        "wires": [
            [
                "05e8f3e021e7b416"
            ]
        ]
    },
    {
        "id": "0df33baf09b8d3aa",
        "type": "ui_text",
        "z": "7bd2bc9737c4c53d",
        "group": "0e178414fb6a25a3",
        "order": 2,
        "width": 4,
        "height": 3,
        "name": "",
        "label": "BPM",
        "format": "{{msg.payload}}",
        "layout": "col-center",
        "className": "",
        "style": true,
        "font": "Georgia,Georgia,serif",
        "fontSize": "25",
        "color": "#1cb5ff",
        "x": 600,
        "y": 440,
        "wires": []
    },
    {
        "id": "05e8f3e021e7b416",
        "type": "function",
        "z": "7bd2bc9737c4c53d",
        "name": "function 74",
        "func": "let data = msg.payload;\n\nif (typeof data === \"string\") {\n    try {\n        data = JSON.parse(data);\n    } catch (e) {\n        node.warn(\"Invalid JSON\");\n        return null;\n    }\n}\n\nmsg.bpm = { payload: data.bpm_mean };\nmsg.hrv = { payload: data.hrv_rmssd };\nmsg.zone = { payload: data.zone };\nmsg.quality = { payload: data.ecg_quality };\nmsg.rsp = { payload: data.ecg_rsp_mean };\n\nreturn [msg.bpm, msg.hrv, msg.zone, msg.quality, msg.rsp];\n",
        "outputs": 5,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 500,
        "wires": [
            [
                "f421cd33e5c51eda",
                "0df33baf09b8d3aa"
            ],
            [
                "4b335acb5c4c9385"
            ],
            [
                "2133b7a36be568aa"
            ],
            [
                "3cee838219694630"
            ],
            [
                "ecdd7dac200dcf31"
            ]
        ]
    },
    {
        "id": "f421cd33e5c51eda",
        "type": "ui_chart",
        "z": "7bd2bc9737c4c53d",
        "name": "",
        "group": "0e178414fb6a25a3",
        "order": 5,
        "width": 8,
        "height": 3,
        "label": "Heart Rate BPM",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 630,
        "y": 400,
        "wires": [
            []
        ]
    },
    {
        "id": "4b335acb5c4c9385",
        "type": "ui_chart",
        "z": "7bd2bc9737c4c53d",
        "name": "",
        "group": "0e178414fb6a25a3",
        "order": 6,
        "width": 8,
        "height": 3,
        "label": "HRV (RMSSD)",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 630,
        "y": 480,
        "wires": [
            []
        ]
    },
    {
        "id": "2133b7a36be568aa",
        "type": "ui_template",
        "z": "7bd2bc9737c4c53d",
        "group": "0e178414fb6a25a3",
        "name": "tr zone",
        "order": 7,
        "width": 4,
        "height": 1,
        "format": "<div style=\"font-size: 20px; font-weight: bold;\">\n    Zone: {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 600,
        "y": 520,
        "wires": [
            []
        ]
    },
    {
        "id": "3cee838219694630",
        "type": "ui_gauge",
        "z": "7bd2bc9737c4c53d",
        "name": "",
        "group": "0e178414fb6a25a3",
        "order": 3,
        "width": 2,
        "height": 3,
        "gtype": "compass",
        "title": "ECG Quality",
        "label": "units",
        "format": "{{value}}",
        "min": 0,
        "max": "1",
        "colors": [
            "#00b500",
            "#e6e600",
            "#ca3838"
        ],
        "seg1": "0.5",
        "seg2": "0.9",
        "diff": false,
        "className": "",
        "x": 620,
        "y": 560,
        "wires": []
    },
    {
        "id": "ecdd7dac200dcf31",
        "type": "function",
        "z": "7bd2bc9737c4c53d",
        "name": "function 75",
        "func": "let rsp = parseFloat(msg.payload); // VERY IMPORTANT: force it to number\n\nlet breathingStatus = \"Unknown\";\nlet color = \"grey\";\n\nif (rsp > -3 && rsp < 3) {\n    breathingStatus = \"Normal Breathing\";\n    color = \"#4f97dc\";\n} else {\n    breathingStatus = \"Irregular Breathing\";\n    color = \"red\";\n}\n\nmsg.payload = breathingStatus;\nmsg.color = color;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 620,
        "y": 600,
        "wires": [
            [
                "7ade8f5a0659571a"
            ]
        ]
    },
    {
        "id": "7ade8f5a0659571a",
        "type": "ui_template",
        "z": "7bd2bc9737c4c53d",
        "group": "0e178414fb6a25a3",
        "name": "",
        "order": 8,
        "width": 4,
        "height": 1,
        "format": "<div ng-style=\"{\n    'font-size': '20px',\n    'font-weight': 'bold',\n    'text-align': 'center',\n    'color': msg.color\n}\">\n    {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 830,
        "y": 600,
        "wires": [
            []
        ]
    },
    {
        "id": "6f6a14809bb6ba8c",
        "type": "mqtt in",
        "z": "14ca00f39d79f827",
        "name": "",
        "topic": "ecg/device2/status",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 170,
        "y": 220,
        "wires": [
            [
                "053505fb2978c668",
                "bf9de0ca34e76992"
            ]
        ]
    },
    {
        "id": "f93b05adcc709087",
        "type": "function",
        "z": "14ca00f39d79f827",
        "name": "function 68",
        "func": "let ecg = msg.payload.ecg;\nlet sampleTs = msg.payload.sample_ts;\nlet startUtc = msg.payload.start_utc;\n\nif (ecg === undefined || sampleTs === undefined) return null;\n\n// Wenn start_utc enthalten ist, speichern\nif (startUtc !== undefined) {\n    global.set(\"ecg_start_utc\", startUtc);\n} else {\n    startUtc = global.get(\"ecg_start_utc\");\n    if (startUtc === undefined) return null; // noch keine gültige Zeitbasis\n}\n\n// UTC timestamp of this sample\nlet utcSample = startUtc + sampleTs / 1_000_000;\n\n// CSV line\nmsg.payload = utcSample.toFixed(6) + \",\" + ecg.toFixed(3) + \"\\n\";\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 490,
        "y": 40,
        "wires": [
            [
                "90d59c97f7c9aa4e"
            ]
        ]
    },
    {
        "id": "90d59c97f7c9aa4e",
        "type": "file",
        "z": "14ca00f39d79f827",
        "name": "",
        "filename": "C:\\Users\\Dima\\Desktop\\ecg_recording_device_02_V2.csv",
        "filenameType": "str",
        "appendNewline": false,
        "createDir": false,
        "overwriteFile": "false",
        "encoding": "utf8",
        "x": 850,
        "y": 40,
        "wires": [
            []
        ]
    },
    {
        "id": "9e2f80e85e67513d",
        "type": "mqtt in",
        "z": "14ca00f39d79f827",
        "name": "",
        "topic": "ecg/device2",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 150,
        "y": 140,
        "wires": [
            [
                "9601deb1b936744c",
                "f93b05adcc709087"
            ]
        ]
    },
    {
        "id": "9601deb1b936744c",
        "type": "function",
        "z": "14ca00f39d79f827",
        "name": "device name",
        "func": "msg.payload = msg.payload.device;  // Extract the \"device\" value\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 490,
        "y": 100,
        "wires": [
            []
        ]
    },
    {
        "id": "bf9de0ca34e76992",
        "type": "function",
        "z": "14ca00f39d79f827",
        "name": "battery",
        "func": "if (msg.payload && msg.payload.battery !== undefined) {\n    msg.payload = msg.payload.battery;\n    return msg;\n} else {\n    return null;\n}\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 470,
        "y": 220,
        "wires": [
            [
                "ed59743fd0e340b3"
            ]
        ]
    },
    {
        "id": "053505fb2978c668",
        "type": "function",
        "z": "14ca00f39d79f827",
        "name": "function 69",
        "func": "// Only run for status messages (not ECG samples)\nif (!msg.payload.hasOwnProperty(\"pads_connected\")) {\n    return null;\n}\n\nconst deviceId = msg.payload.device || \"ECG-10\";\nconst timeoutDuration = 30000 + 5000; // Status every 30s + small buffer\nconst timeoutKey = \"offline_timeout_\" + deviceId;\n\n// Cancel previous timeout\nconst prevTimeout = flow.get(timeoutKey);\nif (prevTimeout) {\n    clearTimeout(prevTimeout);\n}\n\n// Set new timeout → send Offline message if no new status received\nconst timeout = setTimeout(() => {\n    const offlineMsg = {\n        payload: \"Offline\",\n        color: \"gray\",\n        device: deviceId\n    };\n    node.send(offlineMsg);\n}, timeoutDuration);\nflow.set(timeoutKey, timeout);\n\n// Interpret pad connection status\nif (msg.payload.pads_connected === true) {\n    msg.payload = \"Connected\";\n    msg.color = \"#4f97dc\";\n} else if (msg.payload.pads_connected === false) {\n    msg.payload = \"Disconnected\";\n    msg.color = \"red\";\n} else {\n    msg.payload = \"Offline\";\n    msg.color = \"gray\";\n}\n\nmsg.device = deviceId;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 490,
        "y": 280,
        "wires": [
            [
                "3c844ac764c45f8f"
            ]
        ]
    },
    {
        "id": "3c844ac764c45f8f",
        "type": "ui_template",
        "z": "14ca00f39d79f827",
        "group": "67b6629d9e2271d3",
        "name": "",
        "order": 1,
        "width": 8,
        "height": 1,
        "format": "<div ng-style=\"{\n    'font-size': '20px',\n    'font-weight': 'bold',\n    'text-align': 'center',\n    'color': msg.color\n}\">\n    {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 720,
        "y": 280,
        "wires": [
            []
        ]
    },
    {
        "id": "ed59743fd0e340b3",
        "type": "ui_gauge",
        "z": "14ca00f39d79f827",
        "name": "",
        "group": "67b6629d9e2271d3",
        "order": 4,
        "width": 2,
        "height": 3,
        "gtype": "compass",
        "title": "Batterie (%)",
        "label": "%",
        "format": "{{msg.payload}}",
        "min": "0",
        "max": "100",
        "colors": [
            "#b50000",
            "#e6e600",
            "#00ff00"
        ],
        "seg1": "",
        "seg2": "",
        "diff": false,
        "className": "",
        "x": 730,
        "y": 220,
        "wires": []
    },
    {
        "id": "0262cbc75d22508e",
        "type": "inject",
        "z": "14ca00f39d79f827",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "{   \"device\": \"ECG-10\",   \"msg_id\": 0,   \"pads_connected\": null,   \"seq\": 0,   \"ecg\": [],   \"ts\": [] }",
        "payloadType": "json",
        "x": 510,
        "y": 340,
        "wires": [
            [
                "053505fb2978c668"
            ]
        ]
    },
    {
        "id": "81b763bcbd619fd9",
        "type": "mqtt in",
        "z": "14ca00f39d79f827",
        "name": "",
        "topic": "processed/device2",
        "qos": "2",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 170,
        "y": 500,
        "wires": [
            [
                "c2f57116a403c296"
            ]
        ]
    },
    {
        "id": "47cbe6ab1c6f7c3a",
        "type": "ui_text",
        "z": "14ca00f39d79f827",
        "group": "67b6629d9e2271d3",
        "order": 2,
        "width": 4,
        "height": 3,
        "name": "",
        "label": "BPM",
        "format": "{{msg.payload}}",
        "layout": "col-center",
        "className": "",
        "style": true,
        "font": "Georgia,Georgia,serif",
        "fontSize": "25",
        "color": "#1cb5ff",
        "x": 600,
        "y": 440,
        "wires": []
    },
    {
        "id": "c2f57116a403c296",
        "type": "function",
        "z": "14ca00f39d79f827",
        "name": "function 70",
        "func": "let data = msg.payload;\n\nif (typeof data === \"string\") {\n    try {\n        data = JSON.parse(data);\n    } catch (e) {\n        node.warn(\"Invalid JSON\");\n        return null;\n    }\n}\n\nmsg.bpm = { payload: data.bpm_mean };\nmsg.hrv = { payload: data.hrv_rmssd };\nmsg.zone = { payload: data.zone };\nmsg.quality = { payload: data.ecg_quality };\nmsg.rsp = { payload: data.ecg_rsp_mean };\n\nreturn [msg.bpm, msg.hrv, msg.zone, msg.quality, msg.rsp];\n",
        "outputs": 5,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 500,
        "wires": [
            [
                "6eb9b746518f3221",
                "47cbe6ab1c6f7c3a"
            ],
            [
                "2ee2a32c6d141e03"
            ],
            [
                "a059bb3938b3c3b0"
            ],
            [
                "73889180f85905d0"
            ],
            [
                "292adf629f4de267"
            ]
        ]
    },
    {
        "id": "6eb9b746518f3221",
        "type": "ui_chart",
        "z": "14ca00f39d79f827",
        "name": "",
        "group": "67b6629d9e2271d3",
        "order": 5,
        "width": 8,
        "height": 3,
        "label": "Heart Rate BPM",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 630,
        "y": 400,
        "wires": [
            []
        ]
    },
    {
        "id": "2ee2a32c6d141e03",
        "type": "ui_chart",
        "z": "14ca00f39d79f827",
        "name": "",
        "group": "67b6629d9e2271d3",
        "order": 6,
        "width": 8,
        "height": 3,
        "label": "HRV (RMSSD)",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 630,
        "y": 480,
        "wires": [
            []
        ]
    },
    {
        "id": "a059bb3938b3c3b0",
        "type": "ui_template",
        "z": "14ca00f39d79f827",
        "group": "67b6629d9e2271d3",
        "name": "tr zone",
        "order": 7,
        "width": 4,
        "height": 1,
        "format": "<div style=\"font-size: 20px; font-weight: bold;\">\n    Zone: {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 600,
        "y": 520,
        "wires": [
            []
        ]
    },
    {
        "id": "73889180f85905d0",
        "type": "ui_gauge",
        "z": "14ca00f39d79f827",
        "name": "",
        "group": "67b6629d9e2271d3",
        "order": 3,
        "width": 2,
        "height": 3,
        "gtype": "compass",
        "title": "ECG Quality",
        "label": "units",
        "format": "{{value}}",
        "min": 0,
        "max": "1",
        "colors": [
            "#00b500",
            "#e6e600",
            "#ca3838"
        ],
        "seg1": "0.5",
        "seg2": "0.9",
        "diff": false,
        "className": "",
        "x": 620,
        "y": 560,
        "wires": []
    },
    {
        "id": "292adf629f4de267",
        "type": "function",
        "z": "14ca00f39d79f827",
        "name": "function 71",
        "func": "let rsp = parseFloat(msg.payload); // VERY IMPORTANT: force it to number\n\nlet breathingStatus = \"Unknown\";\nlet color = \"grey\";\n\nif (rsp > -3 && rsp < 3) {\n    breathingStatus = \"Normal Breathing\";\n    color = \"#4f97dc\";\n} else {\n    breathingStatus = \"Irregular Breathing\";\n    color = \"red\";\n}\n\nmsg.payload = breathingStatus;\nmsg.color = color;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 620,
        "y": 600,
        "wires": [
            [
                "c60c745986941798"
            ]
        ]
    },
    {
        "id": "c60c745986941798",
        "type": "ui_template",
        "z": "14ca00f39d79f827",
        "group": "67b6629d9e2271d3",
        "name": "",
        "order": 8,
        "width": 4,
        "height": 1,
        "format": "<div ng-style=\"{\n    'font-size': '20px',\n    'font-weight': 'bold',\n    'text-align': 'center',\n    'color': msg.color\n}\">\n    {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 830,
        "y": 600,
        "wires": [
            []
        ]
    },
    {
        "id": "fae15b27de3944b7",
        "type": "mqtt in",
        "z": "2c4d072efbeedd02",
        "name": "",
        "topic": "ecg/device3/status",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 170,
        "y": 240,
        "wires": [
            [
                "b0e8144b6e893fa9",
                "5dd543c63ea57487"
            ]
        ]
    },
    {
        "id": "bdf0823696fc1f4f",
        "type": "function",
        "z": "2c4d072efbeedd02",
        "name": "function 64",
        "func": "let ecg = msg.payload.ecg;\nlet sampleTs = msg.payload.sample_ts;\nlet startUtc = msg.payload.start_utc;\n\nif (ecg === undefined || sampleTs === undefined) return null;\n\n// Wenn start_utc enthalten ist, speichern\nif (startUtc !== undefined) {\n    global.set(\"ecg_start_utc\", startUtc);\n} else {\n    startUtc = global.get(\"ecg_start_utc\");\n    if (startUtc === undefined) return null; // noch keine gültige Zeitbasis\n}\n\n// UTC timestamp of this sample\nlet utcSample = startUtc + sampleTs / 1_000_000;\n\n// CSV line\nmsg.payload = utcSample.toFixed(6) + \",\" + ecg.toFixed(3) + \"\\n\";\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 490,
        "y": 60,
        "wires": [
            [
                "87a1761f79e6864e"
            ]
        ]
    },
    {
        "id": "87a1761f79e6864e",
        "type": "file",
        "z": "2c4d072efbeedd02",
        "name": "",
        "filename": "C:\\Users\\Dima\\Desktop\\ecg_recording_device_03_V2.csv",
        "filenameType": "str",
        "appendNewline": false,
        "createDir": false,
        "overwriteFile": "false",
        "encoding": "utf8",
        "x": 850,
        "y": 60,
        "wires": [
            []
        ]
    },
    {
        "id": "cac87270efc09f74",
        "type": "mqtt in",
        "z": "2c4d072efbeedd02",
        "name": "",
        "topic": "ecg/device3",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 150,
        "y": 160,
        "wires": [
            [
                "f607ac14cbeebad7",
                "bdf0823696fc1f4f"
            ]
        ]
    },
    {
        "id": "f607ac14cbeebad7",
        "type": "function",
        "z": "2c4d072efbeedd02",
        "name": "device name",
        "func": "msg.payload = msg.payload.device;  // Extract the \"device\" value\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 490,
        "y": 120,
        "wires": [
            []
        ]
    },
    {
        "id": "5dd543c63ea57487",
        "type": "function",
        "z": "2c4d072efbeedd02",
        "name": "battery",
        "func": "if (msg.payload && msg.payload.battery !== undefined) {\n    msg.payload = msg.payload.battery;\n    return msg;\n} else {\n    return null;\n}\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 470,
        "y": 240,
        "wires": [
            [
                "1f34cbc651b7d45c"
            ]
        ]
    },
    {
        "id": "b0e8144b6e893fa9",
        "type": "function",
        "z": "2c4d072efbeedd02",
        "name": "function 65",
        "func": "// Only run for status messages (not ECG samples)\nif (!msg.payload.hasOwnProperty(\"pads_connected\")) {\n    return null;\n}\n\nconst deviceId = msg.payload.device || \"ECG-10\";\nconst timeoutDuration = 30000 + 5000; // Status every 30s + small buffer\nconst timeoutKey = \"offline_timeout_\" + deviceId;\n\n// Cancel previous timeout\nconst prevTimeout = flow.get(timeoutKey);\nif (prevTimeout) {\n    clearTimeout(prevTimeout);\n}\n\n// Set new timeout → send Offline message if no new status received\nconst timeout = setTimeout(() => {\n    const offlineMsg = {\n        payload: \"Offline\",\n        color: \"gray\",\n        device: deviceId\n    };\n    node.send(offlineMsg);\n}, timeoutDuration);\nflow.set(timeoutKey, timeout);\n\n// Interpret pad connection status\nif (msg.payload.pads_connected === true) {\n    msg.payload = \"Connected\";\n    msg.color = \"#4f97dc\";\n} else if (msg.payload.pads_connected === false) {\n    msg.payload = \"Disconnected\";\n    msg.color = \"red\";\n} else {\n    msg.payload = \"Offline\";\n    msg.color = \"gray\";\n}\n\nmsg.device = deviceId;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 490,
        "y": 300,
        "wires": [
            [
                "7fdc1c21bec7d7ad"
            ]
        ]
    },
    {
        "id": "7fdc1c21bec7d7ad",
        "type": "ui_template",
        "z": "2c4d072efbeedd02",
        "group": "29ef880878824cd1",
        "name": "",
        "order": 1,
        "width": 8,
        "height": 1,
        "format": "<div ng-style=\"{\n    'font-size': '20px',\n    'font-weight': 'bold',\n    'text-align': 'center',\n    'color': msg.color\n}\">\n    {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 720,
        "y": 300,
        "wires": [
            []
        ]
    },
    {
        "id": "1f34cbc651b7d45c",
        "type": "ui_gauge",
        "z": "2c4d072efbeedd02",
        "name": "",
        "group": "29ef880878824cd1",
        "order": 4,
        "width": 2,
        "height": 3,
        "gtype": "compass",
        "title": "Batterie (%)",
        "label": "%",
        "format": "{{msg.payload}}",
        "min": "0",
        "max": "100",
        "colors": [
            "#b50000",
            "#e6e600",
            "#00ff00"
        ],
        "seg1": "",
        "seg2": "",
        "diff": false,
        "className": "",
        "x": 730,
        "y": 240,
        "wires": []
    },
    {
        "id": "32c8db30c262d4ed",
        "type": "inject",
        "z": "2c4d072efbeedd02",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "{   \"device\": \"ECG-10\",   \"msg_id\": 0,   \"pads_connected\": null,   \"seq\": 0,   \"ecg\": [],   \"ts\": [] }",
        "payloadType": "json",
        "x": 510,
        "y": 360,
        "wires": [
            [
                "b0e8144b6e893fa9"
            ]
        ]
    },
    {
        "id": "e822c853f792501e",
        "type": "mqtt in",
        "z": "2c4d072efbeedd02",
        "name": "",
        "topic": "processed/device3",
        "qos": "2",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 170,
        "y": 520,
        "wires": [
            [
                "bfd711b9c5e0db11"
            ]
        ]
    },
    {
        "id": "8382ab6660a00ca4",
        "type": "ui_text",
        "z": "2c4d072efbeedd02",
        "group": "29ef880878824cd1",
        "order": 2,
        "width": 4,
        "height": 3,
        "name": "",
        "label": "BPM",
        "format": "{{msg.payload}}",
        "layout": "col-center",
        "className": "",
        "style": true,
        "font": "Georgia,Georgia,serif",
        "fontSize": "25",
        "color": "#1cb5ff",
        "x": 600,
        "y": 460,
        "wires": []
    },
    {
        "id": "bfd711b9c5e0db11",
        "type": "function",
        "z": "2c4d072efbeedd02",
        "name": "function 66",
        "func": "let data = msg.payload;\n\nif (typeof data === \"string\") {\n    try {\n        data = JSON.parse(data);\n    } catch (e) {\n        node.warn(\"Invalid JSON\");\n        return null;\n    }\n}\n\nmsg.bpm = { payload: data.bpm_mean };\nmsg.hrv = { payload: data.hrv_rmssd };\nmsg.zone = { payload: data.zone };\nmsg.quality = { payload: data.ecg_quality };\nmsg.rsp = { payload: data.ecg_rsp_mean };\n\nreturn [msg.bpm, msg.hrv, msg.zone, msg.quality, msg.rsp];\n",
        "outputs": 5,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 520,
        "wires": [
            [
                "ed3c2b2438d0a913",
                "8382ab6660a00ca4"
            ],
            [
                "daa17d9b78928726"
            ],
            [
                "a72bf580ac7d2c6c"
            ],
            [
                "99c1f7e950668473"
            ],
            [
                "83cfddc07352b94a"
            ]
        ]
    },
    {
        "id": "ed3c2b2438d0a913",
        "type": "ui_chart",
        "z": "2c4d072efbeedd02",
        "name": "",
        "group": "29ef880878824cd1",
        "order": 5,
        "width": 8,
        "height": 3,
        "label": "Heart Rate BPM",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 630,
        "y": 420,
        "wires": [
            []
        ]
    },
    {
        "id": "daa17d9b78928726",
        "type": "ui_chart",
        "z": "2c4d072efbeedd02",
        "name": "",
        "group": "29ef880878824cd1",
        "order": 6,
        "width": 8,
        "height": 3,
        "label": "HRV (RMSSD)",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 630,
        "y": 500,
        "wires": [
            []
        ]
    },
    {
        "id": "a72bf580ac7d2c6c",
        "type": "ui_template",
        "z": "2c4d072efbeedd02",
        "group": "29ef880878824cd1",
        "name": "tr zone",
        "order": 7,
        "width": 4,
        "height": 1,
        "format": "<div style=\"font-size: 20px; font-weight: bold;\">\n    Zone: {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 600,
        "y": 540,
        "wires": [
            []
        ]
    },
    {
        "id": "99c1f7e950668473",
        "type": "ui_gauge",
        "z": "2c4d072efbeedd02",
        "name": "",
        "group": "29ef880878824cd1",
        "order": 3,
        "width": 2,
        "height": 3,
        "gtype": "compass",
        "title": "ECG Quality",
        "label": "units",
        "format": "{{value}}",
        "min": 0,
        "max": "1",
        "colors": [
            "#00b500",
            "#e6e600",
            "#ca3838"
        ],
        "seg1": "0.5",
        "seg2": "0.9",
        "diff": false,
        "className": "",
        "x": 620,
        "y": 580,
        "wires": []
    },
    {
        "id": "83cfddc07352b94a",
        "type": "function",
        "z": "2c4d072efbeedd02",
        "name": "function 67",
        "func": "let rsp = parseFloat(msg.payload); // VERY IMPORTANT: force it to number\n\nlet breathingStatus = \"Unknown\";\nlet color = \"grey\";\n\nif (rsp > -3 && rsp < 3) {\n    breathingStatus = \"Normal Breathing\";\n    color = \"#4f97dc\";\n} else {\n    breathingStatus = \"Irregular Breathing\";\n    color = \"red\";\n}\n\nmsg.payload = breathingStatus;\nmsg.color = color;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 620,
        "y": 620,
        "wires": [
            [
                "74bb4f01c3f54367"
            ]
        ]
    },
    {
        "id": "74bb4f01c3f54367",
        "type": "ui_template",
        "z": "2c4d072efbeedd02",
        "group": "29ef880878824cd1",
        "name": "",
        "order": 8,
        "width": 4,
        "height": 1,
        "format": "<div ng-style=\"{\n    'font-size': '20px',\n    'font-weight': 'bold',\n    'text-align': 'center',\n    'color': msg.color\n}\">\n    {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 830,
        "y": 620,
        "wires": [
            []
        ]
    },
    {
        "id": "b2ca1a8304518ebf",
        "type": "mqtt in",
        "z": "e126b4dd60b37ea7",
        "name": "",
        "topic": "ecg/device4/status",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 130,
        "y": 240,
        "wires": [
            [
                "71c19903dfb147d2",
                "e4610110d4f4c5d6"
            ]
        ]
    },
    {
        "id": "fce91f1205494929",
        "type": "function",
        "z": "e126b4dd60b37ea7",
        "name": "function 60",
        "func": "let ecg = msg.payload.ecg;\nlet sampleTs = msg.payload.sample_ts;\nlet startUtc = msg.payload.start_utc;\n\nif (ecg === undefined || sampleTs === undefined) return null;\n\n// Wenn start_utc enthalten ist, speichern\nif (startUtc !== undefined) {\n    global.set(\"ecg_start_utc\", startUtc);\n} else {\n    startUtc = global.get(\"ecg_start_utc\");\n    if (startUtc === undefined) return null; // noch keine gültige Zeitbasis\n}\n\n// UTC timestamp of this sample\nlet utcSample = startUtc + sampleTs / 1_000_000;\n\n// CSV line\nmsg.payload = utcSample.toFixed(6) + \",\" + ecg.toFixed(3) + \"\\n\";\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 450,
        "y": 60,
        "wires": [
            [
                "484f2b15529dc2b0"
            ]
        ]
    },
    {
        "id": "484f2b15529dc2b0",
        "type": "file",
        "z": "e126b4dd60b37ea7",
        "name": "",
        "filename": "C:\\Users\\Dima\\Desktop\\ecg_recording_device_04_V2.csv",
        "filenameType": "str",
        "appendNewline": false,
        "createDir": false,
        "overwriteFile": "false",
        "encoding": "utf8",
        "x": 810,
        "y": 60,
        "wires": [
            []
        ]
    },
    {
        "id": "48245c819d0516f4",
        "type": "mqtt in",
        "z": "e126b4dd60b37ea7",
        "name": "",
        "topic": "ecg/device4",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 110,
        "y": 160,
        "wires": [
            [
                "b0688c8e540c7564",
                "fce91f1205494929"
            ]
        ]
    },
    {
        "id": "b0688c8e540c7564",
        "type": "function",
        "z": "e126b4dd60b37ea7",
        "name": "device name",
        "func": "msg.payload = msg.payload.device;  // Extract the \"device\" value\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 450,
        "y": 120,
        "wires": [
            []
        ]
    },
    {
        "id": "e4610110d4f4c5d6",
        "type": "function",
        "z": "e126b4dd60b37ea7",
        "name": "battery",
        "func": "if (msg.payload && msg.payload.battery !== undefined) {\n    msg.payload = msg.payload.battery;\n    return msg;\n} else {\n    return null;\n}\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 430,
        "y": 240,
        "wires": [
            [
                "8d5ae3253cdab725"
            ]
        ]
    },
    {
        "id": "71c19903dfb147d2",
        "type": "function",
        "z": "e126b4dd60b37ea7",
        "name": "function 61",
        "func": "// Only run for status messages (not ECG samples)\nif (!msg.payload.hasOwnProperty(\"pads_connected\")) {\n    return null;\n}\n\nconst deviceId = msg.payload.device || \"ECG-10\";\nconst timeoutDuration = 30000 + 5000; // Status every 30s + small buffer\nconst timeoutKey = \"offline_timeout_\" + deviceId;\n\n// Cancel previous timeout\nconst prevTimeout = flow.get(timeoutKey);\nif (prevTimeout) {\n    clearTimeout(prevTimeout);\n}\n\n// Set new timeout → send Offline message if no new status received\nconst timeout = setTimeout(() => {\n    const offlineMsg = {\n        payload: \"Offline\",\n        color: \"gray\",\n        device: deviceId\n    };\n    node.send(offlineMsg);\n}, timeoutDuration);\nflow.set(timeoutKey, timeout);\n\n// Interpret pad connection status\nif (msg.payload.pads_connected === true) {\n    msg.payload = \"Connected\";\n    msg.color = \"#4f97dc\";\n} else if (msg.payload.pads_connected === false) {\n    msg.payload = \"Disconnected\";\n    msg.color = \"red\";\n} else {\n    msg.payload = \"Offline\";\n    msg.color = \"gray\";\n}\n\nmsg.device = deviceId;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 450,
        "y": 300,
        "wires": [
            [
                "37c11e93e6cff9ac"
            ]
        ]
    },
    {
        "id": "37c11e93e6cff9ac",
        "type": "ui_template",
        "z": "e126b4dd60b37ea7",
        "group": "cd3dcd554c0939a7",
        "name": "",
        "order": 1,
        "width": 8,
        "height": 1,
        "format": "<div ng-style=\"{\n    'font-size': '20px',\n    'font-weight': 'bold',\n    'text-align': 'center',\n    'color': msg.color\n}\">\n    {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 680,
        "y": 300,
        "wires": [
            []
        ]
    },
    {
        "id": "8d5ae3253cdab725",
        "type": "ui_gauge",
        "z": "e126b4dd60b37ea7",
        "name": "",
        "group": "cd3dcd554c0939a7",
        "order": 4,
        "width": 2,
        "height": 3,
        "gtype": "compass",
        "title": "Batterie (%)",
        "label": "%",
        "format": "{{msg.payload}}",
        "min": "0",
        "max": "100",
        "colors": [
            "#b50000",
            "#e6e600",
            "#00ff00"
        ],
        "seg1": "",
        "seg2": "",
        "diff": false,
        "className": "",
        "x": 690,
        "y": 240,
        "wires": []
    },
    {
        "id": "b7564f51aa1bcf58",
        "type": "inject",
        "z": "e126b4dd60b37ea7",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "{   \"device\": \"ECG-10\",   \"msg_id\": 0,   \"pads_connected\": null,   \"seq\": 0,   \"ecg\": [],   \"ts\": [] }",
        "payloadType": "json",
        "x": 470,
        "y": 360,
        "wires": [
            [
                "71c19903dfb147d2"
            ]
        ]
    },
    {
        "id": "60fe94f76d091352",
        "type": "mqtt in",
        "z": "e126b4dd60b37ea7",
        "name": "",
        "topic": "processed/device4",
        "qos": "2",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 130,
        "y": 520,
        "wires": [
            [
                "fba87925189d8794"
            ]
        ]
    },
    {
        "id": "e68f40916caf40b0",
        "type": "ui_text",
        "z": "e126b4dd60b37ea7",
        "group": "cd3dcd554c0939a7",
        "order": 2,
        "width": 4,
        "height": 3,
        "name": "",
        "label": "BPM",
        "format": "{{msg.payload}}",
        "layout": "col-center",
        "className": "",
        "style": true,
        "font": "Georgia,Georgia,serif",
        "fontSize": "25",
        "color": "#1cb5ff",
        "x": 560,
        "y": 460,
        "wires": []
    },
    {
        "id": "fba87925189d8794",
        "type": "function",
        "z": "e126b4dd60b37ea7",
        "name": "function 62",
        "func": "let data = msg.payload;\n\nif (typeof data === \"string\") {\n    try {\n        data = JSON.parse(data);\n    } catch (e) {\n        node.warn(\"Invalid JSON\");\n        return null;\n    }\n}\n\nmsg.bpm = { payload: data.bpm_mean };\nmsg.hrv = { payload: data.hrv_rmssd };\nmsg.zone = { payload: data.zone };\nmsg.quality = { payload: data.ecg_quality };\nmsg.rsp = { payload: data.ecg_rsp_mean };\n\nreturn [msg.bpm, msg.hrv, msg.zone, msg.quality, msg.rsp];\n",
        "outputs": 5,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 340,
        "y": 520,
        "wires": [
            [
                "d8d239e1f10d6639",
                "e68f40916caf40b0"
            ],
            [
                "ca4e7c9ae2eb609b"
            ],
            [
                "ff22c4eb8d5dcc22"
            ],
            [
                "bbb9f4fd727e6775"
            ],
            [
                "40f055ccf356c540"
            ]
        ]
    },
    {
        "id": "d8d239e1f10d6639",
        "type": "ui_chart",
        "z": "e126b4dd60b37ea7",
        "name": "",
        "group": "cd3dcd554c0939a7",
        "order": 5,
        "width": 8,
        "height": 3,
        "label": "Heart Rate BPM",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 590,
        "y": 420,
        "wires": [
            []
        ]
    },
    {
        "id": "ca4e7c9ae2eb609b",
        "type": "ui_chart",
        "z": "e126b4dd60b37ea7",
        "name": "",
        "group": "cd3dcd554c0939a7",
        "order": 6,
        "width": 8,
        "height": 3,
        "label": "HRV (RMSSD)",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 590,
        "y": 500,
        "wires": [
            []
        ]
    },
    {
        "id": "ff22c4eb8d5dcc22",
        "type": "ui_template",
        "z": "e126b4dd60b37ea7",
        "group": "cd3dcd554c0939a7",
        "name": "tr zone",
        "order": 7,
        "width": 4,
        "height": 1,
        "format": "<div style=\"font-size: 20px; font-weight: bold;\">\n    Zone: {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 560,
        "y": 540,
        "wires": [
            []
        ]
    },
    {
        "id": "bbb9f4fd727e6775",
        "type": "ui_gauge",
        "z": "e126b4dd60b37ea7",
        "name": "",
        "group": "cd3dcd554c0939a7",
        "order": 3,
        "width": 2,
        "height": 3,
        "gtype": "compass",
        "title": "ECG Quality",
        "label": "units",
        "format": "{{value}}",
        "min": 0,
        "max": "1",
        "colors": [
            "#00b500",
            "#e6e600",
            "#ca3838"
        ],
        "seg1": "0.5",
        "seg2": "0.9",
        "diff": false,
        "className": "",
        "x": 580,
        "y": 580,
        "wires": []
    },
    {
        "id": "40f055ccf356c540",
        "type": "function",
        "z": "e126b4dd60b37ea7",
        "name": "function 63",
        "func": "let rsp = parseFloat(msg.payload); // VERY IMPORTANT: force it to number\n\nlet breathingStatus = \"Unknown\";\nlet color = \"grey\";\n\nif (rsp > -3 && rsp < 3) {\n    breathingStatus = \"Normal Breathing\";\n    color = \"#4f97dc\";\n} else {\n    breathingStatus = \"Irregular Breathing\";\n    color = \"red\";\n}\n\nmsg.payload = breathingStatus;\nmsg.color = color;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 580,
        "y": 620,
        "wires": [
            [
                "d5296d529184b3e2"
            ]
        ]
    },
    {
        "id": "d5296d529184b3e2",
        "type": "ui_template",
        "z": "e126b4dd60b37ea7",
        "group": "cd3dcd554c0939a7",
        "name": "",
        "order": 8,
        "width": 4,
        "height": 1,
        "format": "<div ng-style=\"{\n    'font-size': '20px',\n    'font-weight': 'bold',\n    'text-align': 'center',\n    'color': msg.color\n}\">\n    {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 790,
        "y": 620,
        "wires": [
            []
        ]
    },
    {
        "id": "b553d3d5020ec20f",
        "type": "mqtt in",
        "z": "710f5c82a7764540",
        "name": "",
        "topic": "ecg/device5/status",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 250,
        "y": 240,
        "wires": [
            [
                "2e940378f92e119d",
                "8cbb8960297cad5b"
            ]
        ]
    },
    {
        "id": "645540be6b971266",
        "type": "function",
        "z": "710f5c82a7764540",
        "name": "function 52",
        "func": "let ecg = msg.payload.ecg;\nlet sampleTs = msg.payload.sample_ts;\nlet startUtc = msg.payload.start_utc;\n\nif (ecg === undefined || sampleTs === undefined) return null;\n\n// Wenn start_utc enthalten ist, speichern\nif (startUtc !== undefined) {\n    global.set(\"ecg_start_utc\", startUtc);\n} else {\n    startUtc = global.get(\"ecg_start_utc\");\n    if (startUtc === undefined) return null; // noch keine gültige Zeitbasis\n}\n\n// UTC timestamp of this sample\nlet utcSample = startUtc + sampleTs / 1_000_000;\n\n// CSV line\nmsg.payload = utcSample.toFixed(6) + \",\" + ecg.toFixed(3) + \"\\n\";\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 570,
        "y": 60,
        "wires": [
            [
                "51decf22857f0eaa"
            ]
        ]
    },
    {
        "id": "51decf22857f0eaa",
        "type": "file",
        "z": "710f5c82a7764540",
        "name": "",
        "filename": "C:\\Users\\Dima\\Desktop\\ecg_recording_device_05_V2.csv",
        "filenameType": "str",
        "appendNewline": false,
        "createDir": false,
        "overwriteFile": "false",
        "encoding": "utf8",
        "x": 930,
        "y": 60,
        "wires": [
            []
        ]
    },
    {
        "id": "34294f062a068c7e",
        "type": "mqtt in",
        "z": "710f5c82a7764540",
        "name": "",
        "topic": "ecg/device5",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 230,
        "y": 160,
        "wires": [
            [
                "565c8c1b2784e34f",
                "645540be6b971266"
            ]
        ]
    },
    {
        "id": "565c8c1b2784e34f",
        "type": "function",
        "z": "710f5c82a7764540",
        "name": "device name",
        "func": "msg.payload = msg.payload.device;  // Extract the \"device\" value\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 570,
        "y": 120,
        "wires": [
            []
        ]
    },
    {
        "id": "8cbb8960297cad5b",
        "type": "function",
        "z": "710f5c82a7764540",
        "name": "battery",
        "func": "if (msg.payload && msg.payload.battery !== undefined) {\n    msg.payload = msg.payload.battery;\n    return msg;\n} else {\n    return null;\n}\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 550,
        "y": 240,
        "wires": [
            [
                "7123440dbdbdebf6"
            ]
        ]
    },
    {
        "id": "2e940378f92e119d",
        "type": "function",
        "z": "710f5c82a7764540",
        "name": "function 53",
        "func": "// Only run for status messages (not ECG samples)\nif (!msg.payload.hasOwnProperty(\"pads_connected\")) {\n    return null;\n}\n\nconst deviceId = msg.payload.device || \"ECG-10\";\nconst timeoutDuration = 30000 + 5000; // Status every 30s + small buffer\nconst timeoutKey = \"offline_timeout_\" + deviceId;\n\n// Cancel previous timeout\nconst prevTimeout = flow.get(timeoutKey);\nif (prevTimeout) {\n    clearTimeout(prevTimeout);\n}\n\n// Set new timeout → send Offline message if no new status received\nconst timeout = setTimeout(() => {\n    const offlineMsg = {\n        payload: \"Offline\",\n        color: \"gray\",\n        device: deviceId\n    };\n    node.send(offlineMsg);\n}, timeoutDuration);\nflow.set(timeoutKey, timeout);\n\n// Interpret pad connection status\nif (msg.payload.pads_connected === true) {\n    msg.payload = \"Connected\";\n    msg.color = \"#4f97dc\";\n} else if (msg.payload.pads_connected === false) {\n    msg.payload = \"Disconnected\";\n    msg.color = \"red\";\n} else {\n    msg.payload = \"Offline\";\n    msg.color = \"gray\";\n}\n\nmsg.device = deviceId;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 570,
        "y": 300,
        "wires": [
            [
                "aa064128c6d1d3ba"
            ]
        ]
    },
    {
        "id": "aa064128c6d1d3ba",
        "type": "ui_template",
        "z": "710f5c82a7764540",
        "group": "72fd7e32a8c27a97",
        "name": "",
        "order": 1,
        "width": 8,
        "height": 1,
        "format": "<div ng-style=\"{\n    'font-size': '20px',\n    'font-weight': 'bold',\n    'text-align': 'center',\n    'color': msg.color\n}\">\n    {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 800,
        "y": 300,
        "wires": [
            []
        ]
    },
    {
        "id": "7123440dbdbdebf6",
        "type": "ui_gauge",
        "z": "710f5c82a7764540",
        "name": "",
        "group": "72fd7e32a8c27a97",
        "order": 4,
        "width": 2,
        "height": 3,
        "gtype": "compass",
        "title": "Batterie (%)",
        "label": "%",
        "format": "{{msg.payload}}",
        "min": "0",
        "max": "100",
        "colors": [
            "#b50000",
            "#e6e600",
            "#00ff00"
        ],
        "seg1": "",
        "seg2": "",
        "diff": false,
        "className": "",
        "x": 810,
        "y": 240,
        "wires": []
    },
    {
        "id": "c7537797d380d563",
        "type": "inject",
        "z": "710f5c82a7764540",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "{   \"device\": \"ECG-10\",   \"msg_id\": 0,   \"pads_connected\": null,   \"seq\": 0,   \"ecg\": [],   \"ts\": [] }",
        "payloadType": "json",
        "x": 590,
        "y": 360,
        "wires": [
            [
                "2e940378f92e119d"
            ]
        ]
    },
    {
        "id": "5617297bf44b6cdb",
        "type": "mqtt in",
        "z": "710f5c82a7764540",
        "name": "",
        "topic": "processed/device5",
        "qos": "2",
        "datatype": "auto-detect",
        "broker": "6a8dd33d9e7fde80",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 250,
        "y": 520,
        "wires": [
            [
                "e1238d684b790e7a"
            ]
        ]
    },
    {
        "id": "740718bb584be88d",
        "type": "ui_text",
        "z": "710f5c82a7764540",
        "group": "72fd7e32a8c27a97",
        "order": 2,
        "width": 4,
        "height": 3,
        "name": "",
        "label": "BPM",
        "format": "{{msg.payload}}",
        "layout": "col-center",
        "className": "",
        "style": true,
        "font": "Georgia,Georgia,serif",
        "fontSize": "25",
        "color": "#1cb5ff",
        "x": 680,
        "y": 460,
        "wires": []
    },
    {
        "id": "e1238d684b790e7a",
        "type": "function",
        "z": "710f5c82a7764540",
        "name": "function 54",
        "func": "let data = msg.payload;\n\nif (typeof data === \"string\") {\n    try {\n        data = JSON.parse(data);\n    } catch (e) {\n        node.warn(\"Invalid JSON\");\n        return null;\n    }\n}\n\nmsg.bpm = { payload: data.bpm_mean };\nmsg.hrv = { payload: data.hrv_rmssd };\nmsg.zone = { payload: data.zone };\nmsg.quality = { payload: data.ecg_quality };\nmsg.rsp = { payload: data.ecg_rsp_mean };\n\nreturn [msg.bpm, msg.hrv, msg.zone, msg.quality, msg.rsp];\n",
        "outputs": 5,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 460,
        "y": 520,
        "wires": [
            [
                "ec512b2d9605d80a",
                "740718bb584be88d"
            ],
            [
                "8318db6890af2234"
            ],
            [
                "17a6b6534f007518"
            ],
            [
                "a93709e65d730edf"
            ],
            [
                "080f369325cdf7f0"
            ]
        ]
    },
    {
        "id": "ec512b2d9605d80a",
        "type": "ui_chart",
        "z": "710f5c82a7764540",
        "name": "",
        "group": "72fd7e32a8c27a97",
        "order": 5,
        "width": 8,
        "height": 3,
        "label": "Heart Rate BPM",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 710,
        "y": 420,
        "wires": [
            []
        ]
    },
    {
        "id": "8318db6890af2234",
        "type": "ui_chart",
        "z": "710f5c82a7764540",
        "name": "",
        "group": "72fd7e32a8c27a97",
        "order": 6,
        "width": 8,
        "height": 3,
        "label": "HRV (RMSSD)",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 710,
        "y": 500,
        "wires": [
            []
        ]
    },
    {
        "id": "17a6b6534f007518",
        "type": "ui_template",
        "z": "710f5c82a7764540",
        "group": "72fd7e32a8c27a97",
        "name": "tr zone",
        "order": 7,
        "width": 4,
        "height": 1,
        "format": "<div style=\"font-size: 20px; font-weight: bold;\">\n    Zone: {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 680,
        "y": 540,
        "wires": [
            []
        ]
    },
    {
        "id": "a93709e65d730edf",
        "type": "ui_gauge",
        "z": "710f5c82a7764540",
        "name": "",
        "group": "72fd7e32a8c27a97",
        "order": 3,
        "width": 2,
        "height": 3,
        "gtype": "compass",
        "title": "ECG Quality",
        "label": "units",
        "format": "{{value}}",
        "min": 0,
        "max": "1",
        "colors": [
            "#00b500",
            "#e6e600",
            "#ca3838"
        ],
        "seg1": "0.5",
        "seg2": "0.9",
        "diff": false,
        "className": "",
        "x": 700,
        "y": 580,
        "wires": []
    },
    {
        "id": "080f369325cdf7f0",
        "type": "function",
        "z": "710f5c82a7764540",
        "name": "function 55",
        "func": "let rsp = parseFloat(msg.payload); // VERY IMPORTANT: force it to number\n\nlet breathingStatus = \"Unknown\";\nlet color = \"grey\";\n\nif (rsp > -3 && rsp < 3) {\n    breathingStatus = \"Normal Breathing\";\n    color = \"#4f97dc\";\n} else {\n    breathingStatus = \"Irregular Breathing\";\n    color = \"red\";\n}\n\nmsg.payload = breathingStatus;\nmsg.color = color;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 700,
        "y": 620,
        "wires": [
            [
                "c053c9c57615fc36"
            ]
        ]
    },
    {
        "id": "c053c9c57615fc36",
        "type": "ui_template",
        "z": "710f5c82a7764540",
        "group": "72fd7e32a8c27a97",
        "name": "",
        "order": 8,
        "width": 4,
        "height": 1,
        "format": "<div ng-style=\"{\n    'font-size': '20px',\n    'font-weight': 'bold',\n    'text-align': 'center',\n    'color': msg.color\n}\">\n    {{msg.payload}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 910,
        "y": 620,
        "wires": [
            []
        ]
    },
    {
        "id": "318660e23d2f19a8",
        "type": "subflow:382713f15f103ffc",
        "z": "406168d7e2283e1c",
        "name": "",
        "x": 120,
        "y": 420,
        "wires": []
    },
    {
        "id": "136aaa6250122bd2",
        "type": "subflow:7bd2bc9737c4c53d",
        "z": "406168d7e2283e1c",
        "name": "",
        "x": 120,
        "y": 60,
        "wires": []
    },
    {
        "id": "9ce93bf705ab86cd",
        "type": "subflow:bdb2f7c1745d22d1",
        "z": "406168d7e2283e1c",
        "name": "",
        "x": 120,
        "y": 380,
        "wires": []
    },
    {
        "id": "d04ea706171fdeae",
        "type": "subflow:ca0982db8ee424ff",
        "z": "406168d7e2283e1c",
        "name": "",
        "x": 120,
        "y": 340,
        "wires": []
    },
    {
        "id": "3131cd6fd7264e5a",
        "type": "subflow:c6db48c0b253912f",
        "z": "406168d7e2283e1c",
        "name": "",
        "x": 120,
        "y": 300,
        "wires": []
    },
    {
        "id": "e9307342ccdd0805",
        "type": "subflow:6a1b1482a6bee560",
        "z": "406168d7e2283e1c",
        "name": "",
        "x": 120,
        "y": 260,
        "wires": []
    },
    {
        "id": "f7fedcfa1b83e21b",
        "type": "subflow:710f5c82a7764540",
        "z": "406168d7e2283e1c",
        "name": "",
        "x": 120,
        "y": 220,
        "wires": []
    },
    {
        "id": "38d7a32d170316a3",
        "type": "subflow:e126b4dd60b37ea7",
        "z": "406168d7e2283e1c",
        "name": "",
        "x": 120,
        "y": 180,
        "wires": []
    },
    {
        "id": "84af19665ff6f490",
        "type": "subflow:2c4d072efbeedd02",
        "z": "406168d7e2283e1c",
        "name": "",
        "x": 120,
        "y": 140,
        "wires": []
    },
    {
        "id": "f22d6cf43169d876",
        "type": "subflow:14ca00f39d79f827",
        "z": "406168d7e2283e1c",
        "name": "",
        "x": 120,
        "y": 100,
        "wires": []
    }
]